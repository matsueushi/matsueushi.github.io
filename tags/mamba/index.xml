<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Mamba on matsueushi</title>
    <link>https://matsueushi.github.io/tags/mamba/</link>
    <description>Recent content in Mamba on matsueushi</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>ja</language>
    <copyright>Copyright © 2019–2020</copyright>
    <lastBuildDate>Wed, 17 Apr 2019 21:44:20 -0400</lastBuildDate>
    
	<atom:link href="https://matsueushi.github.io/tags/mamba/index.xml" rel="self" type="application/rss+xml" />
    
    
    <item>
      <title>Juliaで体験するベイズ推論(7) - The Price Is Right</title>
      <link>https://matsueushi.github.io/posts/bayesian-methods-julia-7/</link>
      <pubDate>Wed, 17 Apr 2019 21:44:20 -0400</pubDate>
      
      <guid>https://matsueushi.github.io/posts/bayesian-methods-julia-7/</guid>
      <description>&lt;p&gt;引き続き「Pythonで体験するベイズ推論」のJulia+Mambaによる実装に挑戦している。わざわざ特別Mediumに書くような題材は無いな、と思っていたのだが、第5章の「例題 : テレビ番組 “The Price Is Right”の最適化」のモデリング( &lt;code&gt;pm.potential&lt;/code&gt; が出てくるところ)でちょっと詰まったので、Mambaでの実装について記しておく。&lt;/p&gt;
&lt;p&gt;問題を単純化すると、&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;二つの賞品A, Bの合計価格(これを真の価格と今後呼ぶ)を予想したい&lt;/li&gt;
&lt;li&gt;真の価格は正規分布 \( \text{Normal}(35000, 7500^2) \) に従うと仮定する&lt;/li&gt;
&lt;li&gt;賞品A, Bの価格の事前分布はそれぞれ正規分布 \( \text{Normal}(12000, 3000^2) \) , \( \text{Normal}(3000,500^2) \) に従うと仮定する
このような条件のモデリングである。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;実際にモデリングをやってみて、賞品A, Bの事前分布と、その和をモデリングするところまでは下のようにすればいいので簡単であるのだが、( &lt;code&gt;using&lt;/code&gt; 等は略した)真の価格の分布とサンプリングした賞品A, Bの価格の分布の和を結びつける段階で、はて？？？となった。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-julia&#34; data-lang=&#34;julia&#34;&gt;data &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;Dict&lt;/span&gt;{&lt;span style=&#34;color:#66d9ef&#34;&gt;Symbol&lt;/span&gt;, &lt;span style=&#34;color:#66d9ef&#34;&gt;Any&lt;/span&gt;}(
    &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;data_mu &lt;span style=&#34;color:#f92672&#34;&gt;=&amp;gt;&lt;/span&gt; [&lt;span style=&#34;color:#ae81ff&#34;&gt;3e3&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;12e3&lt;/span&gt;],
    &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;data_std &lt;span style=&#34;color:#f92672&#34;&gt;=&amp;gt;&lt;/span&gt; [&lt;span style=&#34;color:#ae81ff&#34;&gt;5e2&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;3e3&lt;/span&gt;],
    &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;mu_prior &lt;span style=&#34;color:#f92672&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;35e3&lt;/span&gt;,
    &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;std_prior &lt;span style=&#34;color:#f92672&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;75e2&lt;/span&gt;,
)

model &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Model(
    prize &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Stochastic(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;, (data_mu, data_std) 
        &lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt; MvNormal(data_mu, data_std)),
    price_estimate &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Logical(prize &lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt; sum(prize)),
)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;モデルを下のようにしてしまうと、&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-julia&#34; data-lang=&#34;julia&#34;&gt;model &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Model(
    true_price &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Stochastic((mu_prior, std_prior) &lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt; Normal(mu_prior, std_prior)),
    prize &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Stochastic(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;, (data_mu, data_std) &lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt; MvNormal(data_mu, data_std)),
    price_estimate &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Logical(prize &lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt; sum(prize)),
)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;code&gt;price_estimate&lt;/code&gt; と &lt;code&gt;true_price&lt;/code&gt; が結びつかないのである。&lt;/p&gt;
&lt;p&gt;本文のコードを見てみると、 &lt;code&gt;@pm.potential&lt;/code&gt; というデコレーターが付いた関数が使われている。(PyMC3では &lt;code&gt;pm.Potential&lt;/code&gt; )&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-julia&#34; data-lang=&#34;julia&#34;&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;@pm&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;potential
def error(true_price&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;true_price, price_estimate&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;price_estimate)&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;
    &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; pm&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;normal_like(true_price, price_estimate, &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt; (&lt;span style=&#34;color:#ae81ff&#34;&gt;3e3&lt;/span&gt;)&lt;span style=&#34;color:#f92672&#34;&gt;**&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;要は毎回真の価格の分布からサンプリングされている観測値 &lt;code&gt;true_price&lt;/code&gt; を \( \text{Normal}( \) &lt;code&gt;price_estimate&lt;/code&gt; \(, 3000^2) \) という分布に当てはめた時の尤度を制約条件として加えるということである。&lt;/p&gt;
&lt;p&gt;参考にした &lt;code&gt;pm.potential&lt;/code&gt; についてのStackExchangeの質問:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;What is pm.Potential in PyMC3?
&lt;a href=&#34;https://stats.stackexchange.com/questions/251280/what-is-pm-potential-in-pymc3&#34;&gt;https://stats.stackexchange.com/questions/251280/what-is-pm-potential-in-pymc3&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;\&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;pm.Potential() much needed explanation for newbie
&lt;a href=&#34;https://discourse.pymc.io/t/pm-potential-much-needed-explanation-for-newbie/2341&#34;&gt;https://discourse.pymc.io/t/pm-potential-much-needed-explanation-for-newbie/2341&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Mambaに &lt;code&gt;pm.potential&lt;/code&gt; に該当する機能が見つからなかったので、ユーザー定義の分布を定義することで制約条件を実装した。&lt;/p&gt;
&lt;p&gt;&lt;code&gt;true_price&lt;/code&gt; に対して計算される尤度が通常の \( \text{Normal}(\mu, \sigma^2) \) に対応する尤度と今回考えたい制約に対応する  \( \text{Normal}( \) &lt;code&gt;price_estimate&lt;/code&gt; \(, 3000^2) \) の尤度の話になるような分布にすれば良いので、&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-julia&#34; data-lang=&#34;julia&#34;&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;@everywhere&lt;/span&gt; extensions &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;quote&lt;/span&gt;
    &lt;span style=&#34;color:#66d9ef&#34;&gt;using&lt;/span&gt; Distributions
    &lt;span style=&#34;color:#66d9ef&#34;&gt;import&lt;/span&gt; Distributions&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; minimum, maximum, logpdf
    
    &lt;span style=&#34;color:#66d9ef&#34;&gt;mutable&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;struct&lt;/span&gt; TruePriceDist &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;:&lt;/span&gt; ContinuousUnivariateDistribution
        mu&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;Float64&lt;/span&gt;
        sig&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;Float64&lt;/span&gt;
        price_estimate&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;Float64&lt;/span&gt;
    &lt;span style=&#34;color:#66d9ef&#34;&gt;end&lt;/span&gt;
    
    minimum(d&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;TruePriceDist) &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;Inf
    maximum(d&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;TruePriceDist) &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Inf
    
    &lt;span style=&#34;color:#66d9ef&#34;&gt;function&lt;/span&gt; logpdf(d&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;TruePriceDist, x&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;Real&lt;/span&gt;)
       logpdf(Normal(d&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;mu, d&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;sig), x) &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; logpdf(Normal(d&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;price_estimate, &lt;span style=&#34;color:#ae81ff&#34;&gt;3000&lt;/span&gt;), x)
    &lt;span style=&#34;color:#66d9ef&#34;&gt;end&lt;/span&gt;
&lt;span style=&#34;color:#66d9ef&#34;&gt;end&lt;/span&gt;
&lt;span style=&#34;color:#a6e22e&#34;&gt;@everywhere&lt;/span&gt; eval(extensions)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;と新しく分布を定義する。こうすると &lt;code&gt;logpdf&lt;/code&gt; が正規化されていないものになる(pdfを積分して1にならない)がMambaで使う分布としては問題は起こらない。&lt;/p&gt;
&lt;p&gt;モデルはこの &lt;code&gt;TruePriceDist&lt;/code&gt; を使って、&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-julia&#34; data-lang=&#34;julia&#34;&gt;model &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Model(
    true_price &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Stochastic(
        (mu_prior, std_prior, price_estimate) &lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt; 
        TruePriceDist(mu_prior, std_prior, price_estimate)
        ),
    prize &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Stochastic(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;, (data_mu, data_std) &lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt; MvNormal(data_mu, data_std)),
    price_estimate &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Logical(prize &lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt; sum(prize)),
)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;とすれば良い。&lt;/p&gt;
&lt;p&gt;事後分布を確認すると、本と同様の結果がきちんと得られていた。&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://matsueushi.github.io/images/posts/bayesian-methods-julia-7.png&#34; alt=&#34;事後分布&#34;&gt;&lt;/p&gt;
&lt;p&gt;サンプリングの詳細、期待損失の計算や最小化に関しては下のipynb参照。&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://nbviewer.jupyter.org/github/matsueushi/bayesian_methods_julia/blob/master/chapter5_thepriceisright.ipynb&#34;&gt;https://nbviewer.jupyter.org/github/matsueushi/bayesian_methods_julia/blob/master/chapter5_thepriceisright.ipynb&lt;/a&gt;&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Juliaで体験するベイズ推論(6) -スペースシャトル「チャレンジャー号」の悲劇</title>
      <link>https://matsueushi.github.io/posts/bayesian-methods-julia-6/</link>
      <pubDate>Wed, 10 Apr 2019 00:24:53 -0400</pubDate>
      
      <guid>https://matsueushi.github.io/posts/bayesian-methods-julia-6/</guid>
      <description>&lt;p&gt;最近はGaussianRandomWalkを使った時系列ベイズモデルの推定に挑戦していたが、あまりうまくいかなかったので一旦「Pythonで体験するベイズ推論」に戻ろうと思う。&lt;/p&gt;
&lt;p&gt;今回は「Pythonで体験するベイズ推論」の「2.2.27 例題 カンニングした学生の割合」をJuliaで実装した内容を紹介する。&lt;/p&gt;
&lt;p&gt;まずはライブラリのインポート&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-julia&#34; data-lang=&#34;julia&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;using&lt;/span&gt; Distributed

addprocs(&lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;)
&lt;span style=&#34;color:#66d9ef&#34;&gt;using&lt;/span&gt; CSV
&lt;span style=&#34;color:#66d9ef&#34;&gt;using&lt;/span&gt; DataFrames
&lt;span style=&#34;color:#66d9ef&#34;&gt;using&lt;/span&gt; HTTP
&lt;span style=&#34;color:#66d9ef&#34;&gt;using&lt;/span&gt; LaTeXStrings
&lt;span style=&#34;color:#66d9ef&#34;&gt;using&lt;/span&gt; LinearAlgebra
&lt;span style=&#34;color:#a6e22e&#34;&gt;@everywhere&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;using&lt;/span&gt; Mamba
&lt;span style=&#34;color:#66d9ef&#34;&gt;using&lt;/span&gt; Plots
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;データの加工はこのような形で行った。&lt;code&gt;DataFrame&lt;/code&gt; で &lt;code&gt;Int64&lt;/code&gt; にパースしたい行にMissing valueやNaNがあるとき、&lt;code&gt;convert&lt;/code&gt;ではエラーになるので、
パースできない場合は &lt;code&gt;missing&lt;/code&gt; になる &lt;code&gt;tryparse&lt;/code&gt; を使って、その後 &lt;code&gt;nothing&lt;/code&gt; になる行を削除して、&lt;code&gt;Union{Nothing, Int64}&lt;/code&gt; から &lt;code&gt;Int64&lt;/code&gt; にもう一度変換している。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-julia&#34; data-lang=&#34;julia&#34;&gt;r &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; HTTP&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;request(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;GET&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;https://git.io/vXknD&amp;#34;&lt;/span&gt;);

challengers_data &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; CSV&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;read(&lt;span style=&#34;color:#66d9ef&#34;&gt;IOBuffer&lt;/span&gt;(r&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;body))
names!(challengers_data, [&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;date, &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;temperature, &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;incident])
&lt;span style=&#34;color:#75715e&#34;&gt;# incidentのパース&lt;/span&gt;
challengers_data[&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;incident] &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; tryparse&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;(&lt;span style=&#34;color:#66d9ef&#34;&gt;Int64&lt;/span&gt;, challengers_data[&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;incident])
&lt;span style=&#34;color:#75715e&#34;&gt;# NaNを削除&lt;/span&gt;
challengers_data &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; challengers_data[challengers_data[&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;incident] &lt;span style=&#34;color:#f92672&#34;&gt;.!=&lt;/span&gt; nothing, &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;]
challengers_data[&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;incident] &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; convert&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;(&lt;span style=&#34;color:#66d9ef&#34;&gt;Int64&lt;/span&gt;, challengers_data[&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;incident])
disallowmissing!(challengers_data)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;データの図示をする。&lt;code&gt;weighted_color_mean&lt;/code&gt; を使って、マーカーの色を青から赤にグラデーションさせた。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-julia&#34; data-lang=&#34;julia&#34;&gt;temperature &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; challengers_data[&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;temperature]
color_weight &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; (temperature &lt;span style=&#34;color:#f92672&#34;&gt;.-&lt;/span&gt; minimum(temperature)) &lt;span style=&#34;color:#f92672&#34;&gt;./&lt;/span&gt; (maximum(temperature) &lt;span style=&#34;color:#f92672&#34;&gt;.-&lt;/span&gt; minimum(temperature))
wcolor &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; weighted_color_mean&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;(color_weight, colorant&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;red&amp;#34;&lt;/span&gt;, colorant&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;blue&amp;#34;&lt;/span&gt;)
scatter(challengers_data&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;temperature, challengers_data&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;incident, 
        markercolor &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; wcolor, 
        xlabel &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Temprature (F)&amp;#34;&lt;/span&gt;, ylabel &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;O-ring failure&amp;#34;&lt;/span&gt;, label &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&amp;#34;&lt;/span&gt;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;img src=&#34;https://matsueushi.github.io/images/posts/bayesian-methods-julia-6_data.png&#34; alt=&#34;Oリングと破損の関係&#34;&gt;&lt;/p&gt;
&lt;p&gt;破損発生の有無を表す確率変数 \( D_i \) は、ベルヌーイ分布とロジスティック関数を用いて&lt;/p&gt;
&lt;p&gt;\(
\begin{aligned}
D_i &amp;amp;\sim \text{Bernoulli}(p(t_i)), \\
p(t) &amp;amp;= \frac{1}{1 +\exp(\beta t + \alpha)},
\end{aligned}
\)&lt;/p&gt;
&lt;p&gt;\( t \) : 温度
とモデリングされる。今回は、あとでサンプルされた &lt;code&gt;p&lt;/code&gt; の値を使ってデータのシミュレーションを行うために、下のように &lt;code&gt;p&lt;/code&gt; に &lt;code&gt;Logical&lt;/code&gt; ノードを割り当てたが、&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-julia&#34; data-lang=&#34;julia&#34;&gt;model &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Model(
    
    observed &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Stochastic(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;,
        p &lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt; UnivariateDistribution[Bernoulli(x) &lt;span style=&#34;color:#66d9ef&#34;&gt;for&lt;/span&gt; x &lt;span style=&#34;color:#66d9ef&#34;&gt;in&lt;/span&gt; p],
        &lt;span style=&#34;color:#66d9ef&#34;&gt;false&lt;/span&gt;
    ),
    
    p &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Logical(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;,
        (alpha, beta, temperature) 
            &lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt; &lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;@&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;1.0&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt; (&lt;span style=&#34;color:#ae81ff&#34;&gt;1.0&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; exp(beta &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; temperature &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; alpha)))
    ),
    
    alpha &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Stochastic(() &lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt; Normal(&lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;, sqrt(&lt;span style=&#34;color:#ae81ff&#34;&gt;1000&lt;/span&gt;))),
    beta &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Stochastic(() &lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt; Normal(&lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;, sqrt(&lt;span style=&#34;color:#ae81ff&#34;&gt;1000&lt;/span&gt;))),
)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;observedのモデリングだけであればpを経由せずに直接モデリングすることもできる。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-julia&#34; data-lang=&#34;julia&#34;&gt;model &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Model(
    
    observed &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Stochastic(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;,
        (alpha, beta, temperature) &lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt; 
            UnivariateDistribution[
                Bernoulli(&lt;span style=&#34;color:#ae81ff&#34;&gt;1.0&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt; (&lt;span style=&#34;color:#ae81ff&#34;&gt;1.0&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; exp(beta &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; x &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; alpha)))
            &lt;span style=&#34;color:#66d9ef&#34;&gt;for&lt;/span&gt; x &lt;span style=&#34;color:#66d9ef&#34;&gt;in&lt;/span&gt; temperature],
        &lt;span style=&#34;color:#66d9ef&#34;&gt;false&lt;/span&gt;
    ),
    
    alpha &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Stochastic(() &lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt; Normal(&lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;, sqrt(&lt;span style=&#34;color:#ae81ff&#34;&gt;1000&lt;/span&gt;))),
    beta &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Stochastic(() &lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt; Normal(&lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;, sqrt(&lt;span style=&#34;color:#ae81ff&#34;&gt;1000&lt;/span&gt;))),

)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;モデルパラメータ &lt;code&gt;alpha&lt;/code&gt;, &lt;code&gt;beta&lt;/code&gt; の事後分布は次のようになった。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-julia&#34; data-lang=&#34;julia&#34;&gt;data &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;Dict&lt;/span&gt;{&lt;span style=&#34;color:#66d9ef&#34;&gt;Symbol&lt;/span&gt;, &lt;span style=&#34;color:#66d9ef&#34;&gt;Any&lt;/span&gt;}(
    &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;observed &lt;span style=&#34;color:#f92672&#34;&gt;=&amp;gt;&lt;/span&gt; challengers_data[&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;incident],
    &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;temperature &lt;span style=&#34;color:#f92672&#34;&gt;=&amp;gt;&lt;/span&gt; challengers_data[&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;temperature],
)
inits &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; [
    &lt;span style=&#34;color:#66d9ef&#34;&gt;Dict&lt;/span&gt;{&lt;span style=&#34;color:#66d9ef&#34;&gt;Symbol&lt;/span&gt;, &lt;span style=&#34;color:#66d9ef&#34;&gt;Any&lt;/span&gt;}(
        &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;observed &lt;span style=&#34;color:#f92672&#34;&gt;=&amp;gt;&lt;/span&gt; challengers_data[&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;incident],
        &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;alpha &lt;span style=&#34;color:#f92672&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;,
        &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;beta &lt;span style=&#34;color:#f92672&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;,
    ) &lt;span style=&#34;color:#66d9ef&#34;&gt;for&lt;/span&gt; _ &lt;span style=&#34;color:#66d9ef&#34;&gt;in&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;
]
scheme &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; [AMWG([&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;alpha, &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;beta], &lt;span style=&#34;color:#ae81ff&#34;&gt;0.1&lt;/span&gt;)]
setsamplers!(model, scheme)
sim &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; mcmc(model, data, inits, &lt;span style=&#34;color:#ae81ff&#34;&gt;200000&lt;/span&gt;, burnin &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;50000&lt;/span&gt;, thin &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;50&lt;/span&gt;, chains &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;)
p &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Mamba&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;plot(sim[&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;, [&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;alpha, &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;beta], &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;], legend &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;true&lt;/span&gt;)
Mamba&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;draw(p, nrow &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;, ncol &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;img src=&#34;https://matsueushi.github.io/images/posts/bayesian-methods-julia-6_density.png&#34; alt=&#34;Value, Density&#34;&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-julia&#34; data-lang=&#34;julia&#34;&gt;p &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Mamba&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;plot(sim[&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;, [&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;alpha, &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;beta], &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;], [&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;autocor, &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;mean], legend&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;true&lt;/span&gt;)
Mamba&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;draw(p, nrow &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;, ncol &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;img src=&#34;https://matsueushi.github.io/images/posts/bayesian-methods-julia-6_mean.png&#34; alt=&#34;Autocorrelation, Mean&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;alpha&lt;/code&gt; に対して &lt;code&gt;beta&lt;/code&gt; をプロットすると、次のような原点を通る直線上のグラフになる。\( p(t) = 0.5 \) となるのが \( t = -\alpha / \beta \) となるので、故障するかしないか半々となる温度はシミュレーションで大きく変化しないことがわかる。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-julia&#34; data-lang=&#34;julia&#34;&gt;alpha_samples &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; sim[&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;, [&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;alpha], &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;]&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;value[&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;]
beta_samples &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; sim[&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;, [&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;beta], &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;]&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;value[&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;]
scatter(alpha_samples, beta_samples, label &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&amp;#34;&lt;/span&gt;, markersize &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;img src=&#34;https://matsueushi.github.io/images/posts/bayesian-methods-julia-6_ab.png&#34; alt=&#34;Relation between alpha and beta&#34;&gt;&lt;/p&gt;
&lt;p&gt;破損確率の事後期待値と、サンプルから選んでプロットする。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-julia&#34; data-lang=&#34;julia&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;function&lt;/span&gt; logistic(x, alpha, beta)
    &lt;span style=&#34;color:#ae81ff&#34;&gt;1.0&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;./&lt;/span&gt; (&lt;span style=&#34;color:#ae81ff&#34;&gt;1.0&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;.+&lt;/span&gt; exp&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;(beta &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; x &lt;span style=&#34;color:#f92672&#34;&gt;.+&lt;/span&gt; alpha))
&lt;span style=&#34;color:#66d9ef&#34;&gt;end&lt;/span&gt;

xs &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; collect((minimum(temperature) &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;5&lt;/span&gt;)&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;0.1&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;(maximum(temperature) &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;5&lt;/span&gt;))
p_t &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; logistic(transpose(xs), alpha_samples, beta_samples)

Plots&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;plot(xs, vec(mean(p_t, dims&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;)), linewidth &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;, label &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Average posterior probability&amp;#34;&lt;/span&gt;)
Plots&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;plot!(xs, p_t[&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;, &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;], linewidth &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;, linestyle &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;dash, label &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Realization from posterior&amp;#34;&lt;/span&gt;)
Plots&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;plot!(xs, p_t[&lt;span style=&#34;color:#66d9ef&#34;&gt;end&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;, &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;], linewidth &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;, linestyle &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;dash, label &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Realization from posterior&amp;#34;&lt;/span&gt;)
scatter!(challengers_data&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;temperature, challengers_data&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;incident, 
        markercolor &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; weighted_color_mean&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;(color_weight, colorant&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;blue&amp;#34;&lt;/span&gt;, colorant&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;red&amp;#34;&lt;/span&gt;), 
        xlabel &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Temprature (F)&amp;#34;&lt;/span&gt;, ylabel &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;O-ring failure&amp;#34;&lt;/span&gt;, label &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&amp;#34;&lt;/span&gt;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;img src=&#34;https://matsueushi.github.io/images/posts/bayesian-methods-julia-6_realization.png&#34; alt=&#34;Realization&#34;&gt;&lt;/p&gt;
&lt;p&gt;破損確率の事後期待値と、95%信頼区間をプロットする&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-julia&#34; data-lang=&#34;julia&#34;&gt;p_t_ci &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; mapslices(x &lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt; quantile(x, [&lt;span style=&#34;color:#ae81ff&#34;&gt;0.025&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;0.975&lt;/span&gt;]), p_t, dims &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;)

Plots&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;plot(xs, p_t_ci[&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;, &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;], linewidth &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;, 
    fillrange &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; p_t_ci[&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;, &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;], fillalpha &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0.4&lt;/span&gt;,
    label &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;95% Confidence interval&amp;#34;&lt;/span&gt;)
Plots&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;plot!(xs, vec(mean(p_t, dims&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;)), linewidth &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;, label &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Average posterior probability&amp;#34;&lt;/span&gt;)
scatter!(challengers_data&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;temperature, challengers_data&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;incident, 
        markercolor &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; weighted_color_mean&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;(color_weight, colorant&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;blue&amp;#34;&lt;/span&gt;, colorant&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;red&amp;#34;&lt;/span&gt;), 
        xlabel &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Temprature (F)&amp;#34;&lt;/span&gt;, ylabel &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;O-ring failure&amp;#34;&lt;/span&gt;, label &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&amp;#34;&lt;/span&gt;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;img src=&#34;https://matsueushi.github.io/images/posts/bayesian-methods-julia-6_ci.png&#34; alt=&#34;Confidence interval&#34;&gt;&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Mamba.jlでGaussianRandomWalkを作って使う</title>
      <link>https://matsueushi.github.io/posts/mamba-gaussianrandomwalk/</link>
      <pubDate>Wed, 03 Apr 2019 21:52:38 -0400</pubDate>
      
      <guid>https://matsueushi.github.io/posts/mamba-gaussianrandomwalk/</guid>
      <description>&lt;p&gt;PyMC3にはTimeseriesとして &lt;code&gt;GaussianRandomWalk&lt;/code&gt; などの時系列モデルが実装されている。&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://docs.pymc.io/api/distributions/timeseries.html#pymc3.distributions.timeseries.GaussianRandomWalk&#34;&gt;https://docs.pymc.io/api/distributions/timeseries.html#pymc3.distributions.timeseries.GaussianRandomWalk&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;だが残念なことに私が使っているMamba.jl(0.12.1)には時系列モデルがない。下のように &lt;code&gt;cumsum&lt;/code&gt; を使ってモデルを作成することは可能ではあるが、面倒だし次元が大きくなってきたりモデルが複雑になってくると遅い。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-julia&#34; data-lang=&#34;julia&#34;&gt;local_level_model &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Model(
    
    obs &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Stochastic(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;,
        (N, T, sigma_I) &lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt; MvNormal(T, sigma_I),
        &lt;span style=&#34;color:#66d9ef&#34;&gt;false&lt;/span&gt;
    ),
    
    T &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Logical(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;,
        (T_0, disturbance) &lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt; T_0 &lt;span style=&#34;color:#f92672&#34;&gt;.+&lt;/span&gt; vcat([&lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;], cumsum(disturbance)),
    ),
    
    disturbance &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Stochastic(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;,
        (N, sigma_T) &lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt; MvNormal(N &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;, sigma_T),
        &lt;span style=&#34;color:#66d9ef&#34;&gt;false&lt;/span&gt;
    ),
    
    sigma_I &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Stochastic(() &lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt; InverseGamma()),
    sigma_T &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Stochastic(() &lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt; InverseGamma()),
    
    T_0 &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Stochastic(T_init &lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt; Normal(T_init, &lt;span style=&#34;color:#ae81ff&#34;&gt;100&lt;/span&gt;)),
)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;だからと言ってそのためにわざわざPython+PyMC3に移るのも癪だし、練習を兼ねてJulia+Mamba用の確率分布を試しに作ってみようと思ったのが今回の内容である。幸いなことに、Mamba.jlには作り方のガイドラインが書いてあるので、&lt;a href=&#34;https://mambajl.readthedocs.io/en/latest/mcmc/distributions.html#user-defined-multivariate-distributions&#34;&gt;多変量分布用のガイドライン&lt;/a&gt;を参考にして作ることができた。&lt;/p&gt;
&lt;p&gt;今回は、&lt;code&gt;GaussianRandomWalk&lt;/code&gt; は、初期値の分布 \( D \) とドリフト \( \mu_i \) , 分散 \( \sigma \) とした時に、&lt;/p&gt;
&lt;p&gt;\(
\begin{aligned}
Y_0 &amp;amp;= D,  \\
Y_{i+1} &amp;amp;= Y_i + \mu_i + \epsilon_i, \\
\epsilon_i &amp;amp;\sim \text{Normal}(0, \sigma)
\end{aligned}
\)&lt;/p&gt;
&lt;p&gt;というモデルに従っているとする。&lt;/p&gt;
&lt;p&gt;Mamba.jlでUser-Definedの多変量分布を使うためには, Distributionの全ての関数を定義する必要はなく、
次元 &lt;code&gt;length&lt;/code&gt;, 分布のサポート &lt;code&gt;insupport&lt;/code&gt;, 確率密度関数の対数 &lt;code&gt;_logpdf&lt;/code&gt; だけ定義すればサンプリングができる。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-julia&#34; data-lang=&#34;julia&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;using&lt;/span&gt; Distributed

&lt;span style=&#34;color:#a6e22e&#34;&gt;@everywhere&lt;/span&gt; extensions &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;quote&lt;/span&gt;

    &lt;span style=&#34;color:#66d9ef&#34;&gt;using&lt;/span&gt; Distributions
    &lt;span style=&#34;color:#66d9ef&#34;&gt;import&lt;/span&gt; Distributions&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; length, insupport, _logpdf

    &lt;span style=&#34;color:#66d9ef&#34;&gt;mutable&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;struct&lt;/span&gt; GaussianRandomWalk &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;:&lt;/span&gt; ContinuousMultivariateDistribution
        mu&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;Vector&lt;/span&gt;{&lt;span style=&#34;color:#66d9ef&#34;&gt;Float64&lt;/span&gt;}
        sig&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;Float64&lt;/span&gt;
        init&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;ContinuousUnivariateDistribution
    &lt;span style=&#34;color:#66d9ef&#34;&gt;end&lt;/span&gt;

    length(d&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;GaussianRandomWalk) &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; length(d&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;mu) &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;

    &lt;span style=&#34;color:#66d9ef&#34;&gt;function&lt;/span&gt; insupport(d&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;GaussianRandomWalk, x&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;AbstractVector&lt;/span&gt;{T}) where {T&lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;:&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;Real&lt;/span&gt;}
        length(d) &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; length(x) &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; all(isfinite&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;(x))
    &lt;span style=&#34;color:#66d9ef&#34;&gt;end&lt;/span&gt;

    &lt;span style=&#34;color:#66d9ef&#34;&gt;function&lt;/span&gt; _logpdf(d&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;GaussianRandomWalk, x&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;AbstractVector&lt;/span&gt;{T}) where {T&lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;:&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;Real&lt;/span&gt;}
        randomwalk_like &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; logpdf&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;(Normal&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;(d&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;mu &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; x[&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;end&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;], d&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;sig), x[&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;end&lt;/span&gt;])
        logpdf(d&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;init, x[&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;]) &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; sum(randomwalk_like)
    &lt;span style=&#34;color:#66d9ef&#34;&gt;end&lt;/span&gt;

&lt;span style=&#34;color:#66d9ef&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;code&gt;length&lt;/code&gt; を定義するときは、ドリフト項の数が次元より一つ小さくなることに注意。&lt;/p&gt;
&lt;p&gt;\( D \) の確率密度関数を \( f_D \), \( \text{Normal}(\mu, \sigma) \)の確率密度関数を \( f_{\mu, \sigma} \) とすると、
多変量分布 \( (Y_0, …, Y_n) \) の確率密度関数 \( f \) が&lt;/p&gt;
&lt;p&gt;\(
f(x_0, \ldots, x_n) = f_D(x_0)\cdot f_{x_0+\mu_0, \sigma}(x_1)\cdots f_{x_{n-1}+\mu_{n-1}, \sigma}(x_n)
\)&lt;/p&gt;
&lt;p&gt;となるので &lt;code&gt;_logpdf&lt;/code&gt; は上のような定義になっている。(本当はここの理由もちゃんと詰めて書いた方が良い気がする)&lt;/p&gt;
&lt;p&gt; &lt;code&gt;quote&lt;/code&gt; の意味が最初わからなかったが、これで &lt;code&gt;quote&lt;/code&gt; から &lt;code&gt;end&lt;/code&gt; までのコード全体をオブジェクトとして &lt;code&gt;extensions&lt;/code&gt; に代入して、下のように空のモジュールを作成して、&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-julia&#34; data-lang=&#34;julia&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;module&lt;/span&gt; Testing &lt;span style=&#34;color:#66d9ef&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;下を実行すると&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-julia&#34; data-lang=&#34;julia&#34;&gt;Core&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;eval(Testing, extensions)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt; &lt;code&gt;Testing&lt;/code&gt; モジュール内で &lt;code&gt;quote&lt;/code&gt; した &lt;code&gt;extension&lt;/code&gt; の内容が読み込まれるということのようだ。&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://docs.julialang.org/en/v1/manual/metaprogramming/index.html#Metaprogramming-1&#34;&gt;https://docs.julialang.org/en/v1/manual/metaprogramming/index.html#Metaprogramming-1&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;新しく作成した分布を用いてMambaのモデルを作成し、サンプリングをしてみよう。
簡単のためにドリフトは無視して、分散 \( \sqrt{100} \) の正規分布の列からなる100次元の &lt;code&gt;GaussianRandomWalk&lt;/code&gt; のサンプルを作成し、モデルを作成して分散を推定してみる。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-julia&#34; data-lang=&#34;julia&#34;&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;@everywhere&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;using&lt;/span&gt; Mamba
&lt;span style=&#34;color:#a6e22e&#34;&gt;@everywhere&lt;/span&gt; eval(extensions)

model &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Model(

y &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Stochastic(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;,
    sig &lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt; GaussianRandomWalk(zeros(&lt;span style=&#34;color:#ae81ff&#34;&gt;99&lt;/span&gt;), sqrt(sig), Normal(&lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;, sqrt(sig))),
        &lt;span style=&#34;color:#66d9ef&#34;&gt;false&lt;/span&gt;
    ),
    sig &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Stochastic(
        () &lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt; InverseGamma(&lt;span style=&#34;color:#ae81ff&#34;&gt;0.001&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;0.001&lt;/span&gt;)
    ),
)

scheme &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; [AMWG(&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;sig, &lt;span style=&#34;color:#ae81ff&#34;&gt;10.0&lt;/span&gt;)]
setsamplers!(model, scheme)

data &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;Dict&lt;/span&gt;(
    &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;y &lt;span style=&#34;color:#f92672&#34;&gt;=&amp;gt;&lt;/span&gt; cumsum(rand(MvNormal(&lt;span style=&#34;color:#ae81ff&#34;&gt;100&lt;/span&gt;, sqrt(&lt;span style=&#34;color:#ae81ff&#34;&gt;100&lt;/span&gt;))))
)

inits &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; [
    &lt;span style=&#34;color:#66d9ef&#34;&gt;Dict&lt;/span&gt;(
        &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;y &lt;span style=&#34;color:#f92672&#34;&gt;=&amp;gt;&lt;/span&gt; data[&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;y],
        &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;sig &lt;span style=&#34;color:#f92672&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;,
    )
    &lt;span style=&#34;color:#66d9ef&#34;&gt;for&lt;/span&gt; _ &lt;span style=&#34;color:#66d9ef&#34;&gt;in&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;
]

sim &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; mcmc(model, data, inits, &lt;span style=&#34;color:#ae81ff&#34;&gt;21000&lt;/span&gt;, burnin&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1000&lt;/span&gt;, thin&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;4&lt;/span&gt;, chains&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;)
describe(sim)

println(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Actual variance: &amp;#34;&lt;/span&gt;, var(diff(data[&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;y])))

p &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Mamba&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;plot(sim, legend &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;true&lt;/span&gt;)
Mamba&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;draw(p, nrow &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;, ncol &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;結果-&amp;gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;MCMC Simulation of &lt;span style=&#34;color:#ae81ff&#34;&gt;21000&lt;/span&gt; Iterations x &lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt; Chains...
Chain 1:   0% &lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;1:17:22 of 1:17:24 remaining&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;
Chain 1:  10% &lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;0:00:24 of 0:00:27 remaining&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;
Chain 1:  20% &lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;0:00:11 of 0:00:14 remaining&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;
Chain 1:  30% &lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;0:00:07 of 0:00:09 remaining&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;
Chain 1:  40% &lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;0:00:04 of 0:00:07 remaining&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;
Chain 1:  50% &lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;0:00:03 of 0:00:06 remaining&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;
Chain 1:  60% &lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;0:00:02 of 0:00:05 remaining&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;
Chain 1:  70% &lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;0:00:01 of 0:00:05 remaining&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;
Chain 1:  80% &lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;0:00:01 of 0:00:04 remaining&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;
Chain 1:  90% &lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;0:00:00 of 0:00:04 remaining&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;
Chain 1: 100% &lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;0:00:00 of 0:00:04 remaining&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;
Chain 2:   0% &lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;0:00:01 of 0:00:01 remaining&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;
Chain 2:  10% &lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;0:00:01 of 0:00:01 remaining&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;
Chain 2:  20% &lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;0:00:01 of 0:00:01 remaining&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;
Chain 2:  30% &lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;0:00:01 of 0:00:01 remaining&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;
Chain 2:  40% &lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;0:00:01 of 0:00:01 remaining&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;
Chain 2:  50% &lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;0:00:00 of 0:00:01 remaining&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;
Chain 2:  60% &lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;0:00:00 of 0:00:01 remaining&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;
Chain 2:  70% &lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;0:00:00 of 0:00:01 remaining&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;
Chain 2:  80% &lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;0:00:00 of 0:00:01 remaining&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;
Chain 2:  90% &lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;0:00:00 of 0:00:01 remaining&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;
Chain 2: 100% &lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;0:00:00 of 0:00:01 remaining&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;
Chain 3:   0% &lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;0:00:01 of 0:00:01 remaining&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;
Chain 3:  10% &lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;0:00:01 of 0:00:01 remaining&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;
Chain 3:  20% &lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;0:00:01 of 0:00:01 remaining&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;
Chain 3:  30% &lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;0:00:01 of 0:00:01 remaining&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;
Chain 3:  40% &lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;0:00:01 of 0:00:01 remaining&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;
Chain 3:  50% &lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;0:00:01 of 0:00:01 remaining&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;
Chain 3:  60% &lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;0:00:00 of 0:00:01 remaining&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;
Chain 3:  70% &lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;0:00:00 of 0:00:01 remaining&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;
Chain 3:  80% &lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;0:00:00 of 0:00:01 remaining&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;
Chain 3:  90% &lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;0:00:00 of 0:00:01 remaining&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;
Chain 3: 100% &lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;0:00:00 of 0:00:01 remaining&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;
Iterations &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; 1004:21000
Thinning interval &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;4&lt;/span&gt;
Chains &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; 1,2,3
Samples per chain &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;5000&lt;/span&gt;
Empirical Posterior Estimates:
      Mean       SD      Naive SE     MCSE       ESS  
sig 91.87928 13.629016 0.111280453 0.21081987 4179.323
Quantiles:
       2.5%     25.0%     50.0%    75.0%     97.5%  
sig 69.039156 82.188388 90.31312 100.2171 122.073783
Actual variance: 92.0192593899444
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;img src=&#34;https://matsueushi.github.io/images/posts/mamba-gaussianrandomwalk.png&#34; alt=&#34;事後分布&#34;&gt;&lt;/p&gt;
&lt;p&gt;標本分散が92だから正しく推定できているのではないだろうか。&lt;/p&gt;
&lt;p&gt;次は、確認を兼ねて、作った &lt;code&gt;GaussianRandomWalk&lt;/code&gt; を使って時系列モデルの構築に挑戦したい。&lt;/p&gt;
&lt;p&gt;全部のコード:&lt;/p&gt;
&lt;script src=&#34;https://gist.github.com/matsueushi/58d78e222db8189594825aa294e390f5.js&#34;&gt;&lt;/script&gt;</description>
    </item>
    
    <item>
      <title>Mamba.jl v0.12.0のStackOverflowError:</title>
      <link>https://matsueushi.github.io/posts/mamba-v-0-12-0/</link>
      <pubDate>Sun, 31 Mar 2019 21:47:30 -0400</pubDate>
      
      <guid>https://matsueushi.github.io/posts/mamba-v-0-12-0/</guid>
      <description>&lt;p&gt;GCPに環境を作っていて気づいたのだが、Distibution.jlのv0.17.0と関数が干渉していて &lt;code&gt;using Mamba&lt;/code&gt; すると下のようなワーニングが出て、&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;WARNING: Method definition &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;::Type&lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;Distributions.DiscreteNonParametric&lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;Int64, P, Base.OneTo&lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;Int64&lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;, Ps&lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt; where Ps where P&lt;span style=&#34;color:#f92672&#34;&gt;})(&lt;/span&gt;AbstractArray&lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;T&amp;lt;:Real, 1&lt;span style=&#34;color:#f92672&#34;&gt;})&lt;/span&gt; where &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;T&amp;lt;:Real&lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt; in module Distributions at /Users/apple/.julia/packages/Distributions/fMt8c/src/univariate/discrete/categorical.jl:40 overwritten in module Mamba at /Users/apple/.julia/packages/Mamba/qNBKz/src/distributions/constructors.jl:7.
WARNING: Method definition &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;::Type&lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;Distributions.MvNormal&lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;T, Cov, Mean&lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt; where Mean&amp;lt;:&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;AbstractArray&lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;T, 1&lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt; where T&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; where Cov&amp;lt;:&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;PDMats.AbstractPDMat&lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;T&lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt; where T&amp;lt;:Real&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; where T&amp;lt;:Real&lt;span style=&#34;color:#f92672&#34;&gt;})(&lt;/span&gt;AbstractArray&lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;T&amp;lt;:Real, 1&lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;, Real&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; where &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;T&amp;lt;:Real&lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt; in module Distributions at /Users/apple/.julia/packages/Distributions/fMt8c/src/multivariate/mvnormal.jl:200 overwritten in module Mamba at /Users/apple/.julia/packages/Mamba/qNBKz/src/distributions/constructors.jl:35.
WARNING: Method definition &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;::Type&lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;Distributions.MvNormalCanon&lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;T, P, V&lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt; where V&amp;lt;:&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;AbstractArray&lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;T, 1&lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt; where T&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; where P&amp;lt;:&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;PDMats.AbstractPDMat&lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;T&lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt; where T&amp;lt;:Real&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; where T&amp;lt;:Real&lt;span style=&#34;color:#f92672&#34;&gt;})(&lt;/span&gt;AbstractArray&lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;T&amp;lt;:Real, 1&lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;, U&amp;lt;:Real&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; where &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;T&amp;lt;:Real, U&amp;lt;:Real&lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt; in module Distributions at /Users/apple/.julia/packages/Distributions/fMt8c/src/multivariate/mvnormalcanon.jl:116 overwritten in module Mamba at /Users/apple/.julia/packages/Mamba/qNBKz/src/distributions/constructors.jl:53.
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;以前動いていた次のようなコードが動かない。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-julia&#34; data-lang=&#34;julia&#34;&gt;MvNormal(zeros(&lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;), &lt;span style=&#34;color:#ae81ff&#34;&gt;4&lt;/span&gt;)
&lt;span style=&#34;color:#66d9ef&#34;&gt;StackOverflowError&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;

Stacktrace&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;
 [&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;] MvNormal(&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;Array&lt;/span&gt;{&lt;span style=&#34;color:#66d9ef&#34;&gt;Float64&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;}, &lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;Float64&lt;/span&gt;) at &lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;Users&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;apple&lt;span style=&#34;color:#f92672&#34;&gt;/.&lt;/span&gt;julia&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;packages&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;Mamba&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;qNBKz&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;src&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;distributions&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;constructors&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;jl&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;35&lt;/span&gt; (repeats &lt;span style=&#34;color:#ae81ff&#34;&gt;80000&lt;/span&gt; times)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;masterブランチでは修正されているみたいなので、次のリリースでは治るはず&amp;hellip;。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Remove unneeded MvNormal constructor · brian-j-smith/Mamba.jl@dcaf1cc&lt;br&gt;
&lt;a href=&#34;https://github.com/brian-j-smith/Mamba.jl/commit/dcaf1ccac1c468d20d49a21acbaeb0cb6adcb4cf&#34;&gt;https://github.com/brian-j-smith/Mamba.jl/commit/dcaf1ccac1c468d20d49a21acbaeb0cb6adcb4cf&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;応急処置として代わりに&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-julia&#34; data-lang=&#34;julia&#34;&gt;MvNormal(zeros(&lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;), fill(&lt;span style=&#34;color:#ae81ff&#34;&gt;4.0&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;))
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;にしておけば動くのでこっちを使っておくか。&lt;/p&gt;
&lt;p&gt;追記:&lt;/p&gt;
&lt;p&gt;平均が0だったら&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-julia&#34; data-lang=&#34;julia&#34;&gt;MvNormal(&lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;4.0&lt;/span&gt;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;これで良さそう。&lt;/p&gt;
&lt;p&gt;追記:&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/brian-j-smith/Mamba.jl/releases/tag/v0.12.1&#34;&gt;Mamba 0.12.1&lt;/a&gt;で直っていた！&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Juliaで体験するベイズ推論(5) -嘘に対抗するアルゴリズム</title>
      <link>https://matsueushi.github.io/posts/bayesian-methods-julia-5/</link>
      <pubDate>Fri, 22 Mar 2019 21:22:17 -0400</pubDate>
      
      <guid>https://matsueushi.github.io/posts/bayesian-methods-julia-5/</guid>
      <description>&lt;p&gt;「Pythonで体験するベイズ推論」の「2.2.7 例題 カンニングした学生の割合」をやってみよう。&lt;/p&gt;
&lt;p&gt;学生が試験中にカンニングする頻度を求めたい。観測データは個人がカンニングしたかどうかは特定できない、以下のアルゴリズムを用いる。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;コイントスを(こっそり)行い、表が出たら正直に答える&lt;/li&gt;
&lt;li&gt;裏が出た場合、もう一枚コインを(こっそり)投げ、表が出たら「カンニングした」と答え、裏が出たら「カンニングしなかった」と答える。&lt;/li&gt;
&lt;li&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;カンニングが全くなければ、「カンニングした」という回答がある確率は 1/2 * 1/2 = 1/4, 全員カンニングしていれば 1/2 + 1/2 * 1/2 = 3/4 になる。&lt;/p&gt;
&lt;p&gt;まずはライブラリをインポート。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-julia&#34; data-lang=&#34;julia&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;using&lt;/span&gt; Distributed
addprocs(&lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;)
&lt;span style=&#34;color:#a6e22e&#34;&gt;@everywhere&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;using&lt;/span&gt; Mamba
&lt;span style=&#34;color:#66d9ef&#34;&gt;using&lt;/span&gt; Plots
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;学生の数が100人、「カンニングした」という回答が35人とする。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-julia&#34; data-lang=&#34;julia&#34;&gt;N &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;100&lt;/span&gt;
X &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;35&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Mambaのモデルは次のようになる。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-julia&#34; data-lang=&#34;julia&#34;&gt;model &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Model(
    obs &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Stochastic(
        (proportion, N) &lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt; Binomial(N, proportion),
        &lt;span style=&#34;color:#66d9ef&#34;&gt;false&lt;/span&gt;
    ),
    
    proportion &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Logical(
        (true_answers, first_coin_flips, second_coin_flips) &lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt;
            (observed &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;@&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;(first_coin_flips &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; true_answers &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; (&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt; first_coin_flips) &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; second_coin_flips);
            mean(observed)),
        &lt;span style=&#34;color:#66d9ef&#34;&gt;false&lt;/span&gt;
    ),
    
    true_answers &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Stochastic(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;, p &lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt; Bernoulli(p), &lt;span style=&#34;color:#66d9ef&#34;&gt;false&lt;/span&gt;),
    
    first_coin_flips &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Stochastic(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;, () &lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt; Bernoulli(&lt;span style=&#34;color:#ae81ff&#34;&gt;0.5&lt;/span&gt;), &lt;span style=&#34;color:#66d9ef&#34;&gt;false&lt;/span&gt;),
    second_coin_flips &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Stochastic(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;, () &lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt; Bernoulli(&lt;span style=&#34;color:#ae81ff&#34;&gt;0.5&lt;/span&gt;), &lt;span style=&#34;color:#66d9ef&#34;&gt;false&lt;/span&gt;),
    
    p &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Stochastic(() &lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt; Uniform()),
)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt; &lt;code&gt;proportion&lt;/code&gt;を計算するときの&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-julia&#34; data-lang=&#34;julia&#34;&gt;observed &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;@&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;(first_coin_flips &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; true_answers &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; (&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt; first_coin_flips) &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; second_coin_flips)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;は@マクロを使った書き方で、&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-julia&#34; data-lang=&#34;julia&#34;&gt;observed &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; first_coin_flips &lt;span style=&#34;color:#f92672&#34;&gt;.*&lt;/span&gt; true_answers &lt;span style=&#34;color:#f92672&#34;&gt;.+&lt;/span&gt; (&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;.-&lt;/span&gt; first_coin_flips) &lt;span style=&#34;color:#f92672&#34;&gt;.*&lt;/span&gt; second_coin_flips)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;と同じである。 &lt;code&gt;true_answers&lt;/code&gt; , &lt;code&gt;first_coin_flips&lt;/code&gt; , &lt;code&gt;second_coin_flips&lt;/code&gt; は長さNの &lt;code&gt;Stochastic&lt;/code&gt; ベクターだが、Nをモデルに与えなくても、&lt;code&gt;Stochastic&lt;/code&gt; コンストラクタの第1引数を1(1次元)にして、初期値に長さNのベクターを与えれば大丈夫。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-julia&#34; data-lang=&#34;julia&#34;&gt;data &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;Dict&lt;/span&gt;{&lt;span style=&#34;color:#66d9ef&#34;&gt;Symbol&lt;/span&gt;, &lt;span style=&#34;color:#66d9ef&#34;&gt;Any&lt;/span&gt;}(
    &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;obs &lt;span style=&#34;color:#f92672&#34;&gt;=&amp;gt;&lt;/span&gt; X,
    &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;N &lt;span style=&#34;color:#f92672&#34;&gt;=&amp;gt;&lt;/span&gt; N,
)
inits &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; [
    &lt;span style=&#34;color:#66d9ef&#34;&gt;Dict&lt;/span&gt;{&lt;span style=&#34;color:#66d9ef&#34;&gt;Symbol&lt;/span&gt;, &lt;span style=&#34;color:#66d9ef&#34;&gt;Any&lt;/span&gt;}(
        &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;obs &lt;span style=&#34;color:#f92672&#34;&gt;=&amp;gt;&lt;/span&gt; X,
        &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;proportion &lt;span style=&#34;color:#f92672&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0.5&lt;/span&gt;,
        &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;true_answers &lt;span style=&#34;color:#f92672&#34;&gt;=&amp;gt;&lt;/span&gt; rand(Bernoulli(), N),
        &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;first_coin_flips &lt;span style=&#34;color:#f92672&#34;&gt;=&amp;gt;&lt;/span&gt; rand(Bernoulli(), N),
        &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;second_coin_flips &lt;span style=&#34;color:#f92672&#34;&gt;=&amp;gt;&lt;/span&gt; rand(Bernoulli(), N),
        &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;p &lt;span style=&#34;color:#f92672&#34;&gt;=&amp;gt;&lt;/span&gt; rand(Uniform()),
    ) &lt;span style=&#34;color:#66d9ef&#34;&gt;for&lt;/span&gt; _ &lt;span style=&#34;color:#66d9ef&#34;&gt;in&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;
]
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;code&gt;true_answers&lt;/code&gt; , &lt;code&gt;first_coin_flips&lt;/code&gt; , &lt;code&gt;second_coin_flips&lt;/code&gt; は \( \{0, 1\} \) からのサンプリングなので、Sampling Functionsを見ると &lt;code&gt;BHMC&lt;/code&gt;, &lt;code&gt;BIA&lt;/code&gt;, &lt;code&gt;BMC3&lt;/code&gt;, &lt;code&gt;BMG&lt;/code&gt;のどれかを使えば良いようである。&lt;code&gt;BIA&lt;/code&gt;, &lt;code&gt;BMC3&lt;/code&gt;, &lt;code&gt;BMG&lt;/code&gt;を使って比較してみた。&lt;/p&gt;
&lt;p&gt; &lt;code&gt;BIA&lt;/code&gt;のサンプリング設定は下の通り。&lt;code&gt;BMC3&lt;/code&gt;, &lt;code&gt;BMG&lt;/code&gt; も &lt;code&gt;scheme&lt;/code&gt; だけ変えればよく同様である。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-julia&#34; data-lang=&#34;julia&#34;&gt;samplings &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;100000&lt;/span&gt;
burning &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;20000&lt;/span&gt;
scheme_bia &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; [NUTS(&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;p), BIA([&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;true_answers, &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;first_coin_flips, &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;second_coin_flips])]
setsamplers!(model, scheme_bia)
sim_bia &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; mcmc(model, data, inits, samplings, burnin &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; burning, thin &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;10&lt;/span&gt;, chains &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;)
p_bia &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; reshape(Mamba&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;plot(sim_bia, [&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;trace, &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;density, &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;autocor, &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;mean], legend &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;true&lt;/span&gt;), (&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;))
Mamba&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;draw(p_bia, nrow &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;, ncol &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;bia&#34;&gt;BIA&lt;/h3&gt;
&lt;p&gt;&lt;img src=&#34;https://matsueushi.github.io/images/posts/bayesian-methods-julia-5_bia.png&#34; alt=&#34;BIA&#34;&gt;&lt;/p&gt;
&lt;h3 id=&#34;bmc3&#34;&gt;BMC3&lt;/h3&gt;
&lt;p&gt;&lt;img src=&#34;https://matsueushi.github.io/images/posts/bayesian-methods-julia-5_bmc3.png&#34; alt=&#34;BMC3&#34;&gt;&lt;/p&gt;
&lt;h3 id=&#34;bmg&#34;&gt;BMG&lt;/h3&gt;
&lt;p&gt;&lt;img src=&#34;https://matsueushi.github.io/images/posts/bayesian-methods-julia-5_bmg.png&#34; alt=&#34;BMG&#34;&gt;&lt;/p&gt;
&lt;p&gt;自己相関や確率密度を見ると &lt;code&gt;BIA&lt;/code&gt;, &lt;code&gt;BMC3&lt;/code&gt; が良さそう。&lt;/p&gt;
&lt;h3 id=&#34;もう一つのモデル&#34;&gt;もう一つのモデル&lt;/h3&gt;
&lt;p&gt;「カンニングしました」と答える確率は p/2 + 1/4 なので、&lt;code&gt;proportion&lt;/code&gt; を計算する代わりにこれを直接使ってモデリングすることもできる。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-julia&#34; data-lang=&#34;julia&#34;&gt;another_model &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Model(
    obs &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Stochastic(
        (p, N) &lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt; 
            (p_skewed &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0.5&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; p &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0.25&lt;/span&gt;;
            Binomial(N, p_skewed)),
        &lt;span style=&#34;color:#66d9ef&#34;&gt;false&lt;/span&gt;
    ),
    
    p &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Stochastic(() &lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt; Uniform()),
)
another_scheme &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; [NUTS(&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;p)]
setsamplers!(another_model, another_scheme)
another_sim &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; mcmc(another_model, data, inits, samplings, burnin &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; burning, thin &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;10&lt;/span&gt;, chains &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;)
another_p &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; reshape(Mamba&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;plot(another_sim, [&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;trace, &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;density, &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;autocor, &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;mean], legend &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;true&lt;/span&gt;), (&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;))
Mamba&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;draw(another_p, nrow &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;, ncol &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;img src=&#34;https://matsueushi.github.io/images/posts/bayesian-methods-julia-5_another.png&#34; alt=&#34;もう一つのモデル&#34;&gt;&lt;/p&gt;
&lt;p&gt; &lt;code&gt;true_answers&lt;/code&gt;, &lt;code&gt;first_coin_flips&lt;/code&gt;, &lt;code&gt;second_coin_flips&lt;/code&gt; をモデリングした場合に比べて、収束が大きく向上している。&lt;/p&gt;
&lt;p&gt;コード -&amp;gt;
&lt;a href=&#34;https://nbviewer.jupyter.org/github/matsueushi/bayesian_methods_julia/blob/master/chapter2_cheat.ipynb&#34;&gt;https://nbviewer.jupyter.org/github/matsueushi/bayesian_methods_julia/blob/master/chapter2_cheat.ipynb&lt;/a&gt;&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Juliaで体験するベイズ推論(4) -ベイズ的 A/B</title>
      <link>https://matsueushi.github.io/posts/bayesian-methods-julia-4/</link>
      <pubDate>Thu, 21 Mar 2019 21:05:35 -0400</pubDate>
      
      <guid>https://matsueushi.github.io/posts/bayesian-methods-julia-4/</guid>
      <description>&lt;p&gt;今回はMambaを使って、「Pythonで体験するベイズ推論」の「例題 : ベイズ的 A/B」 をモデリングする。&lt;/p&gt;
&lt;h2 id=&#34;例題--ベイズ的-ab-テスト&#34;&gt;例題 : ベイズ的 A/B テスト&lt;/h2&gt;
&lt;p&gt;A/Bテストの例題を解いてみよう。&lt;/p&gt;
&lt;p&gt;サイトAを見せられたユーザーが最終的にコンバージョンにつながる確率を \( p_A \)と仮定し、\( N \) 人がサイトAを見せられて、そのうち \( n \) 人がコンバージョンにつながったとする。&lt;/p&gt;
&lt;p&gt;まずはベルヌーイ分布を使って、\( N \) 回の試行をシミュレートする。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-julia&#34; data-lang=&#34;julia&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;# 定数をセット&lt;/span&gt;
p_true &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0.05&lt;/span&gt;
N &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1500&lt;/span&gt;
occurrences &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; rand(Bernoulli(p_true), N)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Mamba.jlで推論アルゴリズムを作成すると、次のようになる。\( p \) の事前分布は \( [0, 1] \) の一様分布に従うとしている。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-julia&#34; data-lang=&#34;julia&#34;&gt;model0 &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Model(
    obs &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Stochastic(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;, 
        (p, N) &lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt; 
         UnivariateDistribution[Bernoulli(p) &lt;span style=&#34;color:#66d9ef&#34;&gt;for&lt;/span&gt; _ &lt;span style=&#34;color:#66d9ef&#34;&gt;in&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;N], &lt;span style=&#34;color:#66d9ef&#34;&gt;false&lt;/span&gt;),
    p &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Stochastic(() &lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt; Uniform()),
)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;モデルは、等価な次の形で書いた方が単純になってわかりやすいかもしれない。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-julia&#34; data-lang=&#34;julia&#34;&gt;model0 &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Model(
    obs &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Stochastic(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;, p &lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt; Bernoulli(p), &lt;span style=&#34;color:#66d9ef&#34;&gt;false&lt;/span&gt;),
    p &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Stochastic(() &lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt; Uniform()),
)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;観測データと初期値を作ってサンプリングし、&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-julia&#34; data-lang=&#34;julia&#34;&gt;data0 &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;Dict&lt;/span&gt;{&lt;span style=&#34;color:#66d9ef&#34;&gt;Symbol&lt;/span&gt;, &lt;span style=&#34;color:#66d9ef&#34;&gt;Any&lt;/span&gt;}(
    &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;obs &lt;span style=&#34;color:#f92672&#34;&gt;=&amp;gt;&lt;/span&gt; occurrences,
    &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;N &lt;span style=&#34;color:#f92672&#34;&gt;=&amp;gt;&lt;/span&gt; N,
)
inits0 &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; [
    &lt;span style=&#34;color:#66d9ef&#34;&gt;Dict&lt;/span&gt;{&lt;span style=&#34;color:#66d9ef&#34;&gt;Symbol&lt;/span&gt;, &lt;span style=&#34;color:#66d9ef&#34;&gt;Any&lt;/span&gt;}(
        &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;obs &lt;span style=&#34;color:#f92672&#34;&gt;=&amp;gt;&lt;/span&gt; occurrences,
        &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;p &lt;span style=&#34;color:#f92672&#34;&gt;=&amp;gt;&lt;/span&gt; rand(Uniform()),
    ) &lt;span style=&#34;color:#66d9ef&#34;&gt;for&lt;/span&gt; _ &lt;span style=&#34;color:#66d9ef&#34;&gt;in&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;
]
scheme0 &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; [NUTS(&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;p)]
setsamplers!(model0, scheme0)
sim0 &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; mcmc(model0, data0, inits0, &lt;span style=&#34;color:#ae81ff&#34;&gt;20000&lt;/span&gt;, burnin &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1000&lt;/span&gt;, thin &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;, chains &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;事後分布のヒストグラムをプロットすると次のようになった。\( N \) の数が小さいのか、真の値と分布のピークは多少ずれている。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-julia&#34; data-lang=&#34;julia&#34;&gt;histogram(vec(sim0[&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;, &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;p, &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;]&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;value), bins &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;30&lt;/span&gt;, normalize &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;pdf,
        linecolor &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;transparent, label &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&amp;#34;&lt;/span&gt;, xlabel &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; L&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;\mbox{Value of }p_A&amp;#34;&lt;/span&gt;, ylabel &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Density&amp;#34;&lt;/span&gt;)
plot!([p_true], seriestype &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;vline, linestyle &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;dash, linewidth &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;,
    label &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; L&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;\mbox{true }p_A&amp;#34;&lt;/span&gt;, legendfontsize &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;12&lt;/span&gt;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;img src=&#34;https://matsueushi.github.io/images/posts/bayesian-methods-julia-4_hist_1.png&#34; alt=&#34;ヒストグラム1&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;-n--の数を増やしてみる&#34;&gt;\( N \) の数を増やしてみる&lt;/h2&gt;
&lt;p&gt;観測データ数を増やして変化を確認してみよう。\( N=1500, 5000, 15000 \) の3種類を試す。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-julia&#34; data-lang=&#34;julia&#34;&gt;ab_sim &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; []
Ns &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; [&lt;span style=&#34;color:#ae81ff&#34;&gt;1500&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;5000&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;15000&lt;/span&gt;]
&lt;span style=&#34;color:#66d9ef&#34;&gt;for&lt;/span&gt; n &lt;span style=&#34;color:#66d9ef&#34;&gt;in&lt;/span&gt; Ns
    ab_occur &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; rand(Bernoulli(p_true), n)
    ab_data &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;Dict&lt;/span&gt;{&lt;span style=&#34;color:#66d9ef&#34;&gt;Symbol&lt;/span&gt;, &lt;span style=&#34;color:#66d9ef&#34;&gt;Any&lt;/span&gt;}(
        &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;obs &lt;span style=&#34;color:#f92672&#34;&gt;=&amp;gt;&lt;/span&gt; ab_occur,
        &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;N &lt;span style=&#34;color:#f92672&#34;&gt;=&amp;gt;&lt;/span&gt; n,
    )
    ab_inits &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; [
        &lt;span style=&#34;color:#66d9ef&#34;&gt;Dict&lt;/span&gt;{&lt;span style=&#34;color:#66d9ef&#34;&gt;Symbol&lt;/span&gt;, &lt;span style=&#34;color:#66d9ef&#34;&gt;Any&lt;/span&gt;}(
            &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;obs &lt;span style=&#34;color:#f92672&#34;&gt;=&amp;gt;&lt;/span&gt; ab_occur,
            &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;p &lt;span style=&#34;color:#f92672&#34;&gt;=&amp;gt;&lt;/span&gt; rand(Uniform()),
        ) &lt;span style=&#34;color:#66d9ef&#34;&gt;for&lt;/span&gt; _ &lt;span style=&#34;color:#66d9ef&#34;&gt;in&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;
    ]
    push!(ab_sim, mcmc(model0, ab_data, ab_inits, &lt;span style=&#34;color:#ae81ff&#34;&gt;20000&lt;/span&gt;, 
                        burnin &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1000&lt;/span&gt;, thin &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;, chains &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;))
&lt;span style=&#34;color:#66d9ef&#34;&gt;end&lt;/span&gt;
Plots&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;plot()
&lt;span style=&#34;color:#66d9ef&#34;&gt;for&lt;/span&gt; (i, sim) &lt;span style=&#34;color:#66d9ef&#34;&gt;in&lt;/span&gt; enumerate(ab_sim)
    histogram!(vec(sim[&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;, &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;p, &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;]&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;value), normalize &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;pdf,
            linecolor &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;transparent, label &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;@sprintf&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;N=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;%d&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;, Ns[i]), 
            xlabel &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; L&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;\mbox{Value of }p_A&amp;#34;&lt;/span&gt;, ylabel &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Density&amp;#34;&lt;/span&gt;)
&lt;span style=&#34;color:#66d9ef&#34;&gt;end&lt;/span&gt;
Plots&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;plot!([p_true], seriestype &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;vline, 
    linestyle &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;dash, linewidth &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;, linecolor &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;red,
    label &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; L&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;\mbox{true }p_A&amp;#34;&lt;/span&gt;, legendfontsize &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;12&lt;/span&gt;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;img src=&#34;https://matsueushi.github.io/images/posts/bayesian-methods-julia-4_hist_2.png&#34; alt=&#34;ヒストグラム2&#34;&gt;&lt;/p&gt;
&lt;p&gt;\( N \) を大きくすると分布の裾野が狭くなり、分布の中心が真の値 \( p_A \) に近づいている。&lt;/p&gt;
&lt;h2 id=&#34;aとbを一緒に&#34;&gt;AとBを一緒に&lt;/h2&gt;
&lt;p&gt;サイトA, Bに対し、未知数である真のコンバージョン率 &lt;code&gt;true_p_A&lt;/code&gt;, &lt;code&gt;true_p_B&lt;/code&gt; はそれぞれ0.05と0.04とし、観測データ数 &lt;code&gt;N_A&lt;/code&gt;, &lt;code&gt;N_B&lt;/code&gt; は1500, 500として観測データを作成する。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-julia&#34; data-lang=&#34;julia&#34;&gt;true_p_A &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0.05&lt;/span&gt;
true_p_B &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0.04&lt;/span&gt;
N_A &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1500&lt;/span&gt;
N_B &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;750&lt;/span&gt;
observation_A &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; rand(Bernoulli(true_p_A), N_A)
observation_B &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; rand(Bernoulli(true_p_B), N_B)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;同時に推論するモデルは以下のようになる。新しく \( p_A \) と \( p_B \) の差を表す &lt;code&gt;Logical&lt;/code&gt; ノード &lt;code&gt;delta&lt;/code&gt; が増えた以外は一つだけ推論する場合をコピーペーストして二つにしただけ。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-julia&#34; data-lang=&#34;julia&#34;&gt;model1 &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Model(
    obs_A &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Stochastic(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;, p_A &lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt; Bernoulli(p_A), &lt;span style=&#34;color:#66d9ef&#34;&gt;false&lt;/span&gt;),
    obs_B &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Stochastic(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;, p_B &lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt; Bernoulli(p_B), &lt;span style=&#34;color:#66d9ef&#34;&gt;false&lt;/span&gt;),
    
    delta &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Logical((p_A, p_B) &lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt; p_A &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt; p_B),
    
    p_A &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Stochastic(() &lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt; Uniform()),
    p_B &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Stochastic(() &lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt; Uniform()),
)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;与える観測データと初期値は下のようにした。\( p_A \) と \( p_B \) の初期値は \( [0,1] \) からランダムで取った。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-julia&#34; data-lang=&#34;julia&#34;&gt;data1 &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;Dict&lt;/span&gt;{&lt;span style=&#34;color:#66d9ef&#34;&gt;Symbol&lt;/span&gt;, &lt;span style=&#34;color:#66d9ef&#34;&gt;Any&lt;/span&gt;}(
    &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;obs_A &lt;span style=&#34;color:#f92672&#34;&gt;=&amp;gt;&lt;/span&gt; observation_A,
    &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;obs_B &lt;span style=&#34;color:#f92672&#34;&gt;=&amp;gt;&lt;/span&gt; observation_B,
)
inits1 &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; [
    &lt;span style=&#34;color:#66d9ef&#34;&gt;begin&lt;/span&gt;
        p_A &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; rand(Uniform())
        p_B &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; rand(Uniform())
        &lt;span style=&#34;color:#66d9ef&#34;&gt;Dict&lt;/span&gt;{&lt;span style=&#34;color:#66d9ef&#34;&gt;Symbol&lt;/span&gt;, &lt;span style=&#34;color:#66d9ef&#34;&gt;Any&lt;/span&gt;}(
            &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;obs_A &lt;span style=&#34;color:#f92672&#34;&gt;=&amp;gt;&lt;/span&gt; observation_A,
            &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;obs_B &lt;span style=&#34;color:#f92672&#34;&gt;=&amp;gt;&lt;/span&gt; observation_B,
            &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;p_A &lt;span style=&#34;color:#f92672&#34;&gt;=&amp;gt;&lt;/span&gt; p_A,
            &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;p_B &lt;span style=&#34;color:#f92672&#34;&gt;=&amp;gt;&lt;/span&gt; p_B,
            &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;delta &lt;span style=&#34;color:#f92672&#34;&gt;=&amp;gt;&lt;/span&gt; p_A &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt; p_B,
        )
    &lt;span style=&#34;color:#66d9ef&#34;&gt;end&lt;/span&gt;
    &lt;span style=&#34;color:#66d9ef&#34;&gt;for&lt;/span&gt; _ &lt;span style=&#34;color:#66d9ef&#34;&gt;in&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;
]
scheme1 &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; [NUTS([&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;p_A, &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;p_B])]
setsamplers!(model1, scheme1)
sim1 &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; mcmc(model1, data1, inits1, &lt;span style=&#34;color:#ae81ff&#34;&gt;25000&lt;/span&gt;, burnin &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;5000&lt;/span&gt;, thin &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;, chains &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;)
p1 &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Mamba&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;plot(sim1[&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;, [&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;p_A, &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;p_B, &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;delta], &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;], legend &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;true&lt;/span&gt;)
Mamba&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;draw(p1, nrow &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;, ncol &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;img src=&#34;https://matsueushi.github.io/images/posts/bayesian-methods-julia-4_posterior.png&#34; alt=&#34;事後分布&#34;&gt;&lt;/p&gt;
&lt;p&gt;\( p_A \) と \( p_B \) の事後分布と一つの図にプロットして分布の裾の広さを比較する。Bの方がサンプル数が少ないので裾が広い。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-julia&#34; data-lang=&#34;julia&#34;&gt;histogram(vec(sim1[&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;, &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;p_A, &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;]&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;value), normalize &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;pdf, bins&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;30&lt;/span&gt;, fillalpha &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0.8&lt;/span&gt;, linecolor &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;transparent, label &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;p_A&amp;#34;&lt;/span&gt;)
histogram!(vec(sim1[&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;, &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;p_B, &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;]&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;value), normalize &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;pdf, bins&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;30&lt;/span&gt;, fillalpha &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0.8&lt;/span&gt;, linecolor &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;transparent, label &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;p_B&amp;#34;&lt;/span&gt;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;img src=&#34;https://matsueushi.github.io/images/posts/bayesian-methods-julia-4_hist_3.png&#34; alt=&#34;p_Aとp_Bのヒストグラム&#34;&gt;&lt;/p&gt;
&lt;p&gt;サイトA, サイトBのデータを2倍にした時の &lt;code&gt;delta&lt;/code&gt; の分布の変化を見ると、このようになった。もともとの &lt;code&gt;delta&lt;/code&gt; の分布が真のデルタの値から近い値を中心に当たっていたため改善されている感じがわかりづらいが、データを2倍にすると裾が狭くなっている。&lt;/p&gt;
&lt;p&gt;同様の改善効果があるのなら、&lt;code&gt;N_B&lt;/code&gt; を増やす方が良い(&lt;code&gt;N_B&lt;/code&gt; を2倍にするとデータサイズが750増加するが、&lt;code&gt;N_A&lt;/code&gt; を2倍にするとデータサイズが1500増加するため)&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://matsueushi.github.io/images/posts/bayesian-methods-julia-4_hist_4.png&#34; alt=&#34;データを増やした場合のヒストグラム&#34;&gt;&lt;/p&gt;
&lt;p&gt;真の \(p_A, p_B \) を動かして &lt;code&gt;delta&lt;/code&gt; の分布を見ると次のようになる。&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://matsueushi.github.io/images/posts/bayesian-methods-julia-4_hist_5.png&#34; alt=&#34;p_A, p_Bを動かした場合のヒストグラム&#34;&gt;&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Juliaで体験するベイズ推論(3) -新しいデータセットの生成</title>
      <link>https://matsueushi.github.io/posts/bayesian-methods-julia-3/</link>
      <pubDate>Wed, 20 Mar 2019 20:58:08 -0400</pubDate>
      
      <guid>https://matsueushi.github.io/posts/bayesian-methods-julia-3/</guid>
      <description>&lt;p&gt;引き続き「Pythonで体験するベイズ推論」の第2章の新しいデータセットの作成をJuliaでやってみる。&lt;/p&gt;
&lt;h2 id=&#34;新しいデータセットの生成&#34;&gt;新しいデータセットの生成&lt;/h2&gt;
&lt;p&gt;PyMCについての説明はスキップして、シミュレーションによるメッセージ数のデータ生成から行う。&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/brian-j-smith/Mamba.jl&#34;&gt;Mamba.jl&lt;/a&gt;は分布の作成に&lt;a href=&#34;https://github.com/JuliaStats/Distributions.jl&#34;&gt;Distributions.jl&lt;/a&gt;を使っているので、シミュレーションだけ行いたかったらDistributionsを &lt;code&gt;using&lt;/code&gt; すれば十分。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-julia&#34; data-lang=&#34;julia&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;using&lt;/span&gt; Distributions
&lt;span style=&#34;color:#66d9ef&#34;&gt;using&lt;/span&gt; Plots
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;データセットの作成とプロットは下のようになる。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-julia&#34; data-lang=&#34;julia&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;function&lt;/span&gt; plot_artificial_sms_dataset()
    tau &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; rand(DiscreteUniform(&lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;80&lt;/span&gt;))
    theta &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;20&lt;/span&gt;
    lambda_1, lambda_2 &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; rand(Exponential(theta), &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;)
    lambda_ &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; cat(fill(lambda_1, tau), fill(lambda_2, &lt;span style=&#34;color:#ae81ff&#34;&gt;80&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt; tau), dims &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;)
    data &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;@&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;rand(Poisson(lambda_))
    barc &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; fill(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;80&lt;/span&gt;)
    barc[tau] &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;
    bar(&lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;80&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;, data, linecolor &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;transparent, fillcolor &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; barc,
        xlabel &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Time (days)&amp;#34;&lt;/span&gt;, ylabel &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Count of messages&amp;#34;&lt;/span&gt;, label &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&amp;#34;&lt;/span&gt;)
&lt;span style=&#34;color:#66d9ef&#34;&gt;end&lt;/span&gt;
plts &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; []
&lt;span style=&#34;color:#66d9ef&#34;&gt;for&lt;/span&gt; i &lt;span style=&#34;color:#66d9ef&#34;&gt;in&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;4&lt;/span&gt;
    push!(plts, plot_artificial_sms_dataset())
&lt;span style=&#34;color:#66d9ef&#34;&gt;end&lt;/span&gt;
plot(plts&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt;, layout &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; (&lt;span style=&#34;color:#ae81ff&#34;&gt;4&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;), size &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; [&lt;span style=&#34;color:#ae81ff&#34;&gt;600&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;800&lt;/span&gt;])
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;img src=&#34;https://matsueushi.github.io/images/posts/bayesian-methods-julia-3_messages.png&#34; alt=&#34;メッセージ数&#34;&gt;&lt;/p&gt;
&lt;p&gt;Plots.jlでPythonのMatplotlibと同様に複数のSubplotsを表示するには、一旦list (e.g. &lt;code&gt;plt&lt;/code&gt; )にプロット結果を受けておいて、最後に一気に&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-julia&#34; data-lang=&#34;julia&#34;&gt;plot(plts…, layout &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; (&lt;span style=&#34;color:#ae81ff&#34;&gt;4&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;), size &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; [&lt;span style=&#34;color:#ae81ff&#34;&gt;600&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;800&lt;/span&gt;])
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;として表示すればできる。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-julia&#34; data-lang=&#34;julia&#34;&gt;plot(plts, layout &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; (&lt;span style=&#34;color:#ae81ff&#34;&gt;4&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;), size &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; [&lt;span style=&#34;color:#ae81ff&#34;&gt;600&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;800&lt;/span&gt;])
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;だと &lt;code&gt;MethodError: no method matching MethodError(::String)&lt;/code&gt; が出てダメだった。&lt;/p&gt;
&lt;p&gt;モデルシミュレーションのコード -&amp;gt;
&lt;a href=&#34;https://nbviewer.jupyter.org/github/matsueushi/bayesian_methods_julia/blob/master/chapter2_simulate_model.ipynb&#34;&gt;https://nbviewer.jupyter.org/github/matsueushi/bayesian_methods_julia/blob/master/chapter2_simulate_model.ipynb&lt;/a&gt;&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Juliaで体験するベイズ推論(2) -メッセージ数に変化はあるか？ </title>
      <link>https://matsueushi.github.io/posts/bayesian-methods-julia-2/</link>
      <pubDate>Wed, 20 Mar 2019 20:45:02 -0400</pubDate>
      
      <guid>https://matsueushi.github.io/posts/bayesian-methods-julia-2/</guid>
      <description>&lt;p&gt;&lt;a href=&#34;bayesian-method-julia-2.md&#34;&gt;前回&lt;/a&gt;に引き続き、「Pythonで体験するベイズ推論」をJuliaでやってみる。本に従い、前回作成した「メッセージ数に変化はあるか？」を二つの変化点の場合に拡張する。&lt;/p&gt;
&lt;p&gt;変化点が二つの場合を考えてみる。モデルは変化点が一つの場合とほぼ同じで、&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-julia&#34; data-lang=&#34;julia&#34;&gt;model2 &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Model(
    
    obs &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Stochastic(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;,
        (lambda, N) &lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt;
            UnivariateDistribution[Poisson(lambda[i]) &lt;span style=&#34;color:#66d9ef&#34;&gt;for&lt;/span&gt; i &lt;span style=&#34;color:#66d9ef&#34;&gt;in&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;N],
        &lt;span style=&#34;color:#66d9ef&#34;&gt;false&lt;/span&gt;
    ),
    
    lambda &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Logical(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;, 
        (lambda1, lambda2, lambda3, tau1, tau2, N) &lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt; 
            (out &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; fill(lambda1, N);
            i1 &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;Int64&lt;/span&gt;(tau1&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;value) &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;; &lt;span style=&#34;color:#75715e&#34;&gt;# Juliaは1-indexingのため&lt;/span&gt;
            i2 &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;Int64&lt;/span&gt;(tau2&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;value) &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;;
            out[i1&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;end&lt;/span&gt;] &lt;span style=&#34;color:#f92672&#34;&gt;.=&lt;/span&gt; lambda2;
            out[i2&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;end&lt;/span&gt;] &lt;span style=&#34;color:#f92672&#34;&gt;.=&lt;/span&gt; lambda3;
            out),
            &lt;span style=&#34;color:#66d9ef&#34;&gt;false&lt;/span&gt;,
        ),
    
    lambda1 &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Stochastic(theta &lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt; Exponential(theta)),
    lambda2 &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Stochastic(theta &lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt; Exponential(theta)),
    lambda3 &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Stochastic(theta &lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt; Exponential(theta)),
    
    tau1 &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Stochastic(N &lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt; DiscreteUniform(&lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;, N&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;)),
    tau2 &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Stochastic((tau1, N) &lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt; DiscreteUniform(tau1, N)),
)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;初期値とサンプリングスキームを同様に与えてサンプリングすると、&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-julia&#34; data-lang=&#34;julia&#34;&gt;inits2 &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; [
    &lt;span style=&#34;color:#66d9ef&#34;&gt;Dict&lt;/span&gt;{&lt;span style=&#34;color:#66d9ef&#34;&gt;Symbol&lt;/span&gt;, &lt;span style=&#34;color:#66d9ef&#34;&gt;Any&lt;/span&gt;}(
        &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;obs &lt;span style=&#34;color:#f92672&#34;&gt;=&amp;gt;&lt;/span&gt; count_data&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;messages,
        &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;lambda1 &lt;span style=&#34;color:#f92672&#34;&gt;=&amp;gt;&lt;/span&gt; theta,
        &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;lambda2 &lt;span style=&#34;color:#f92672&#34;&gt;=&amp;gt;&lt;/span&gt; theta,
        &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;lambda3 &lt;span style=&#34;color:#f92672&#34;&gt;=&amp;gt;&lt;/span&gt; theta,
        &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;tau1 &lt;span style=&#34;color:#f92672&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;,
        &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;tau2 &lt;span style=&#34;color:#f92672&#34;&gt;=&amp;gt;&lt;/span&gt; N,
    ) &lt;span style=&#34;color:#66d9ef&#34;&gt;for&lt;/span&gt; _ &lt;span style=&#34;color:#66d9ef&#34;&gt;in&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;
]
scheme2 &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; [AMWG([&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;lambda1, &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;lambda2, &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;lambda3], &lt;span style=&#34;color:#ae81ff&#34;&gt;1.0&lt;/span&gt;), DGS([&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;tau1, &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;tau2])]
setsamplers!(model2, scheme2) sim2 &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; mcmc(model2, data0, inits2, &lt;span style=&#34;color:#ae81ff&#34;&gt;40000&lt;/span&gt;, burnin &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;10000&lt;/span&gt;, thin &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;, chains &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;事後分布は以下のようになる。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-julia&#34; data-lang=&#34;julia&#34;&gt;p2 &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Mamba&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;plot(sim2[&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;, [&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;tau1, &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;tau2], &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;], legend &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;true&lt;/span&gt;)
Mamba&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;draw(p2, nrow &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;, ncol &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;img src=&#34;https://matsueushi.github.io/images/posts/bayesian-methods-julia-2_posterior_1.png&#34; alt=&#34;事後分布1&#34;&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-julia&#34; data-lang=&#34;julia&#34;&gt;p2 &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Mamba&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;plot(sim2[&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;, [&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;lambda1, &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;lambda2, &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;lambda3], &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;], legend &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;true&lt;/span&gt;)
Mamba&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;draw(p2, nrow &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;, ncol &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;img src=&#34;https://matsueushi.github.io/images/posts/bayesian-methods-julia-2_posterior_2.png&#34; alt=&#34;事後分布2&#34;&gt;&lt;/p&gt;
&lt;p&gt;本で言及されていた、変化点の個数についても事前分布を作ってモデリングしてみたがうまくいかなかった。&lt;/p&gt;
&lt;p&gt;コード -&amp;gt;
&lt;a href=&#34;https://nbviewer.jupyter.org/github/matsueushi/bayesian_methods_julia/blob/master/chapter1_message.ipynb&#34;&gt;https://nbviewer.jupyter.org/github/matsueushi/bayesian_methods_julia/blob/master/chapter1_message.ipynb&lt;/a&gt;&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Juliaで体験するベイズ推論(1) -メッセージ数に変化はあるか？</title>
      <link>https://matsueushi.github.io/posts/bayesian-methods-julia-1/</link>
      <pubDate>Tue, 19 Mar 2019 23:30:41 -0400</pubDate>
      
      <guid>https://matsueushi.github.io/posts/bayesian-methods-julia-1/</guid>
      <description>&lt;p&gt;久保拓弥「データ解析のための統計モデリング入門」を読み終えたので、次はCameron Davidson-Pilon著、玉木徹訳の「Pythonで体験するベイズ推論」(&lt;a href=&#34;https://github.com/CamDavidsonPilon/Probabilistic-Programming-and-Bayesian-Methods-for-Hackers&#34;&gt;GitHubリポジトリ&lt;/a&gt;) をJuliaとMamba.jlでモデリングしていきたいと思う。&lt;/p&gt;
&lt;p&gt;まず例題1.4.1の「メッセージ数に変化はあるか？」をやってみる。&lt;/p&gt;
&lt;p&gt;元のノートブックは&lt;a href=&#34;https://nbviewer.jupyter.org/github/CamDavidsonPilon/Probabilistic-Programming-and-Bayesian-Methods-for-Hackers/blob/master/Chapter1_Introduction/Ch1_Introduction_PyMC2.ipynb&#34;&gt;これ&lt;/a&gt;。&lt;/p&gt;
&lt;p&gt;JuliaでCSVファイルをhttps上から取るには、パッケージ &lt;code&gt;HTTP&lt;/code&gt; , &lt;code&gt;CSV&lt;/code&gt; をインポートして&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-julia&#34; data-lang=&#34;julia&#34;&gt;r &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; HTTP&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;request(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;GET&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;https://git.io/vXTVC&amp;#34;&lt;/span&gt;);
count_data &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; CSV&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;read(&lt;span style=&#34;color:#66d9ef&#34;&gt;IOBuffer&lt;/span&gt;(r&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;body), header&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;messages&amp;#34;&lt;/span&gt;])
とすれば良い。
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Plotsでプロットすると下のような感じ。Juliaはインデックスが1から始まるので、x軸を &lt;code&gt;0:N-1&lt;/code&gt; にしておく。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-julia&#34; data-lang=&#34;julia&#34;&gt;N &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; length(count_data&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;messages)
bar(&lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;N&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;, count_data&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;messages, label &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&amp;#34;&lt;/span&gt;, size &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; [&lt;span style=&#34;color:#ae81ff&#34;&gt;600&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;200&lt;/span&gt;],
    linecolor &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;transparent,
    xlabel &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Time (days)&amp;#34;&lt;/span&gt;, ylabel &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Count of messages&amp;#34;&lt;/span&gt;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;img src=&#34;https://matsueushi.github.io/images/posts/bayesian-methods-julia-1_1.png&#34; alt=&#34;Count of messages&#34;&gt;&lt;/p&gt;
&lt;p&gt;\( i \) 日目のメッセージ数 \( C_i \) がポアソン分布 \( \text{Poisson}(\lambda) \) に従い、\( \lambda \) の値が突然ある日 \( \lambda \) で変わる日があるとする。\( \tau &amp;lt; \lambda \) のとき \( \lambda = \lambda_1, \tau \ge \lambda \) の時 \( \lambda=\lambda_2 \)とする。&lt;/p&gt;
&lt;p&gt;この \( \tau, \lambda_1, \lambda_2 \) 推定する。\( \lambda_1, \lambda_2 \) の事前分布は指数分布 \( \text{Exp}(\alpha) \) とする。ここでαは計数データの平均の逆数である。\( \tau \) の事前分布は一様分布とする。&lt;/p&gt;
&lt;p&gt;Mambaでモデリングするときに注意しないといけないのは、PyMCと分布のパラメトライズが一部異なるところである。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;class pymc3.distributions.continuous.Exponential(lam, *args, **kwargs)&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://docs.pymc.io/api/distributions/continuous.html#pymc3.distributions.continuous.Exponential&#34;&gt;https://docs.pymc.io/api/distributions/continuous.html#pymc3.distributions.continuous.Exponential&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;\&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Distributions.Exponential — Type.&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://juliastats.github.io/Distributions.jl/stable/univariate/#Distributions.Exponential&#34;&gt;https://juliastats.github.io/Distributions.jl/stable/univariate/#Distributions.Exponential&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Exponentialのパラメトライズが違うことに気づかずにモデリングを行っていたのだが、Mambaで使っているDistiribution.jlの &lt;code&gt;Exponential(θ)&lt;/code&gt; をPyMCの &lt;code&gt;pm.Exponential(lam)&lt;/code&gt; と 同じ分布となるためには &lt;code&gt;θ=1/lam&lt;/code&gt; とする必要がある。これを間違えていたため下のように事前分布が全く異なってしまい収束しなくなってしまっていた。&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://matsueushi.github.io/images/posts/bayesian-methods-julia-1_exponential.png&#34; alt=&#34;Exponential&#34;&gt;&lt;/p&gt;
&lt;p&gt;Mambaでモデルを作成すると次のようになる。パラメトライズの方法が違うので、変数は &lt;code&gt;α&lt;/code&gt; の代わりに &lt;code&gt;θ&lt;/code&gt; を使った。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-julia&#34; data-lang=&#34;julia&#34;&gt;model1 &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Model(
    
    obs &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Stochastic(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;,
        (lambda, N) &lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt;
            UnivariateDistribution[
                Poisson(lambda[i]) &lt;span style=&#34;color:#66d9ef&#34;&gt;for&lt;/span&gt; i &lt;span style=&#34;color:#66d9ef&#34;&gt;in&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;N],
        &lt;span style=&#34;color:#66d9ef&#34;&gt;false&lt;/span&gt;
    ),
    
    lambda &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Logical(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;, 
        (lambda1, lambda2, tau, N) &lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt; 
            (out &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; fill(lambda1, N);
            i &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;Int64&lt;/span&gt;(tau&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;value) &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;; &lt;span style=&#34;color:#75715e&#34;&gt;# Juliaは1-indexingのため&lt;/span&gt;
            out[i&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;end&lt;/span&gt;, &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;] &lt;span style=&#34;color:#f92672&#34;&gt;.=&lt;/span&gt; lambda2;
            out),
        ),
    
    lambda1 &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Stochastic(theta &lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt; Exponential(theta)),
    lambda2 &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Stochastic(theta &lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt; Exponential(theta)),
    
    tau &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Stochastic(N &lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt; DiscreteUniform(&lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;, N)),
)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;観察されるデータと &lt;code&gt;θ &lt;/code&gt;を準備する。&lt;code&gt;θ&lt;/code&gt; はメッセージ数の平均の逆数 &lt;code&gt;α&lt;/code&gt; の逆数なので、メッセージ数の平均。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-julia&#34; data-lang=&#34;julia&#34;&gt;theta &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; mean(count_data&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;messages)
data0 &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;Dict&lt;/span&gt;{&lt;span style=&#34;color:#66d9ef&#34;&gt;Symbol&lt;/span&gt;, &lt;span style=&#34;color:#66d9ef&#34;&gt;Any&lt;/span&gt;}(
    &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;obs &lt;span style=&#34;color:#f92672&#34;&gt;=&amp;gt;&lt;/span&gt; count_data&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;messages,
    &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;theta &lt;span style=&#34;color:#f92672&#34;&gt;=&amp;gt;&lt;/span&gt; theta,
    &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;N &lt;span style=&#34;color:#f92672&#34;&gt;=&amp;gt;&lt;/span&gt; length(count_data&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;messages),
)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;初期値は下のようにする。今回はサンプリングのパスを3つとするので初期値も3つ用意する。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-julia&#34; data-lang=&#34;julia&#34;&gt;inits1 &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; [
    &lt;span style=&#34;color:#66d9ef&#34;&gt;Dict&lt;/span&gt;{&lt;span style=&#34;color:#66d9ef&#34;&gt;Symbol&lt;/span&gt;, &lt;span style=&#34;color:#66d9ef&#34;&gt;Any&lt;/span&gt;}(
        &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;obs &lt;span style=&#34;color:#f92672&#34;&gt;=&amp;gt;&lt;/span&gt; count_data&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;messages,
        &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;lambda1 &lt;span style=&#34;color:#f92672&#34;&gt;=&amp;gt;&lt;/span&gt; theta,
        &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;lambda2 &lt;span style=&#34;color:#f92672&#34;&gt;=&amp;gt;&lt;/span&gt; theta,
        &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;tau &lt;span style=&#34;color:#f92672&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;,
    ) &lt;span style=&#34;color:#66d9ef&#34;&gt;for&lt;/span&gt; _ &lt;span style=&#34;color:#66d9ef&#34;&gt;in&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;
]
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;サンプリングの設定では、 \( \tau \) は離散値なので &lt;code&gt;DGS&lt;/code&gt; を使う。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-julia&#34; data-lang=&#34;julia&#34;&gt;scheme1 &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; [AMWG([&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;lambda1, &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;lambda2], &lt;span style=&#34;color:#ae81ff&#34;&gt;1.0&lt;/span&gt;), DGS(&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;tau)]
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;サンプリングを行うと、本文と同様、44, 45日後にユーザーが振る舞いを変えたというところの確率密度が高くなっている。離散値になっていないので、何か設定が間違っているのかもしれない。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-julia&#34; data-lang=&#34;julia&#34;&gt;setsamplers!(model1, scheme1)
sim1 &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; mcmc(model1, data0, inits1, &lt;span style=&#34;color:#ae81ff&#34;&gt;40000&lt;/span&gt;, burnin &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;10000&lt;/span&gt;, thin &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;, chains &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;)
p1 &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Mamba&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;plot(sim1[&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;, [&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;tau, &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;lambda1, &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;lambda2], &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;], legend &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;true&lt;/span&gt;)
Mamba&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;draw(p1, nrow &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;, ncol &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;img src=&#34;https://matsueushi.github.io/images/posts/bayesian-methods-julia-1_sampling.png&#34; alt=&#34;Sampling&#34;&gt;&lt;/p&gt;
&lt;p&gt;\( \tau \) のヒストグラムを確認すると、正しくサンプリングできているようだ。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-julia&#34; data-lang=&#34;julia&#34;&gt;histogram(vec(sim1[&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;, &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;tau, &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;]&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;value), normalize &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;probability, title &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;tau&amp;#34;&lt;/span&gt;, label &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&amp;#34;&lt;/span&gt;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;img src=&#34;https://matsueushi.github.io/images/posts/bayesian-methods-julia-1_hist.png&#34; alt=&#34;Histogram&#34;&gt;&lt;/p&gt;
&lt;p&gt;受信メッセージ数と期待値を表示する。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-julia&#34; data-lang=&#34;julia&#34;&gt;bar(&lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;N&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;, count_data&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;messages, label &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&amp;#34;&lt;/span&gt;, size &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; [&lt;span style=&#34;color:#ae81ff&#34;&gt;600&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;200&lt;/span&gt;],
    linecolor &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;transparent,
    xlabel &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Time (days)&amp;#34;&lt;/span&gt;, ylabel &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Count of messages&amp;#34;&lt;/span&gt;)
plot!(&lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;N&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;, vec(mean(sim1[&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;, &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;lambda, &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;]&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;value, dims&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;[&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;])), linewidth &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;, label &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Expectation&amp;#34;&lt;/span&gt;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;img src=&#34;https://matsueushi.github.io/images/posts/bayesian-methods-julia-1_expect.png&#34; alt=&#34;Expectation&#34;&gt;&lt;/p&gt;
&lt;p&gt;コード: &lt;a href=&#34;https://nbviewer.jupyter.org/github/matsueushi/bayesian_methods_julia/blob/master/chapter1_message.ipynb&#34;&gt;https://nbviewer.jupyter.org/github/matsueushi/bayesian_methods_julia/blob/master/chapter1_message.ipynb&lt;/a&gt;&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Julia版「データ解析のための統計モデリング入門」読書ノート</title>
      <link>https://matsueushi.github.io/posts/julia-kubo/</link>
      <pubDate>Mon, 04 Mar 2019 23:01:57 -0400</pubDate>
      
      <guid>https://matsueushi.github.io/posts/julia-kubo/</guid>
      <description>&lt;p&gt;最近、&lt;a href=&#34;https://www.iwanami.co.jp/book/b257893.html&#34;&gt;久保拓弥「データ解析のための統計モデリング入門――一般化線形モデル・階層ベイズモデル・MCMC (確率と情報の科学)&lt;/a&gt;を読んでいる。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;生態学のデータ解析 - 久保拓弥&lt;br&gt;
&lt;a href=&#34;http://hosho.ees.hokudai.ac.jp/~kubo/ce/KuboTakuya.html&#34;&gt;http://hosho.ees.hokudai.ac.jp/~kubo/ce/KuboTakuya.html&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;本では&lt;a href=&#34;https://www.r-project.org/&#34;&gt;R&lt;/a&gt; + &lt;a href=&#34;https://www.mrc-bsu.cam.ac.uk/software/bugs/the-bugs-project-winbugs/&#34;&gt;WinBUGS&lt;/a&gt;を使っているが、今回は&lt;a href=&#34;https://julialang.org/&#34;&gt;Julia&lt;/a&gt;(1.1.0) + &lt;a href=&#34;https://github.com/brian-j-smith/Mamba.jl&#34;&gt;Mamba&lt;/a&gt;を使って実装した(10章まで)。実装は&lt;a href=&#34;https://github.com/matsueushi/kubo_analysis_julia&#34;&gt;Github&lt;/a&gt;に載せてある。&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;実装の中身は上のJupyter Notebookを見てもらうとして、それ以外に実装していて何点か躓いたことがあったので備忘のために記載しておく。&lt;/p&gt;
&lt;h2 id=&#34;binomial分布のglm&#34;&gt;Binomial分布のGLM&lt;/h2&gt;
&lt;p&gt;  &lt;code&gt;formula&lt;/code&gt; で指定する説明変数は、0から1の間になっている必要がある。個体の数で割って、wtsに個体の数を指定してフィッティングを行う。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-julia&#34; data-lang=&#34;julia&#34;&gt;df&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;yy &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; df&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;y &lt;span style=&#34;color:#f92672&#34;&gt;./&lt;/span&gt; df&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;N
df&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;N &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; convert(&lt;span style=&#34;color:#66d9ef&#34;&gt;Array&lt;/span&gt;{&lt;span style=&#34;color:#66d9ef&#34;&gt;Float64&lt;/span&gt;}, df&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;N)
result &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; glm(&lt;span style=&#34;color:#a6e22e&#34;&gt;@formula&lt;/span&gt;(yy &lt;span style=&#34;color:#f92672&#34;&gt;~&lt;/span&gt; x &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; f), df, Binomial(), wts &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; df&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;N)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;モデルのグラフ表示&#34;&gt;モデルのグラフ表示&lt;/h2&gt;
&lt;p&gt;&lt;a href=&#34;https://mambajl.readthedocs.io/en/release-0.12/tutorial.html#directed-acyclic-graphs&#34;&gt;Mambaのチュートリアル&lt;/a&gt;ではモデルのグラフ表示に&lt;a href=&#34;https://github.com/Keno/GraphViz.jl&#34;&gt;GraphViz.jl&lt;/a&gt;パッケージを使っている。&lt;/p&gt;
&lt;p&gt;ただGraphViz.jlはメンテナンスが止まっているようで、Julia v0.7以降では&lt;a href=&#34;https://github.com/epatters/Catlab.jl/issues/24&#34;&gt;動かないようである&lt;/a&gt;。&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/biaslab/ForneyLab.jl&#34;&gt;ForneyLab.jl&lt;/a&gt;がGraphViz.jlの後継としてモデルのグラフ表示をサポートしているので、こちらを使用すれば良い。&lt;/p&gt;
&lt;h2 id=&#34;multiprocessing&#34;&gt;Multiprocessing&lt;/h2&gt;
&lt;p&gt;Mambaは &lt;code&gt;addproc&lt;/code&gt; でプロセスを追加して、&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-julia&#34; data-lang=&#34;julia&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;using&lt;/span&gt; Distributed
addprocs(&lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Mambaをインポートするときに &lt;code&gt;@everywhere&lt;/code&gt; を付ければMambaが自動的にMCMCのチェインごとのサンプリングを並列化してくれる。(section10.ipynb参照)&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-julia&#34; data-lang=&#34;julia&#34;&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;@everywhere&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;using&lt;/span&gt; Mamba
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;11章の空間構造のある階層ベイズモデル(intrinsic Gaussian CARモデル)も実装できたらアップデートしたい。&lt;/p&gt;
&lt;p&gt;3/14追記: 11章の空間構造のある階層ベイズモデルも実装したのでアップデートした。これで一通り読破したことになるのかな？次は以前読もうとして諦めた「Pythonで体験するベイズ推論」をJuliaでやってみようか。&lt;/p&gt;
</description>
    </item>
    
  </channel>
</rss>