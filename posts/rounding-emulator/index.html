<!DOCTYPE html>
<html lang='en'><head>
  <meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='description' content='Juliaで丸めモードを指定して浮動小数点数の計算をする(したい) で色々とJuliaの丸めモードについて調べていましたが、今回はその続きです。
やはりどうしてもJuliaの Float32 や Float64 に対して上付き丸め、下付き丸めを可能な限り正確に安定して行いたくなったので、 「最近点丸めによる方向付き丸めのエミュレート」を参考に、デフォルトの丸めモードのみを使って上付き丸め、下付き丸めをエミュレートするJuliaのパッケージを作成しました。
RoundingEmulator.jl https://github.com/matsueushi/RoundingEmulator.jl
Registratorにも登録したので、
] add RoundingEmulator でインストールして使えます。
定義されているのは add, sub, mul, div, sqrt に対して上付き丸め _up と下付き丸め _down と2つと非常なシンプルなものです。
julia&gt; using RoundingEmulator julia&gt; add_up(0.1, 0.2) 0.30000000000000004 julia&gt; add_down(0.1, 0.2) 0.3 julia&gt; sub_up(-0.1, 0.2) -0.3 julia&gt; sub_down(-0.1, 0.2) -0.30000000000000004 julia&gt; mul_up(0.1, 0.2) 0.020000000000000004 julia&gt; mul_down(0.1, 0.2) 0.02 julia&gt; div_up(1.0, 3.0) 0.33333333333333337 julia&gt; div_up(1.0, 3.0) 0.33333333333333337 julia&gt; sqrt_up(2.0) 1.4142135623730951 julia&gt; sqrt_down(2.0) 1.414213562373095 https://github.com/JeffreySarnoff/FastRounding.jl/blob/03ff386d36aa7de101f22ca740748a31e57942c0/src/FastRounding.jl#L187-L194 の例も正しく計算できていました。
julia&gt; sqrt_up(3.'>
<meta name='theme-color' content='#ffcd00'>

<meta property='og:title' content='デフォルトの丸めモードで上付き丸め、下付き丸めをエミュレートする(Julia) • matsueushi'>
<meta property='og:description' content='Juliaで丸めモードを指定して浮動小数点数の計算をする(したい) で色々とJuliaの丸めモードについて調べていましたが、今回はその続きです。
やはりどうしてもJuliaの Float32 や Float64 に対して上付き丸め、下付き丸めを可能な限り正確に安定して行いたくなったので、 「最近点丸めによる方向付き丸めのエミュレート」を参考に、デフォルトの丸めモードのみを使って上付き丸め、下付き丸めをエミュレートするJuliaのパッケージを作成しました。
RoundingEmulator.jl https://github.com/matsueushi/RoundingEmulator.jl
Registratorにも登録したので、
] add RoundingEmulator でインストールして使えます。
定義されているのは add, sub, mul, div, sqrt に対して上付き丸め _up と下付き丸め _down と2つと非常なシンプルなものです。
julia&gt; using RoundingEmulator julia&gt; add_up(0.1, 0.2) 0.30000000000000004 julia&gt; add_down(0.1, 0.2) 0.3 julia&gt; sub_up(-0.1, 0.2) -0.3 julia&gt; sub_down(-0.1, 0.2) -0.30000000000000004 julia&gt; mul_up(0.1, 0.2) 0.020000000000000004 julia&gt; mul_down(0.1, 0.2) 0.02 julia&gt; div_up(1.0, 3.0) 0.33333333333333337 julia&gt; div_up(1.0, 3.0) 0.33333333333333337 julia&gt; sqrt_up(2.0) 1.4142135623730951 julia&gt; sqrt_down(2.0) 1.414213562373095 https://github.com/JeffreySarnoff/FastRounding.jl/blob/03ff386d36aa7de101f22ca740748a31e57942c0/src/FastRounding.jl#L187-L194 の例も正しく計算できていました。
julia&gt; sqrt_up(3.'>
<meta property='og:url' content='https://matsueushi.github.io/posts/rounding-emulator/'>
<meta property='og:site_name' content='matsueushi'>
<meta property='og:type' content='article'><meta property='article:section' content='posts'><meta property='article:tag' content='Julia'><meta property='article:tag' content='Rounding'><meta property='article:published_time' content='2020-03-28T18:00:00-04:00'/><meta property='article:modified_time' content='2020-03-28T18:00:00-04:00'/><meta name='twitter:card' content='summary'>

<meta name="generator" content="Hugo 0.60.1" />

  <title>デフォルトの丸めモードで上付き丸め、下付き丸めをエミュレートする(Julia) • matsueushi</title>
  <link rel='canonical' href='https://matsueushi.github.io/posts/rounding-emulator/'>
  
  
  <link rel='icon' href='/favicon.ico'>
<link rel='stylesheet' href='/assets/css/main.6a060eb7.css'><link rel='stylesheet' href='/css/custom.css'><style>
:root{--color-accent:#ffcd00;}
</style>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-141286537-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  

</head>
<body class='page type-posts has-sidebar'>

  <div class='site'><div id='sidebar' class='sidebar'>
  <a class='screen-reader-text' href='#main-menu'>Skip to Main Menu</a>

  <div class='container'><section class='widget widget-about sep-after'>
  <header>
    
    <div class='logo'>
      <a href='/'>
        <img src='/images/ushi.jpg'>
      </a>
    </div>
    
    <h2 class='title site-title '>
      <a href='/'>
      matsueushi
      </a>
    </h2>
    <div class='desc'>
    
    </div>
  </header>

</section>
<section class='widget widget-search sep-after'>
  <header>
    <h4 class='title widget-title'>Search</h4>
  </header>

  <form action='/search' id='search-form' class='search-form'>
    <label>
      <span class='screen-reader-text'>Search</span>
      <input id='search-term' class='search-term' type='search' name='q' placeholder='Search&hellip;'>
    </label></form>

</section>
<section class='widget widget-sidebar_menu sep-after'><nav id='sidebar-menu' class='menu sidebar-menu' aria-label='Sidebar Menu'>
    <div class='container'>
      <ul><li class='item'>
  <a href='/'>Home</a></li><li class='item'>
  <a href='/posts/'>Blog</a></li></ul>
    </div>
  </nav>

</section><section class='widget widget-taxonomy_cloud sep-after'>
  <header>
    <h4 class='title widget-title'>Tags</h4>
  </header>

  <div class='container list-container'>
  <ul class='list taxonomy-cloud'><li>
        <a href='/tags/bayesian/' style='font-size:1.2307692307692308em'>Bayesian</a>
      </li><li>
        <a href='/tags/blackdogproductions/' style='font-size:1em'>BlackDogProductions</a>
      </li><li>
        <a href='/tags/boat/' style='font-size:1em'>BOaT</a>
      </li><li>
        <a href='/tags/cymbals/' style='font-size:1em'>Cymbals</a>
      </li><li>
        <a href='/tags/dcgan/' style='font-size:1em'>DCGAN</a>
      </li><li>
        <a href='/tags/deeplearning/' style='font-size:1em'>DeepLearning</a>
      </li><li>
        <a href='/tags/distribution/' style='font-size:1em'>Distribution</a>
      </li><li>
        <a href='/tags/dtc/' style='font-size:1.0384615384615385em'>DTC</a>
      </li><li>
        <a href='/tags/fitc/' style='font-size:1.0384615384615385em'>FITC</a>
      </li><li>
        <a href='/tags/float/' style='font-size:1em'>Float</a>
      </li><li>
        <a href='/tags/flux/' style='font-size:1.0384615384615385em'>Flux</a>
      </li><li>
        <a href='/tags/gan/' style='font-size:1em'>GAN</a>
      </li><li>
        <a href='/tags/gaussianprocess/' style='font-size:1.1923076923076923em'>GaussianProcess</a>
      </li><li>
        <a href='/tags/gcp/' style='font-size:1em'>GCP</a>
      </li><li>
        <a href='/tags/girls/' style='font-size:1em'>Girls</a>
      </li><li>
        <a href='/tags/glitchpop/' style='font-size:1em'>Glitchpop</a>
      </li><li>
        <a href='/tags/inducingvariablemethod/' style='font-size:1.0384615384615385em'>InducingVariableMethod</a>
      </li><li>
        <a href='/tags/julia/' style='font-size:2em'>Julia</a>
      </li><li>
        <a href='/tags/jupyter/' style='font-size:1.0384615384615385em'>Jupyter</a>
      </li><li>
        <a href='/tags/katex/' style='font-size:1.0384615384615385em'>KaTeX</a>
      </li><li>
        <a href='/tags/kmean/' style='font-size:1em'>KMean</a>
      </li><li>
        <a href='/tags/lolicatonica/' style='font-size:1.0384615384615385em'>LolicaTonica</a>
      </li><li>
        <a href='/tags/macdemarco/' style='font-size:1em'>MacDemarco</a>
      </li><li>
        <a href='/tags/mamba/' style='font-size:1.3461538461538463em'>Mamba</a>
      </li><li>
        <a href='/tags/mcmc/' style='font-size:1em'>MCMC</a>
      </li><li>
        <a href='/tags/ml/' style='font-size:1em'>ML</a>
      </li><li>
        <a href='/tags/mlp/' style='font-size:1.0769230769230769em'>MLP</a>
      </li><li>
        <a href='/tags/mnist/' style='font-size:1em'>MNIST</a>
      </li><li>
        <a href='/tags/music/' style='font-size:1.5em'>Music</a>
      </li><li>
        <a href='/tags/neworder/' style='font-size:1em'>NewOrder</a>
      </li><li>
        <a href='/tags/optim/' style='font-size:1em'>Optim</a>
      </li><li>
        <a href='/tags/oval/' style='font-size:1em'>Oval</a>
      </li><li>
        <a href='/tags/plots/' style='font-size:1em'>Plots</a>
      </li><li>
        <a href='/tags/randomwalk/' style='font-size:1em'>RandomWalk</a>
      </li><li>
        <a href='/tags/record/' style='font-size:1.0384615384615385em'>Record</a>
      </li><li>
        <a href='/tags/rounding/' style='font-size:1.0384615384615385em'>Rounding</a>
      </li><li>
        <a href='/tags/shoegaze/' style='font-size:1em'>Shoegaze</a>
      </li><li>
        <a href='/tags/singan/' style='font-size:1em'>SinGAN</a>
      </li><li>
        <a href='/tags/sod/' style='font-size:1.0384615384615385em'>SoD</a>
      </li><li>
        <a href='/tags/softman/' style='font-size:1em'>Softman</a>
      </li><li>
        <a href='/tags/sor/' style='font-size:1.0384615384615385em'>SoR</a>
      </li><li>
        <a href='/tags/sparseapproximation/' style='font-size:1.0384615384615385em'>SparseApproximation</a>
      </li><li>
        <a href='/tags/sweettrip/' style='font-size:1em'>SweetTrip</a>
      </li><li>
        <a href='/tags/test/' style='font-size:1em'>test</a>
      </li><li>
        <a href='/tags/yubikey/' style='font-size:1em'>YubiKey</a>
      </li><li>
        <a href='/tags/zaningen/' style='font-size:1em'>Zaningen</a>
      </li></ul>
</div>


</section>
</div>

  <div class='sidebar-overlay'></div>
</div><div class='main'><nav id='main-menu' class='menu main-menu' aria-label='Main Menu'>
  <div class='container'>
    <a class='screen-reader-text' href='#content'>Skip to Content</a>

<button id='sidebar-toggler' class='sidebar-toggler' aria-controls='sidebar'>
  <span class='screen-reader-text'>Toggle Sidebar</span>
  <span class='open'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="3" y1="12" x2="21" y2="12" />
  <line x1="3" y1="6" x2="21" y2="6" />
  <line x1="3" y1="18" x2="21" y2="18" />
  
</svg>
</span>
  <span class='close'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="18" y1="6" x2="6" y2="18" />
  <line x1="6" y1="6" x2="18" y2="18" />
  
</svg>
</span>
</button>
    <ul><li class='item'>
        <a href='/'>Home</a>
      </li><li class='item'>
        <a href='/posts/'>Blog</a>
      </li><li class='item'>
        <a href='/about/'>About</a>
      </li><li class='item'>
        <a href='/memo/'>memo</a>
      </li></ul>
  </div>
</nav><div class='header-widgets'>
        <div class='container'>
    
    <style>.widget-breadcrumbs li:after{content:'\2f '}</style>
  <section class='widget widget-breadcrumbs sep-after'>
    <nav id='breadcrumbs'>
      <ol><li><a href='/'>Home</a></li><li><a href='/posts/'>Blog</a></li><li><span>デフォルトの丸めモードで上付き丸め、下付き丸めをエミュレートする(Julia)</span></li></ol>
    </nav>
  </section></div>
      </div>

      <header id='header' class='header site-header'>
        <div class='container sep-after'>
          <div class='header-info'><p class='site-title title'>matsueushi</p><p class='desc site-desc'></p>
          </div>
        </div>
      </header>

      <main id='content'>


<article lang='en' class='entry'>
    <header class='header entry-header'>
  <div class='container sep-after'>
    <div class='header-info'>
      <h1 class='title'>デフォルトの丸めモードで上付き丸め、下付き丸めをエミュレートする(Julia)</h1>
      

    </div>
    <div class='entry-meta'>
  <span class='posted-on'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
  <line x1="16" y1="2" x2="16" y2="6"/>
  <line x1="8" y1="2" x2="8" y2="6"/>
  <line x1="3" y1="10" x2="21" y2="10"/>
  
</svg>
<span class='screen-reader-text'>Posted on </span>
  <time class='entry-date' datetime='2020-03-28T18:00:00-04:00'>2020, Mar 28</time>
</span>

  
  
<span class='reading-time'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <circle cx="12" cy="12" r="10"/>
  <polyline points="12 6 12 12 15 15"/>
  
</svg>
3 mins read
</span>


</div>


  </div>
</header>

    
    

    <div class='container entry-content'>
  <p><a href="../julia-rounding">Juliaで丸めモードを指定して浮動小数点数の計算をする(したい)</a> で色々とJuliaの丸めモードについて調べていましたが、今回はその続きです。</p>
<p>やはりどうしてもJuliaの <code>Float32</code> や <code>Float64</code> に対して上付き丸め、下付き丸めを可能な限り正確に安定して行いたくなったので、
「最近点丸めによる方向付き丸めのエミュレート」を参考に、デフォルトの丸めモードのみを使って上付き丸め、下付き丸めをエミュレートするJuliaのパッケージを作成しました。</p>
<h2 id="roundingemulatorjl">RoundingEmulator.jl</h2>
<p><a href="https://github.com/matsueushi/RoundingEmulator.jl">https://github.com/matsueushi/RoundingEmulator.jl</a></p>
<p>Registratorにも登録したので、</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-julia" data-lang="julia">] add<span style="color:#f92672"></span> RoundingEmulator<span style="color:#f92672"></span>
</code></pre></div><p>でインストールして使えます。</p>
<p>定義されているのは <code>add</code>, <code>sub</code>, <code>mul</code>, <code>div</code>, <code>sqrt</code> に対して上付き丸め <code>_up</code> と下付き丸め <code>_down</code> と2つと非常なシンプルなものです。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-julia" data-lang="julia">julia<span style="color:#f92672"></span><span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">using</span> RoundingEmulator<span style="color:#f92672"></span>

julia<span style="color:#f92672"></span><span style="color:#f92672">&gt;</span> add_up<span style="color:#f92672"></span>(<span style="color:#ae81ff">0.1</span>, <span style="color:#ae81ff">0.2</span>)
<span style="color:#ae81ff">0.30000000000000004</span>

julia<span style="color:#f92672"></span><span style="color:#f92672">&gt;</span> add_down<span style="color:#f92672"></span>(<span style="color:#ae81ff">0.1</span>, <span style="color:#ae81ff">0.2</span>)
<span style="color:#ae81ff">0.3</span>

julia<span style="color:#f92672"></span><span style="color:#f92672">&gt;</span> sub_up<span style="color:#f92672"></span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">0.1</span>, <span style="color:#ae81ff">0.2</span>)
<span style="color:#f92672">-</span><span style="color:#ae81ff">0.3</span>

julia<span style="color:#f92672"></span><span style="color:#f92672">&gt;</span> sub_down<span style="color:#f92672"></span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">0.1</span>, <span style="color:#ae81ff">0.2</span>)
<span style="color:#f92672">-</span><span style="color:#ae81ff">0.30000000000000004</span>

julia<span style="color:#f92672"></span><span style="color:#f92672">&gt;</span> mul_up<span style="color:#f92672"></span>(<span style="color:#ae81ff">0.1</span>, <span style="color:#ae81ff">0.2</span>)
<span style="color:#ae81ff">0.020000000000000004</span>

julia<span style="color:#f92672"></span><span style="color:#f92672">&gt;</span> mul_down<span style="color:#f92672"></span>(<span style="color:#ae81ff">0.1</span>, <span style="color:#ae81ff">0.2</span>)
<span style="color:#ae81ff">0.02</span>

julia<span style="color:#f92672"></span><span style="color:#f92672">&gt;</span> div_up<span style="color:#f92672"></span>(<span style="color:#ae81ff">1.0</span>, <span style="color:#ae81ff">3.0</span>)
<span style="color:#ae81ff">0.33333333333333337</span>

julia<span style="color:#f92672"></span><span style="color:#f92672">&gt;</span> div_up<span style="color:#f92672"></span>(<span style="color:#ae81ff">1.0</span>, <span style="color:#ae81ff">3.0</span>)
<span style="color:#ae81ff">0.33333333333333337</span>

julia<span style="color:#f92672"></span><span style="color:#f92672">&gt;</span> sqrt_up<span style="color:#f92672"></span>(<span style="color:#ae81ff">2.0</span>)
<span style="color:#ae81ff">1.4142135623730951</span>

julia<span style="color:#f92672"></span><span style="color:#f92672">&gt;</span> sqrt_down<span style="color:#f92672"></span>(<span style="color:#ae81ff">2.0</span>)
<span style="color:#ae81ff">1.414213562373095</span>
</code></pre></div><p><a href="https://github.com/JeffreySarnoff/FastRounding.jl/blob/03ff386d36aa7de101f22ca740748a31e57942c0/src/FastRounding.jl#L187-L194">https://github.com/JeffreySarnoff/FastRounding.jl/blob/03ff386d36aa7de101f22ca740748a31e57942c0/src/FastRounding.jl#L187-L194</a> の例も正しく計算できていました。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-julia" data-lang="julia">julia<span style="color:#f92672"></span><span style="color:#f92672">&gt;</span> sqrt_up<span style="color:#f92672"></span>(<span style="color:#ae81ff">3.9036066558023176e-154</span>)
<span style="color:#ae81ff">1.9757547053726885e-77</span>

julia<span style="color:#f92672"></span><span style="color:#f92672">&gt;</span> sqrt_down<span style="color:#f92672"></span>(<span style="color:#ae81ff">3.9036066558023176e-154</span>)
<span style="color:#ae81ff">1.975754705372688e-77</span>
</code></pre></div><p>詳細はレポジトリや <a href="https://matsueushi.github.io/RoundingEmulator.jl/dev/">ドキュメンテーション</a> を参照して下さい。
Issueやプルリクは大歓迎です。</p>
<p>基本的には<a href="http://verifiedby.me/kv/rounding/emu.pdf">「最近点丸めのみによる方向付き丸めのエミュレート」</a>に沿った実装なので、
エミュレートのロジックについてはそちらを参照してください。</p>
<p>これで、上付き丸めや下付き丸めができるようになったので、当初やろうと思っていた区間演算にもチャレンジしてみたいです。</p>
<p>以下は作成していて気づいた点です。</p>
<hr>
<h2 id="add12-mul12"><code>add12</code>, <code>mul12</code></h2>
<p>エクスポートされていない関数ですが、Julia の <a href="https://github.com/JuliaLang/julia/blob/master/base/twiceprecision.jl">base/twiceprecision.jl</a> には
加算、乗算のエラーフリー変換の関数 <code>add12</code> と <code>mul12</code> が定義されています。
前回言及したオーバーフロー対策もなされていました。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-julia" data-lang="julia">julia<span style="color:#f92672"></span><span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">using</span> Base<span style="color:#f92672"></span><span style="color:#f92672">:</span> add12<span style="color:#f92672"></span>, mul12<span style="color:#f92672"></span>

julia<span style="color:#f92672"></span><span style="color:#f92672">&gt;</span> a<span style="color:#f92672"></span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">3.5630624444874539e+307</span>
<span style="color:#ae81ff">3.563062444487454e307</span>

julia<span style="color:#f92672"></span><span style="color:#f92672">&gt;</span> b<span style="color:#f92672"></span> <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1.7976931348623157e+308</span>
<span style="color:#f92672">-</span><span style="color:#ae81ff">1.7976931348623157e308</span>

julia<span style="color:#f92672"></span><span style="color:#f92672">&gt;</span> add12<span style="color:#f92672"></span>(a<span style="color:#f92672"></span>, b<span style="color:#f92672"></span>)
(<span style="color:#f92672">-</span><span style="color:#ae81ff">1.4413868904135704e308</span>, <span style="color:#ae81ff">9.9792015476736e291</span>)

julia<span style="color:#f92672"></span><span style="color:#f92672">&gt;</span> add12<span style="color:#f92672"></span>(b<span style="color:#f92672"></span>, a<span style="color:#f92672"></span>)
(<span style="color:#f92672">-</span><span style="color:#ae81ff">1.4413868904135704e308</span>, <span style="color:#ae81ff">9.9792015476736e291</span>)

julia<span style="color:#f92672"></span><span style="color:#f92672">&gt;</span> a<span style="color:#f92672"></span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">6.929001713869936e+236</span>
<span style="color:#ae81ff">6.929001713869936e236</span>

julia<span style="color:#f92672"></span><span style="color:#f92672">&gt;</span> b<span style="color:#f92672"></span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">2.5944475251952003e+71</span>
<span style="color:#ae81ff">2.5944475251952003e71</span>

julia<span style="color:#f92672"></span><span style="color:#f92672">&gt;</span> mul12<span style="color:#f92672"></span>(a<span style="color:#f92672"></span>, b<span style="color:#f92672"></span>)
(<span style="color:#ae81ff">1.7976931348623157e308</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1.0027614963959625e291</span>)

julia<span style="color:#f92672"></span><span style="color:#f92672">&gt;</span> mul12<span style="color:#f92672"></span>(b<span style="color:#f92672"></span>, a<span style="color:#f92672"></span>)
(<span style="color:#ae81ff">1.7976931348623157e308</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1.0027614963959625e291</span>)
</code></pre></div><h2 id="setroundingraw"><code>setrounding_raw</code></h2>
<p>deprecatedになった <code>setrounding</code> は、強引に</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-julia" data-lang="julia">julia<span style="color:#f92672"></span><span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">using</span> Base<span style="color:#f92672"></span><span style="color:#f92672">.</span>Rounding<span style="color:#f92672"></span><span style="color:#f92672">:</span> setrounding_raw<span style="color:#f92672"></span>, to_fenv<span style="color:#f92672"></span>

julia<span style="color:#f92672"></span><span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0.1</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0.2</span>
<span style="color:#ae81ff">0.30000000000000004</span>

julia<span style="color:#f92672"></span><span style="color:#f92672">&gt;</span> setrounding_raw<span style="color:#f92672"></span>(<span style="color:#66d9ef">Float64</span>, to_fenv<span style="color:#f92672"></span>(RoundDown))
<span style="color:#ae81ff">0</span>

julia<span style="color:#f92672"></span><span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0.1</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0.2</span>
<span style="color:#ae81ff">0.3</span>

julia<span style="color:#f92672"></span><span style="color:#f92672">&gt;</span> setrounding_raw<span style="color:#f92672"></span>(<span style="color:#66d9ef">Float64</span>, to_fenv<span style="color:#f92672"></span>(RoundUp))
<span style="color:#ae81ff">0</span>

julia<span style="color:#f92672"></span><span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0.1</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0.2</span>
<span style="color:#ae81ff">0.30000000000000004</span>

julia<span style="color:#f92672"></span><span style="color:#f92672">&gt;</span> setrounding_raw<span style="color:#f92672"></span>(<span style="color:#66d9ef">Float64</span>, to_fenv<span style="color:#f92672"></span>(RoundNearest))
<span style="color:#ae81ff">0</span>
</code></pre></div><p>と呼び出せば使えて、確実に動くことが保証されていないですが、テストを行うにあたっては、Windows, MacOS, LinuxのCIで
自分で計算した値と、<code>setrounding_raw</code> で丸めモードを変更した時の値が等しくなることを特殊な値
(<code>zero(T)</code>, <code>floatmax(T)</code>, `flaotmin(T) など)とランダムにサンプリングした値に対して確かめる、
という方法を現在は取っています。</p>
<p>確実に正しいことがわかっている入力と出力のペアからテストを作成するのが一番良いと思うのですが、今回はそこまでやっていません。</p>
<h2 id="signed-zero">Signed zero</h2>
<p>符号付きゼロもの符号も含めて正確に再現する場合、下付き丸めによる加算の定義で注意する必要があります。
これは
上付き丸めによる加算は</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-julia" data-lang="julia"><span style="color:#66d9ef">function</span> add_up<span style="color:#f92672"></span>(a<span style="color:#f92672"></span>, b<span style="color:#f92672"></span>)
    x<span style="color:#f92672"></span>, y<span style="color:#f92672"></span> <span style="color:#f92672">=</span> add12<span style="color:#f92672"></span>(a<span style="color:#f92672"></span>, b<span style="color:#f92672"></span>)
    <span style="color:#66d9ef">if</span> isinf<span style="color:#f92672"></span>(x<span style="color:#f92672"></span>)
        ifelse<span style="color:#f92672"></span>(x<span style="color:#f92672"></span> <span style="color:#f92672">=</span><span style="color:#f92672">=</span> typemin<span style="color:#f92672"></span>(x<span style="color:#f92672"></span>) <span style="color:#f92672">&amp;&amp;</span> isfinite<span style="color:#f92672"></span>(a<span style="color:#f92672"></span>) <span style="color:#f92672">&amp;&amp;</span> isfinite<span style="color:#f92672"></span>(b<span style="color:#f92672"></span>), <span style="color:#f92672">-</span>floatmax<span style="color:#f92672"></span>(x<span style="color:#f92672"></span>), x<span style="color:#f92672"></span>)
    <span style="color:#66d9ef">else</span>
        y<span style="color:#f92672"></span> <span style="color:#f92672">&gt;</span> zero<span style="color:#f92672"></span>(y<span style="color:#f92672"></span>) <span style="color:#f92672">?</span> nextfloat<span style="color:#f92672"></span>(x<span style="color:#f92672"></span>) <span style="color:#f92672">:</span> x<span style="color:#f92672"></span>
    <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">end</span>
</code></pre></div><p>と定義できますが、下付きの丸めに関しては、0どうしの計算を行った際に符号を変える必要があります。
IEEE 754の6.3章に下付き丸め(roundTowardNegative)の時のみ、exact zero sumは-0になると書いてあります。
ただ、\(x + x\) の符号は \(x\) の符号と同じになるので、表にすると、</p>
<table>
<thead>
<tr>
<th>Rounding</th>
<th>\((+0)+(+0)\)</th>
<th>\((-0)+(+0)\)</th>
<th>\((+0)+(-0)\)</th>
<th>\((-0)+(-0)\)</th>
</tr>
</thead>
<tbody>
<tr>
<td>roundTiesToEven (<code>RoundNearest</code>)</td>
<td>\(+0\)</td>
<td>\(+0\)</td>
<td>\(+0\)</td>
<td>\(-0\)</td>
</tr>
<tr>
<td>roundTowardPositive (<code>RoundUp</code>)</td>
<td>\(+0\)</td>
<td>\(+0\)</td>
<td>\(+0\)</td>
<td>\(-0\)</td>
</tr>
<tr>
<td>roundTowardNegative (<code>RoundDown</code>)</td>
<td>\(+0\)</td>
<td>\(-0\)</td>
<td>\(-0\)</td>
<td>\(-0\)</td>
</tr>
</tbody>
</table>
<p>このようになります。よって、下のように修正します。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-julia" data-lang="julia"><span style="color:#66d9ef">function</span> add_down<span style="color:#f92672"></span>(a<span style="color:#f92672"></span>, b<span style="color:#f92672"></span>)
    x<span style="color:#f92672"></span>, y<span style="color:#f92672"></span> <span style="color:#f92672">=</span> add12<span style="color:#f92672"></span>(a<span style="color:#f92672"></span>, b<span style="color:#f92672"></span>)
    <span style="color:#66d9ef">if</span> isinf<span style="color:#f92672"></span>(x<span style="color:#f92672"></span>)
        ifelse<span style="color:#f92672"></span>(x<span style="color:#f92672"></span> <span style="color:#f92672">=</span><span style="color:#f92672">=</span> typemax<span style="color:#f92672"></span>(x<span style="color:#f92672"></span>) <span style="color:#f92672">&amp;&amp;</span> isfinite<span style="color:#f92672"></span>(a<span style="color:#f92672"></span>) <span style="color:#f92672">&amp;&amp;</span> isfinite<span style="color:#f92672"></span>(b<span style="color:#f92672"></span>), floatmax<span style="color:#f92672"></span>(x<span style="color:#f92672"></span>), x<span style="color:#f92672"></span>)
    <span style="color:#66d9ef">elseif</span> y<span style="color:#f92672"></span> <span style="color:#f92672">&lt;</span> zero<span style="color:#f92672"></span>(y<span style="color:#f92672"></span>)
        prevfloat<span style="color:#f92672"></span>(x<span style="color:#f92672"></span>)
    <span style="color:#66d9ef">else</span>
        ifelse<span style="color:#f92672"></span>(iszero<span style="color:#f92672"></span>(x<span style="color:#f92672"></span>) <span style="color:#f92672">&amp;&amp;</span> (signbit<span style="color:#f92672"></span>(a<span style="color:#f92672"></span>) <span style="color:#f92672">||</span> signbit<span style="color:#f92672"></span>(b<span style="color:#f92672"></span>)), <span style="color:#f92672">-</span>zero<span style="color:#f92672"></span>(x<span style="color:#f92672"></span>), x<span style="color:#f92672"></span>)
    <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">end</span>
</code></pre></div><p>こうすることで、正しく計算できています。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-julia" data-lang="julia">julia<span style="color:#f92672"></span><span style="color:#f92672">&gt;</span> add_up<span style="color:#f92672"></span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">0.0</span>, <span style="color:#ae81ff">0.0</span>)
<span style="color:#ae81ff">0.0</span>

julia<span style="color:#f92672"></span><span style="color:#f92672">&gt;</span> add_down<span style="color:#f92672"></span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">0.0</span>, <span style="color:#ae81ff">0.0</span>)
<span style="color:#f92672">-</span><span style="color:#ae81ff">0.0</span>

julia<span style="color:#f92672"></span><span style="color:#f92672">&gt;</span> add_up<span style="color:#f92672"></span>(<span style="color:#ae81ff">0.0</span>, <span style="color:#ae81ff">0.0</span>)
<span style="color:#ae81ff">0.0</span>

julia<span style="color:#f92672"></span><span style="color:#f92672">&gt;</span> add_down<span style="color:#f92672"></span>(<span style="color:#ae81ff">0.0</span>, <span style="color:#ae81ff">0.0</span>)
<span style="color:#ae81ff">0.0</span>

julia<span style="color:#f92672"></span><span style="color:#f92672">&gt;</span> add_up<span style="color:#f92672"></span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">0.0</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">0.0</span>)
<span style="color:#f92672">-</span><span style="color:#ae81ff">0.0</span>

julia<span style="color:#f92672"></span><span style="color:#f92672">&gt;</span> add_down<span style="color:#f92672"></span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">0.0</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">0.0</span>)
<span style="color:#f92672">-</span><span style="color:#ae81ff">0.0</span>
</code></pre></div><h2 id="heading">浮動小数点数をランダムにサンプリングする</h2>
<p>全ての浮動小数点数から一様にサンプリングしたい時、<code>rand</code> を普通に呼び出すと \([0, 1)\) から一様にサンプリングされます。
<a href="https://docs.julialang.org/en/v1/stdlib/Random/index.html#Random-Numbers-1">https://docs.julialang.org/en/v1/stdlib/Random/index.html#Random-Numbers-1</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-julia" data-lang="julia">julia<span style="color:#f92672"></span><span style="color:#f92672">&gt;</span> rand<span style="color:#f92672"></span>(<span style="color:#66d9ef">Float64</span>, <span style="color:#ae81ff">10</span>)
<span style="color:#ae81ff">10</span><span style="color:#f92672">-</span>element<span style="color:#f92672"></span> <span style="color:#66d9ef">Array</span>{<span style="color:#66d9ef">Float64</span>,<span style="color:#ae81ff">1</span>}<span style="color:#f92672">:</span>
 <span style="color:#ae81ff">0.6021596191997549</span>
 <span style="color:#ae81ff">0.8268352152178551</span>
 <span style="color:#ae81ff">0.22765811638234856</span>
 <span style="color:#ae81ff">0.3813150107932535</span>
 <span style="color:#ae81ff">0.49112818878735265</span>
 <span style="color:#ae81ff">0.6424070543287013</span>
 <span style="color:#ae81ff">0.27970019663531676</span>
 <span style="color:#ae81ff">0.7316980433063847</span>
 <span style="color:#ae81ff">0.5721143543965341</span>
 <span style="color:#ae81ff">0.24735574564535145</span>
</code></pre></div><p><code>Int64</code> 用の <code>rand</code> を使って乱数を発生させ、<code>reinterpret</code> で <code>Float64</code> に変換すれば良いです。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-julia" data-lang="julia">julia<span style="color:#f92672"></span><span style="color:#f92672">&gt;</span> x<span style="color:#f92672"></span> <span style="color:#f92672">=</span> rand<span style="color:#f92672"></span>(<span style="color:#66d9ef">Int64</span>)
<span style="color:#ae81ff">7738226609100433883</span>

julia<span style="color:#f92672"></span><span style="color:#f92672">&gt;</span> bitstring<span style="color:#f92672"></span>(x<span style="color:#f92672"></span>)
<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">0</span><span style="color:#e6db74">1</span><span style="color:#e6db74">1</span><span style="color:#e6db74">0</span><span style="color:#e6db74">1</span><span style="color:#e6db74">0</span><span style="color:#e6db74">1</span><span style="color:#e6db74">1</span><span style="color:#e6db74">0</span><span style="color:#e6db74">1</span><span style="color:#e6db74">1</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">1</span><span style="color:#e6db74">1</span><span style="color:#e6db74">1</span><span style="color:#e6db74">0</span><span style="color:#e6db74">1</span><span style="color:#e6db74">1</span><span style="color:#e6db74">0</span><span style="color:#e6db74">1</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">1</span><span style="color:#e6db74">1</span><span style="color:#e6db74">0</span><span style="color:#e6db74">1</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">1</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">1</span><span style="color:#e6db74">0</span><span style="color:#e6db74">1</span><span style="color:#e6db74">1</span><span style="color:#e6db74">1</span><span style="color:#e6db74">0</span><span style="color:#e6db74">1</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">1</span><span style="color:#e6db74">0</span><span style="color:#e6db74">1</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">1</span><span style="color:#e6db74">1</span><span style="color:#e6db74">1</span><span style="color:#e6db74">0</span><span style="color:#e6db74">1</span><span style="color:#e6db74">1</span><span style="color:#e6db74">0</span><span style="color:#e6db74">1</span><span style="color:#e6db74">1</span><span style="color:#e6db74">&#34;</span>

julia<span style="color:#f92672"></span><span style="color:#f92672">&gt;</span> y<span style="color:#f92672"></span> <span style="color:#f92672">=</span> reinterpret<span style="color:#f92672"></span>(<span style="color:#66d9ef">Float64</span>, x<span style="color:#f92672"></span>)
<span style="color:#ae81ff">2.0242815034259582e209</span>

julia<span style="color:#f92672"></span><span style="color:#f92672">&gt;</span> bitstring<span style="color:#f92672"></span>(y<span style="color:#f92672"></span>)
<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">0</span><span style="color:#e6db74">1</span><span style="color:#e6db74">1</span><span style="color:#e6db74">0</span><span style="color:#e6db74">1</span><span style="color:#e6db74">0</span><span style="color:#e6db74">1</span><span style="color:#e6db74">1</span><span style="color:#e6db74">0</span><span style="color:#e6db74">1</span><span style="color:#e6db74">1</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">1</span><span style="color:#e6db74">1</span><span style="color:#e6db74">1</span><span style="color:#e6db74">0</span><span style="color:#e6db74">1</span><span style="color:#e6db74">1</span><span style="color:#e6db74">0</span><span style="color:#e6db74">1</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">1</span><span style="color:#e6db74">1</span><span style="color:#e6db74">0</span><span style="color:#e6db74">1</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">1</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">1</span><span style="color:#e6db74">0</span><span style="color:#e6db74">1</span><span style="color:#e6db74">1</span><span style="color:#e6db74">1</span><span style="color:#e6db74">0</span><span style="color:#e6db74">1</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">1</span><span style="color:#e6db74">0</span><span style="color:#e6db74">1</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">1</span><span style="color:#e6db74">1</span><span style="color:#e6db74">1</span><span style="color:#e6db74">0</span><span style="color:#e6db74">1</span><span style="color:#e6db74">1</span><span style="color:#e6db74">0</span><span style="color:#e6db74">1</span><span style="color:#e6db74">1</span><span style="color:#e6db74">&#34;</span>
</code></pre></div><p>細かいことを言うと <code>NaN</code>, <code>Inf</code> なども含まれてしまいますが、今回は特別扱いはせずそのまま使っています。</p>
<h2 id="-vs-isequal"><code>==</code> vs <code>isequal</code></h2>
<p>Julia で<a href="https://docs.julialang.org/en/v1/stdlib/Test/index.html">ユニットテスト</a>を書くとき、</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-julia" data-lang="julia"><span style="color:#a6e22e">@test</span><span style="color:#f92672"></span> f<span style="color:#f92672"></span>(x<span style="color:#f92672"></span>) <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">1.0</span>
</code></pre></div><p>のように書くことが多いのですが、浮動小数点数のテストの際、<code>NaN</code> や符号付きゼロなどをテストしたい場合は注意が必要です。まず、</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-julia" data-lang="julia">julia<span style="color:#f92672"></span><span style="color:#f92672">&gt;</span> NaN <span style="color:#f92672">=</span><span style="color:#f92672">=</span> NaN
<span style="color:#66d9ef">false</span>
</code></pre></div><p>です。また、IEEE 754で定められている符号付きゼロ <code>-0.0</code> と <code>0.0</code> は</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-julia" data-lang="julia">julia<span style="color:#f92672"></span><span style="color:#f92672">&gt;</span> bitstring<span style="color:#f92672"></span>(<span style="color:#ae81ff">0.0</span>)
<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">&#34;</span>

julia<span style="color:#f92672"></span><span style="color:#f92672">&gt;</span> bitstring<span style="color:#f92672"></span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">0.0</span>)
<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">1</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">0</span><span style="color:#e6db74">&#34;</span>
</code></pre></div><p>と異なるビット列が対応していますが、<code>==</code> では</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-julia" data-lang="julia">julia<span style="color:#f92672"></span><span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0.0</span> <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">0.0</span>
<span style="color:#66d9ef">true</span>
</code></pre></div><p>となるのでこの二つの違いは判別できません。
そのため、<code>setrounding</code> をエミュレートできているかをテストする際には、<code>isequal</code> を使いました。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-julia" data-lang="julia">julia<span style="color:#f92672"></span><span style="color:#f92672">&gt;</span> isequal<span style="color:#f92672"></span>(<span style="color:#ae81ff">1.0</span>, <span style="color:#ae81ff">3.0</span>)
<span style="color:#66d9ef">false</span>

julia<span style="color:#f92672"></span><span style="color:#f92672">&gt;</span> isequal<span style="color:#f92672"></span>(<span style="color:#ae81ff">1.0</span>, <span style="color:#ae81ff">1.0</span>)
<span style="color:#66d9ef">true</span>

julia<span style="color:#f92672"></span><span style="color:#f92672">&gt;</span> isequal<span style="color:#f92672"></span>(<span style="color:#ae81ff">0.0</span>, <span style="color:#ae81ff">0.0</span>)
<span style="color:#66d9ef">true</span>

julia<span style="color:#f92672"></span><span style="color:#f92672">&gt;</span> isequal<span style="color:#f92672"></span>(<span style="color:#ae81ff">0.0</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">0.0</span>)
<span style="color:#66d9ef">false</span>

julia<span style="color:#f92672"></span><span style="color:#f92672">&gt;</span> isequal<span style="color:#f92672"></span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">0.0</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">0.0</span>)
<span style="color:#66d9ef">true</span>

julia<span style="color:#f92672"></span><span style="color:#f92672">&gt;</span> isequal<span style="color:#f92672"></span>(NaN, NaN)
<span style="color:#66d9ef">true</span>
</code></pre></div><h2 id="setzerosubnormals"><code>set_zero_subnormals</code></h2>
<p>なかなか変更することは少ないとは思われますが、Juliaには非正規化数が0に変換されることを許容することで計算を高速化する(かもしれない)設定が存在します。</p>
<p><a href="https://docs.julialang.org/en/v1/base/numbers/#Base.Rounding.set_zero_subnormals">Base.Rounding.set_zero_subnormals</a><br>
<a href="https://docs.julialang.org/en/v1/base/numbers/#Base.Rounding.get_zero_subnormals">Base.Rounding.get_zero_subnormals</a></p>
<p>上付き丸め、下付き丸めが必要となっている今回のような状況では当然オフになっている必要があります。</p>

  <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-show-count="false">Tweet</a>
  <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
</div>
    
<footer class='entry-footer'>
  <div class='container sep-before'><div class='tags'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M20.59,13.41l-7.17,7.17a2,2,0,0,1-2.83,0L2,12V2H12l8.59,8.59A2,2,0,0,1,20.59,13.41Z"/>
  <line x1="7" y1="7" x2="7" y2="7"/>
  
</svg>
<span class='screen-reader-text'>Tags: </span><a class='tag' href='/tags/julia/'>Julia</a>, <a class='tag' href='/tags/rounding/'>Rounding</a></div>

  </div>
</footer>


</article>
<div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "matsueushi-github-io" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

<nav class='entry-nav'>
  <div class='container'><div class='prev-entry sep-before'>
      <a href='/posts/julia-rounding/'>
        <span aria-hidden='true'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="20" y1="12" x2="4" y2="12"/>
  <polyline points="10 18 4 12 10 6"/>
  
</svg>
 Previous</span>
        <span class='screen-reader-text'>Previous post: </span>Juliaで丸めモードを指定して浮動小数点数の計算をする(したい)</a>
    </div></div>
</nav>



      </main>

      <footer id='footer' class='footer'>
        <div class='container sep-before'><section class='widget widget-social_menu sep-after'><nav aria-label='Social Menu'>
    <ul><li>
        <a href='https://github.com/matsueushi' target='_blank' rel='noopener'>
          <span class='screen-reader-text'>Open Github account in new tab</span><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
  
</svg>
</a>
      </li><li>
        <a href='https://twitter.com/matsue_ushi' target='_blank' rel='noopener'>
          <span class='screen-reader-text'>Open Twitter account in new tab</span><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>
  
</svg>
</a>
      </li><li>
        <a href='mailto:matsueushi@gmail.com' target='_blank' rel='noopener'>
          <span class='screen-reader-text'>Contact via Email</span><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
  <polyline points="22,6 12,13 2,6"/>
  
</svg>
</a>
      </li></ul>
  </nav>
</section><div class='copyright'>
  <p> &copy; 2019-2020 matsueushi </p>
</div>

        </div>
      </footer>

    </div>
  </div><script>window.__assets_js_src="/assets/js/"</script>

<script src='/assets/js/main.67d669ac.js'></script><script src='/js/custom.js'></script><link rel='stylesheet' href='//cdn.jsdelivr.net/npm/katex@0.10.2/dist/katex.min.css'>
<script src='//cdn.jsdelivr.net/npm/katex@0.10.2/dist/katex.min.js'></script>
<script src='//cdn.jsdelivr.net/npm/katex@0.10.2/dist/contrib/auto-render.min.js'></script>

<script type='text/javascript'>
  renderMathInElement(document.querySelector('.entry-content'),{});
</script>

</body>

</html>
