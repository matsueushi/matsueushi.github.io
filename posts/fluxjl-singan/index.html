<!DOCTYPE html>
<html lang='en'><head>
  <meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='description' content='今回は、Juliaの機械学習フレームワークFlux.jlでSinGAN(一部)を実装して、1枚のアルバムジャケット画像からアニメーションを作成します。結構長いです。
きっかけは、この紹介記事です。
【SinGAN】たった１枚の画像から多様な画像生成タスクが可能に
実はDCGANをFlux.jlで実装したあと、MNISTの画像では味気ないので自分でデータセットを作成して画像の自動生成を試みていましたが、 ダブりなく大量の画像を収集してデータセットを整備するのは骨が折れ、今一つの結果しか出なかったのでお蔵入りにしていました。
しかしながら、SinGAN記事に関する読んでみると驚いたことにSinGANではたった1枚の画像から超解像化やアニメーション生成が行え、 ハイスペックのGPUを回さなくても結果が得られるということで実装に挑戦したくなりました。
一部実装を簡略化したので、論文の著者による実装を完全に再現できたわけではないのでご了承ください。 間違っている点・改善すべき点はご指摘頂けると幸いです。
環境 実行環境はJulia v1.3.0 &#43; Flux.jl v0.10.0 で、GCPのGPU環境(K80)です。
前回と同様、Dockerによる環境構築ですが、JuliaのパッケージもDockerfileに含めてしまっていた前回と違い、 今回はDockerファイルはcudaのベースイメージ&#43;Juliaのシンプルな構成として、Juliaのパッケージ管理はJuliaのプロジェクト機能を用いました。
参考にしたのは主に下記のページです。
Julia でのパッケージの作り方
Julia v1.0 でユニットテスト
SinGANのモデルの概略 理論的な部分の詳細は、論文 SinGAN: Learning a Generative Model from a Single Natural Image や 解説記事 に詳しいのでそちらを見ていただきたいのですが、モデルの概要を簡単に説明しておきます。
論文とは別に公開されている Supplementary Material はハイパーパラメーターや画像のパディング、アニメーションのノイズマップの作り方などが掲載されていて参考になります。
  SinGAN’s multi-scale pipeline, retrieved from SinGAN: Learning a Generative Model from a Single Natural Image
  SinGANの学習は、ピラミッド型の構造になっていて、下のステージから順々に学習を行います。 最初は、小さい画像サイズで全体の構造を学習し、ステージを上がっていくごとに画像サイズを拡大していき、微細な構造を学習します。 各ステージでは通常のGANのようにGeneratorとDiscriminatorを並行して学習させていきます。
GeneratorやDiscriminatorのネットワークは、特段難しい構成をしているわけではなく、 Conv(3x3)-BatchNorm-LeakyLeRU(0.2) を5層重ねて最後の活性化関数を Generator だったら tanh, Discriminator だったら identity に変えたConvolutional netがベースとなります。 Discriminator はこれで完成で、Generator はもう一手間必要です。'>
<meta name='theme-color' content='#ffcd00'>

<meta property='og:title' content='Flux.jlでSinGANを実装する • matsueushi'>
<meta property='og:description' content='今回は、Juliaの機械学習フレームワークFlux.jlでSinGAN(一部)を実装して、1枚のアルバムジャケット画像からアニメーションを作成します。結構長いです。
きっかけは、この紹介記事です。
【SinGAN】たった１枚の画像から多様な画像生成タスクが可能に
実はDCGANをFlux.jlで実装したあと、MNISTの画像では味気ないので自分でデータセットを作成して画像の自動生成を試みていましたが、 ダブりなく大量の画像を収集してデータセットを整備するのは骨が折れ、今一つの結果しか出なかったのでお蔵入りにしていました。
しかしながら、SinGAN記事に関する読んでみると驚いたことにSinGANではたった1枚の画像から超解像化やアニメーション生成が行え、 ハイスペックのGPUを回さなくても結果が得られるということで実装に挑戦したくなりました。
一部実装を簡略化したので、論文の著者による実装を完全に再現できたわけではないのでご了承ください。 間違っている点・改善すべき点はご指摘頂けると幸いです。
環境 実行環境はJulia v1.3.0 &#43; Flux.jl v0.10.0 で、GCPのGPU環境(K80)です。
前回と同様、Dockerによる環境構築ですが、JuliaのパッケージもDockerfileに含めてしまっていた前回と違い、 今回はDockerファイルはcudaのベースイメージ&#43;Juliaのシンプルな構成として、Juliaのパッケージ管理はJuliaのプロジェクト機能を用いました。
参考にしたのは主に下記のページです。
Julia でのパッケージの作り方
Julia v1.0 でユニットテスト
SinGANのモデルの概略 理論的な部分の詳細は、論文 SinGAN: Learning a Generative Model from a Single Natural Image や 解説記事 に詳しいのでそちらを見ていただきたいのですが、モデルの概要を簡単に説明しておきます。
論文とは別に公開されている Supplementary Material はハイパーパラメーターや画像のパディング、アニメーションのノイズマップの作り方などが掲載されていて参考になります。
  SinGAN’s multi-scale pipeline, retrieved from SinGAN: Learning a Generative Model from a Single Natural Image
  SinGANの学習は、ピラミッド型の構造になっていて、下のステージから順々に学習を行います。 最初は、小さい画像サイズで全体の構造を学習し、ステージを上がっていくごとに画像サイズを拡大していき、微細な構造を学習します。 各ステージでは通常のGANのようにGeneratorとDiscriminatorを並行して学習させていきます。
GeneratorやDiscriminatorのネットワークは、特段難しい構成をしているわけではなく、 Conv(3x3)-BatchNorm-LeakyLeRU(0.2) を5層重ねて最後の活性化関数を Generator だったら tanh, Discriminator だったら identity に変えたConvolutional netがベースとなります。 Discriminator はこれで完成で、Generator はもう一手間必要です。'>
<meta property='og:url' content='https://matsueushi.github.io/posts/fluxjl-singan/'>
<meta property='og:site_name' content='matsueushi'>
<meta property='og:type' content='article'><meta property='article:section' content='posts'><meta property='article:tag' content='Julia'><meta property='article:tag' content='DeepLearning'><meta property='article:tag' content='Flux'><meta property='article:tag' content='SinGAN'><meta property='article:tag' content='GAN'><meta property='article:published_time' content='2020-01-12T01:00:00-05:00'/><meta property='article:modified_time' content='2020-01-12T01:00:00-05:00'/><meta name='twitter:card' content='summary'>

<meta name="generator" content="Hugo 0.60.1" />

  <title>Flux.jlでSinGANを実装する • matsueushi</title>
  <link rel='canonical' href='https://matsueushi.github.io/posts/fluxjl-singan/'>
  
  
  <link rel='icon' href='/favicon.ico'>
<link rel='stylesheet' href='/assets/css/main.6a060eb7.css'><link rel='stylesheet' href='/css/custom.css'><style>
:root{--color-accent:#ffcd00;}
</style>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-141286537-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  

</head>
<body class='page type-posts has-sidebar'>

  <div class='site'><div id='sidebar' class='sidebar'>
  <a class='screen-reader-text' href='#main-menu'>Skip to Main Menu</a>

  <div class='container'><section class='widget widget-about sep-after'>
  <header>
    
    <div class='logo'>
      <a href='/'>
        <img src='/images/ushi.jpg'>
      </a>
    </div>
    
    <h2 class='title site-title '>
      <a href='/'>
      matsueushi
      </a>
    </h2>
    <div class='desc'>
    
    </div>
  </header>

</section>
<section class='widget widget-search sep-after'>
  <header>
    <h4 class='title widget-title'>Search</h4>
  </header>

  <form action='/search' id='search-form' class='search-form'>
    <label>
      <span class='screen-reader-text'>Search</span>
      <input id='search-term' class='search-term' type='search' name='q' placeholder='Search&hellip;'>
    </label></form>

</section>
<section class='widget widget-sidebar_menu sep-after'><nav id='sidebar-menu' class='menu sidebar-menu' aria-label='Sidebar Menu'>
    <div class='container'>
      <ul><li class='item'>
  <a href='/'>Home</a></li><li class='item'>
  <a href='/posts/'>Blog</a></li></ul>
    </div>
  </nav>

</section><section class='widget widget-taxonomy_cloud sep-after'>
  <header>
    <h4 class='title widget-title'>Tags</h4>
  </header>

  <div class='container list-container'>
  <ul class='list taxonomy-cloud'><li>
        <a href='/tags/bayesian/' style='font-size:1.2307692307692308em'>Bayesian</a>
      </li><li>
        <a href='/tags/blackdogproductions/' style='font-size:1em'>BlackDogProductions</a>
      </li><li>
        <a href='/tags/boat/' style='font-size:1em'>BOaT</a>
      </li><li>
        <a href='/tags/cymbals/' style='font-size:1em'>Cymbals</a>
      </li><li>
        <a href='/tags/dcgan/' style='font-size:1em'>DCGAN</a>
      </li><li>
        <a href='/tags/deeplearning/' style='font-size:1em'>DeepLearning</a>
      </li><li>
        <a href='/tags/distribution/' style='font-size:1em'>Distribution</a>
      </li><li>
        <a href='/tags/dtc/' style='font-size:1.0384615384615385em'>DTC</a>
      </li><li>
        <a href='/tags/fitc/' style='font-size:1.0384615384615385em'>FITC</a>
      </li><li>
        <a href='/tags/float/' style='font-size:1em'>Float</a>
      </li><li>
        <a href='/tags/flux/' style='font-size:1.0384615384615385em'>Flux</a>
      </li><li>
        <a href='/tags/gan/' style='font-size:1em'>GAN</a>
      </li><li>
        <a href='/tags/gaussianprocess/' style='font-size:1.1923076923076923em'>GaussianProcess</a>
      </li><li>
        <a href='/tags/gcp/' style='font-size:1em'>GCP</a>
      </li><li>
        <a href='/tags/girls/' style='font-size:1em'>Girls</a>
      </li><li>
        <a href='/tags/glitchpop/' style='font-size:1em'>Glitchpop</a>
      </li><li>
        <a href='/tags/inducingvariablemethod/' style='font-size:1.0384615384615385em'>InducingVariableMethod</a>
      </li><li>
        <a href='/tags/julia/' style='font-size:2em'>Julia</a>
      </li><li>
        <a href='/tags/jupyter/' style='font-size:1.0384615384615385em'>Jupyter</a>
      </li><li>
        <a href='/tags/katex/' style='font-size:1.0384615384615385em'>KaTeX</a>
      </li><li>
        <a href='/tags/kmean/' style='font-size:1em'>KMean</a>
      </li><li>
        <a href='/tags/lolicatonica/' style='font-size:1.0384615384615385em'>LolicaTonica</a>
      </li><li>
        <a href='/tags/macdemarco/' style='font-size:1em'>MacDemarco</a>
      </li><li>
        <a href='/tags/mamba/' style='font-size:1.3461538461538463em'>Mamba</a>
      </li><li>
        <a href='/tags/mcmc/' style='font-size:1em'>MCMC</a>
      </li><li>
        <a href='/tags/ml/' style='font-size:1em'>ML</a>
      </li><li>
        <a href='/tags/mlp/' style='font-size:1.0769230769230769em'>MLP</a>
      </li><li>
        <a href='/tags/mnist/' style='font-size:1em'>MNIST</a>
      </li><li>
        <a href='/tags/music/' style='font-size:1.5em'>Music</a>
      </li><li>
        <a href='/tags/neworder/' style='font-size:1em'>NewOrder</a>
      </li><li>
        <a href='/tags/optim/' style='font-size:1em'>Optim</a>
      </li><li>
        <a href='/tags/oval/' style='font-size:1em'>Oval</a>
      </li><li>
        <a href='/tags/plots/' style='font-size:1em'>Plots</a>
      </li><li>
        <a href='/tags/randomwalk/' style='font-size:1em'>RandomWalk</a>
      </li><li>
        <a href='/tags/record/' style='font-size:1.0384615384615385em'>Record</a>
      </li><li>
        <a href='/tags/rounding/' style='font-size:1.0384615384615385em'>Rounding</a>
      </li><li>
        <a href='/tags/shoegaze/' style='font-size:1em'>Shoegaze</a>
      </li><li>
        <a href='/tags/singan/' style='font-size:1em'>SinGAN</a>
      </li><li>
        <a href='/tags/sod/' style='font-size:1.0384615384615385em'>SoD</a>
      </li><li>
        <a href='/tags/softman/' style='font-size:1em'>Softman</a>
      </li><li>
        <a href='/tags/sor/' style='font-size:1.0384615384615385em'>SoR</a>
      </li><li>
        <a href='/tags/sparseapproximation/' style='font-size:1.0384615384615385em'>SparseApproximation</a>
      </li><li>
        <a href='/tags/sweettrip/' style='font-size:1em'>SweetTrip</a>
      </li><li>
        <a href='/tags/test/' style='font-size:1em'>test</a>
      </li><li>
        <a href='/tags/yubikey/' style='font-size:1em'>YubiKey</a>
      </li><li>
        <a href='/tags/zaningen/' style='font-size:1em'>Zaningen</a>
      </li></ul>
</div>


</section>
</div>

  <div class='sidebar-overlay'></div>
</div><div class='main'><nav id='main-menu' class='menu main-menu' aria-label='Main Menu'>
  <div class='container'>
    <a class='screen-reader-text' href='#content'>Skip to Content</a>

<button id='sidebar-toggler' class='sidebar-toggler' aria-controls='sidebar'>
  <span class='screen-reader-text'>Toggle Sidebar</span>
  <span class='open'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="3" y1="12" x2="21" y2="12" />
  <line x1="3" y1="6" x2="21" y2="6" />
  <line x1="3" y1="18" x2="21" y2="18" />
  
</svg>
</span>
  <span class='close'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="18" y1="6" x2="6" y2="18" />
  <line x1="6" y1="6" x2="18" y2="18" />
  
</svg>
</span>
</button>
    <ul><li class='item'>
        <a href='/'>Home</a>
      </li><li class='item'>
        <a href='/posts/'>Blog</a>
      </li><li class='item'>
        <a href='/about/'>About</a>
      </li><li class='item'>
        <a href='/memo/'>memo</a>
      </li></ul>
  </div>
</nav><div class='header-widgets'>
        <div class='container'>
    
    <style>.widget-breadcrumbs li:after{content:'\2f '}</style>
  <section class='widget widget-breadcrumbs sep-after'>
    <nav id='breadcrumbs'>
      <ol><li><a href='/'>Home</a></li><li><a href='/posts/'>Blog</a></li><li><span>Flux.jlでSinGANを実装する</span></li></ol>
    </nav>
  </section></div>
      </div>

      <header id='header' class='header site-header'>
        <div class='container sep-after'>
          <div class='header-info'><p class='site-title title'>matsueushi</p><p class='desc site-desc'></p>
          </div>
        </div>
      </header>

      <main id='content'>


<article lang='en' class='entry'>
    <header class='header entry-header'>
  <div class='container sep-after'>
    <div class='header-info'>
      <h1 class='title'>Flux.jlでSinGANを実装する</h1>
      

    </div>
    <div class='entry-meta'>
  <span class='posted-on'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
  <line x1="16" y1="2" x2="16" y2="6"/>
  <line x1="8" y1="2" x2="8" y2="6"/>
  <line x1="3" y1="10" x2="21" y2="10"/>
  
</svg>
<span class='screen-reader-text'>Posted on </span>
  <time class='entry-date' datetime='2020-01-12T01:00:00-05:00'>2020, Jan 12</time>
</span>

  
  
<span class='reading-time'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <circle cx="12" cy="12" r="10"/>
  <polyline points="12 6 12 12 15 15"/>
  
</svg>
8 mins read
</span>


</div>


  </div>
</header>

    
    

    <div class='container entry-content'>
  <p>今回は、Juliaの機械学習フレームワークFlux.jlでSinGAN(一部)を実装して、1枚のアルバムジャケット画像からアニメーションを作成します。結構長いです。</p>
<p>きっかけは、この紹介記事です。<br>
<a href="https://qiita.com/kuto/items/ff2a30ca939ffdcd3cc1">【SinGAN】たった１枚の画像から多様な画像生成タスクが可能に</a></p>
<p>実は<a href="../fluxjl-dcgan/">DCGANをFlux.jlで実装</a>したあと、MNISTの画像では味気ないので自分でデータセットを作成して画像の自動生成を試みていましたが、
ダブりなく大量の画像を収集してデータセットを整備するのは骨が折れ、今一つの結果しか出なかったのでお蔵入りにしていました。</p>
<p>しかしながら、SinGAN記事に関する読んでみると驚いたことにSinGANではたった1枚の画像から超解像化やアニメーション生成が行え、
ハイスペックのGPUを回さなくても結果が得られるということで実装に挑戦したくなりました。</p>
<p>一部実装を簡略化したので、論文の著者による実装を完全に再現できたわけではないのでご了承ください。
間違っている点・改善すべき点はご指摘頂けると幸いです。</p>
<h2 id="heading">環境</h2>
<p>実行環境はJulia v1.3.0 + Flux.jl v0.10.0 で、GCPのGPU環境(K80)です。</p>
<p>前回と同様、Dockerによる環境構築ですが、JuliaのパッケージもDockerfileに含めてしまっていた前回と違い、
今回はDockerファイルはcudaのベースイメージ+Juliaのシンプルな構成として、Juliaのパッケージ管理はJuliaのプロジェクト機能を用いました。</p>
<p>参考にしたのは主に下記のページです。<br>
<a href="https://qiita.com/cometscome_phys/items/989389db3540ebd9e026">Julia でのパッケージの作り方</a><br>
<a href="https://qiita.com/antimon2/items/5222f4f773bf1944b745">Julia v1.0 でユニットテスト</a></p>
<h2 id="singan">SinGANのモデルの概略</h2>
<p>理論的な部分の詳細は、論文 <a href="https://arxiv.org/abs/1905.01164">SinGAN: Learning a Generative Model from a Single Natural Image</a> や <a href="https://qiita.com/kuto/items/ff2a30ca939ffdcd3cc1">解説記事</a> に詳しいのでそちらを見ていただきたいのですが、モデルの概要を簡単に説明しておきます。</p>
<p>論文とは別に公開されている <a href="https://tomer.net.technion.ac.il/files/2019/09/SingleImageGan_SM.pdf">Supplementary Material</a> はハイパーパラメーターや画像のパディング、アニメーションのノイズマップの作り方などが掲載されていて参考になります。</p>
<figure>
    <img src="/images/posts/fluxjl-singan_pipeline.png"
         alt="SinGAN’s multi-scale pipeline, retrieved from SinGAN: Learning a Generative Model from a Single Natural Image"/> <figcaption>
            <p>SinGAN’s multi-scale pipeline, retrieved from <a href="https://arxiv.org/abs/1905.01164">SinGAN: Learning a Generative Model from a Single Natural Image</a></p>
        </figcaption>
</figure>

<p>SinGANの学習は、ピラミッド型の構造になっていて、下のステージから順々に学習を行います。
最初は、小さい画像サイズで全体の構造を学習し、ステージを上がっていくごとに画像サイズを拡大していき、微細な構造を学習します。
各ステージでは通常のGANのようにGeneratorとDiscriminatorを並行して学習させていきます。</p>
<p>GeneratorやDiscriminatorのネットワークは、特段難しい構成をしているわけではなく、
Conv(3x3)-BatchNorm-LeakyLeRU(0.2) を5層重ねて最後の活性化関数を Generator だったら <code>tanh</code>,
Discriminator だったら <code>identity</code> に変えたConvolutional netがベースとなります。
Discriminator はこれで完成で、Generator はもう一手間必要です。</p>
<figure>
    <img src="/images/posts/fluxjl-singan_single.png"
         alt="Single Scale Generation, retrieved from SinGAN: Learning a Generative Model from a Single Natural Image"/> <figcaption>
            <p>Single Scale Generation, retrieved from <a href="https://arxiv.org/abs/1905.01164">SinGAN: Learning a Generative Model from a Single Natural Image</a></p>
        </figcaption>
</figure>

<p>Generatorの場合、入力には下層のステップで生成された画像+ノイズを与え、
Convolutional net で生成された結果にもう一度下層の生成画像を加えて出力とします。</p>
<p>論文では Generator \( G_n \) は \(z_n \) をノイズ、\(\tilde{x}_n\) を第 \(n\) 段階の出力画像,
\( \uparrow^r\) をスケール \(r\) 倍の画像拡大とした時に、</p>
<p>$$
\begin{aligned}
\tilde{x}_N &amp;= G_N(z_N), \\
\tilde{x}_n &amp;= G_n(z_n, (\tilde{x}_{n+1})\uparrow^r), n &lt; N
\end{aligned}
$$
で、Fully convolutional net を \(\psi\) とした時に、</p>
<p>$$
\begin{aligned}
G(x, z) = (x)\uparrow^r + \psi(z + (x)\uparrow^r)
\end{aligned}
$$</p>
<p>と言っています。実際は一段階前の画像に0パディングを行う(こともある)のでもう少し複雑になりますがあとで説明します。</p>
<p>損失関数ですが、各ステージで
$$
\begin{aligned}
\min_{G_n} \min_{D_n} ( \mathcal{L}_{\text{adv}}(G_n, D_n) + \alpha \mathcal{L}_{\text{rec}}(G_n) )
\end{aligned}
$$
を考えるのですが、\(\mathcal{L}_{\text{adv}}\) が Adversarial loss と呼ばれている通常の GAN の損失関数で、
計算するときは全てのステージでノイズを加えながら生成します。
\(\mathcal{L}_{\text{rec}}\) は Reconstruction loss で、最初以外は全てゼロとなる特定のノイズ
$$
\begin{aligned}
z^{\text{rec}} = \{z_N^{\text{rec}}, z_{N-1}^{\text{rec}}, \ldots, z_0^{\text{rec}}\} = \{z^*, 0, \ldots, 0 \}
\end{aligned}
$$
を一つ学習を通して固定し、縮小した元画像との二乗誤差
$$
\begin{aligned}
\mathcal{L}_{\text{rec}, N} &amp;= || G_N(z^*) - x_N ||^2, \\
\mathcal{L}_{\text{rec}, n} &amp;= || G_n(0, (\tilde{x}_{n+1}^{\text{rec}})\uparrow^r) - x_n ||^2, n&lt;N
\end{aligned}
$$
を損失関数とするものです。</p>
<p>読んでいて一つ疑問に思ったのが出力データの値域です。
モデルでは、画像データを各数値が \( [-1,1] \) の範囲に収まる <code>Array</code> として表現しているのですが、
Convolutional Netで <code>tanh</code> を適用した段階では \( [-1,1] \) の範囲に収まるものの、
そのあと元の画像を足したらはみ出ることはあり得ます。
ロス関数による制約条件があるため大丈夫なのかもしれませんが……</p>
<h2 id="heading1">実装開始</h2>
<p>公式実装の <a href="https://github.com/tamarott/SinGAN">tamarott/SinGAN</a> をベースに、他の実装
<a href="https://github.com/FriedRonaldo/SinGAN">FriedRonaldo/SinGAN</a> も時たま参考にしながらやっていきます。</p>
<p>全部説明するのは大変なので、ポイントに絞って説明します。パッケージは先に色々インポートしておきます。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-julia" data-lang="julia"><span style="color:#66d9ef">using</span> Adapt<span style="color:#f92672"></span>
<span style="color:#66d9ef">using</span> BSON<span style="color:#f92672"></span><span style="color:#f92672">:</span> <span style="color:#a6e22e">@load</span><span style="color:#f92672"></span>, <span style="color:#a6e22e">@save</span><span style="color:#f92672"></span>
<span style="color:#66d9ef">using</span> CuArrays<span style="color:#f92672"></span>
<span style="color:#66d9ef">using</span> Flux<span style="color:#f92672"></span>
<span style="color:#66d9ef">using</span> Flux<span style="color:#f92672"></span><span style="color:#f92672">:</span> mse<span style="color:#f92672"></span>, pullback<span style="color:#f92672"></span>, glorot_normal<span style="color:#f92672"></span>
<span style="color:#66d9ef">using</span> Flux<span style="color:#f92672"></span><span style="color:#f92672">.</span>Optimise<span style="color:#f92672"></span><span style="color:#f92672">:</span> update!<span style="color:#f92672"></span>
<span style="color:#66d9ef">using</span> JSON<span style="color:#f92672"></span>
<span style="color:#66d9ef">using</span> OrderedCollections<span style="color:#f92672"></span>
<span style="color:#66d9ef">using</span> Random<span style="color:#f92672"></span>
<span style="color:#66d9ef">using</span> Statistics<span style="color:#f92672"></span>
</code></pre></div><h3 id="0">配列の0、乱数埋め</h3>
<p>役立つ関数をいくつか定義しておきます。</p>
<p>Convolutional Layerに対するFlux.jlの入力データは WHCN の順の array であり、
今回はカラー画像を使うのでチャンネル数は3(アルファチャンネルがないものを今回は使います), バッチサイズは1なので、画像サイズから array のサイズを計算する関数 <code>expand_dim</code> を下のように定義します。</p>
<p>あとは与えた配列と同じ型 (CPU 環境だったら <code>Array</code>, GPU 環境だと <code>CuArray</code>) で0や乱数で埋めた配列が欲しくなることがあるので、そのための関数も用意します。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-julia" data-lang="julia">expand_dim<span style="color:#f92672"></span>(dim<span style="color:#f92672"></span><span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>) <span style="color:#f92672">=</span> (dim<span style="color:#f92672"></span><span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">1</span>)
zeros_like<span style="color:#f92672"></span>(T<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">Type</span>, dims<span style="color:#f92672"></span><span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>) <span style="color:#f92672">=</span> fill!<span style="color:#f92672"></span>(similar<span style="color:#f92672"></span>(T<span style="color:#f92672"></span>, dims<span style="color:#f92672"></span><span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>), <span style="color:#ae81ff">0f0</span>)
zeros_like<span style="color:#f92672"></span>(xs<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">AbstractArray</span>, dims<span style="color:#f92672"></span><span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>) <span style="color:#f92672">=</span> fill!<span style="color:#f92672"></span>(similar<span style="color:#f92672"></span>(xs<span style="color:#f92672"></span>, dims<span style="color:#f92672"></span><span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>), <span style="color:#ae81ff">0f0</span>)
randn_like<span style="color:#f92672"></span>(T<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">Type</span>, dims<span style="color:#f92672"></span><span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>) <span style="color:#f92672">=</span> randn!<span style="color:#f92672"></span>(similar<span style="color:#f92672"></span>(T<span style="color:#f92672"></span>, dims<span style="color:#f92672"></span><span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>))
randn_like<span style="color:#f92672"></span>(xs<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">AbstractArray</span>, dims<span style="color:#f92672"></span><span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>) <span style="color:#f92672">=</span> randn!<span style="color:#f92672"></span>(similar<span style="color:#f92672"></span>(xs<span style="color:#f92672"></span>, dims<span style="color:#f92672"></span><span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>))
</code></pre></div><p>Flux.jl では <code>gpu</code> という関数が定義されていて、この関数は CUDA 環境が有効な時に限り オブジェクト (<code>Array</code> など) を CUDA 用のオブジェクト (<code>CuArray</code> など) にコンバートします。(CUDA 環境が有効でない時は何もしません)。逆に <code>Array</code> に変換を行う <code>cpu</code> という関数も存在します。</p>
<p>普通に <code>zeros</code> や <code>randn</code> を使って <code>gpu</code> で変換してもいいのですが、
Juliaだと関数は型安定である方がいいと言われているので、出力の型が環境に応じて変化する <code>gpu</code> を毎回使うのを防ぐために <code>zeros_like</code> と <code>randn_like</code> を定義しました。</p>
<p>気になって変換方法について色々試してみたのですが、やはり <code>similar!</code> を使うのが良いのではないかと思います。 <a href="https://gist.github.com/matsueushi/be3071f6b6be040dd7ae9e51cf74b1e5">https://gist.github.com/matsueushi/be3071f6b6be040dd7ae9e51cf74b1e5</a></p>
<h3 id="heading2">画像サイズの計算</h3>
<p>最下層の画像のサイズ <code>min_size</code> からスタートして、サイズを縦横 <code>scale</code> 倍することを繰り返して最終的なサイズ <code>image_size</code> に拡大していく関数を作ります。
100層も学習することはないと思うので下のような形になっています。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-julia" data-lang="julia"><span style="color:#66d9ef">function</span> size_pyramid<span style="color:#f92672"></span>(scale<span style="color:#f92672"></span>, min_size<span style="color:#f92672"></span>, image_size<span style="color:#f92672"></span>)
    current_size<span style="color:#f92672"></span> <span style="color:#f92672">=</span> min_size<span style="color:#f92672"></span> 
    pyramid<span style="color:#f92672"></span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">Vector</span>{<span style="color:#66d9ef">Tuple</span>{<span style="color:#66d9ef">Int64</span>,<span style="color:#66d9ef">Int64</span>}}()
    <span style="color:#66d9ef">for</span> i<span style="color:#f92672"></span> <span style="color:#66d9ef">in</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">100</span>
        push!<span style="color:#f92672"></span>(pyramid<span style="color:#f92672"></span>, current_size<span style="color:#f92672"></span>)
        current_size<span style="color:#f92672"></span> <span style="color:#f92672">=</span><span style="color:#f92672">=</span> image_size<span style="color:#f92672"></span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#66d9ef">break</span>
        current_size<span style="color:#f92672"></span> <span style="color:#f92672">=</span> <span style="color:#960050;background-color:#1e0010">@</span><span style="color:#f92672">.</span> floor<span style="color:#f92672"></span>(<span style="color:#66d9ef">Int64</span>, min_size<span style="color:#f92672"></span> <span style="color:#f92672">*</span> scale<span style="color:#f92672"></span><span style="color:#f92672">^</span>i<span style="color:#f92672"></span>)
        current_size<span style="color:#f92672"></span> <span style="color:#f92672">=</span> min<span style="color:#f92672"></span><span style="color:#f92672">.</span>(current_size<span style="color:#f92672"></span>, image_size<span style="color:#f92672"></span>)
    <span style="color:#66d9ef">end</span>
    <span style="color:#66d9ef">return</span> pyramid<span style="color:#f92672"></span>
<span style="color:#66d9ef">end</span>
</code></pre></div><p>中間の Conv 層のチャンネル数は 32 からスタートしてピラミッドを 4 階上がるごとに 2 倍になりますが、128でキャップをかけておきます。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-julia" data-lang="julia">channel_pyramid<span style="color:#f92672"></span>(n_stage<span style="color:#f92672"></span>) <span style="color:#f92672">=</span> min<span style="color:#f92672"></span><span style="color:#f92672">.</span>(map<span style="color:#f92672"></span>(s<span style="color:#f92672"></span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#ae81ff">32</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">^</span>(floor<span style="color:#f92672"></span>(<span style="color:#66d9ef">Int64</span>, s<span style="color:#f92672"></span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">4</span>)), <span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>n_stage<span style="color:#f92672"></span>), <span style="color:#ae81ff">128</span>)
</code></pre></div><h3 id="heading3">画像の拡大、パディング</h3>
<p>画像を <code>image_shape</code> の大きさに拡大したあと、周囲を <code>padded_shape</code> の大きさになるまで0で埋める関数を作ります。</p>
<p>Supplimental Material の &ldquo;Boundary conditions and the effect of padding&rdquo; を見ると
Conv 層における0埋めにより画像の四隅の多様性が失われるが、Generator に入力するノイズの周辺をノイズでパディングする
(つまり、ノイズ画像の方を大きくする)と軽減されるということなので、今回アニメーションをさせることを考えて0埋めをすることにしました。</p>
<p>そのため
$$
\begin{aligned}
G(x, z) = (x)\uparrow^r + \psi(z + (x)\uparrow^r)
\end{aligned}
$$
は少し修正が必要になります。\(z\) は \((x)\uparrow^r\) よりも 四方が幅 \(d\) だけ大きいように毎回取るようにして、
\(\langle \rangle_d\) を幅 \(d\) の0パディング,  \(\rangle \langle_d\) を幅 \(d\) のトリミングとすると、実際にやることは</p>
<p>$$
\begin{aligned}
G(x, z) &amp;= \rangle(\bar{x} + \psi(z + \bar{x}))\langle_d, \\
\bar{x} &amp;= \langle(x)\uparrow^r\rangle_d
\end{aligned}
$$
です。定義するのは \(\langle(\cdot)\uparrow^r\rangle_d\) の部分です。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-julia" data-lang="julia"><span style="color:#66d9ef">function</span> resize_and_padding<span style="color:#f92672"></span>(x<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">Array</span>{<span style="color:#66d9ef">Float32</span>,<span style="color:#ae81ff">4</span>}, 
            image_shape<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">Tuple</span>{<span style="color:#66d9ef">Int64</span>,<span style="color:#66d9ef">Int64</span>}, padded_shape<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">Tuple</span>{<span style="color:#66d9ef">Int64</span>,<span style="color:#66d9ef">Int64</span>})
    <span style="color:#75715e"># println(size(x), image_shape, padded_shape)</span>
    x_large<span style="color:#f92672"></span> <span style="color:#f92672">=</span> imresize<span style="color:#f92672"></span>(view<span style="color:#f92672"></span>(x<span style="color:#f92672"></span>, <span style="color:#f92672">:</span>, <span style="color:#f92672">:</span>, <span style="color:#f92672">:</span>, <span style="color:#ae81ff">1</span>), image_shape<span style="color:#f92672"></span><span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>)
    xx<span style="color:#f92672"></span> <span style="color:#f92672">=</span> zeros<span style="color:#f92672"></span>(<span style="color:#66d9ef">Float32</span>, expand_dim<span style="color:#f92672"></span>(padded_shape<span style="color:#f92672"></span><span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>))
    pad1<span style="color:#f92672"></span>, pad2<span style="color:#f92672"></span> <span style="color:#f92672">=</span> (<span style="color:#960050;background-color:#1e0010">@</span><span style="color:#f92672">.</span> (padded_shape<span style="color:#f92672"></span> <span style="color:#f92672">-</span> image_shape<span style="color:#f92672"></span>) <span style="color:#f92672">÷</span> <span style="color:#ae81ff">2</span>)[<span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">2</span>]
    xx<span style="color:#f92672"></span>[<span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> pad1<span style="color:#f92672"></span><span style="color:#f92672">:</span>image_shape<span style="color:#f92672"></span>[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">+</span> pad1<span style="color:#f92672"></span>, <span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> pad2<span style="color:#f92672"></span><span style="color:#f92672">:</span>image_shape<span style="color:#f92672"></span>[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">+</span> pad2<span style="color:#f92672"></span>, <span style="color:#f92672">:</span> , <span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> x_large<span style="color:#f92672"></span>
    <span style="color:#66d9ef">return</span> xx<span style="color:#f92672"></span>
<span style="color:#66d9ef">end</span>

<span style="color:#66d9ef">function</span> resize_and_padding<span style="color:#f92672"></span>(x<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span>CuArray<span style="color:#f92672"></span>{<span style="color:#66d9ef">Float32</span>,<span style="color:#ae81ff">4</span>}, 
            image_shape<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">Tuple</span>{<span style="color:#66d9ef">Int64</span>,<span style="color:#66d9ef">Int64</span>}, padded_shape<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">Tuple</span>{<span style="color:#66d9ef">Int64</span>,<span style="color:#66d9ef">Int64</span>})
    <span style="color:#66d9ef">return</span> cu<span style="color:#f92672"></span>(resize_and_padding<span style="color:#f92672"></span>(adapt<span style="color:#f92672"></span>(<span style="color:#66d9ef">Array</span>{<span style="color:#66d9ef">Float32</span>}, x<span style="color:#f92672"></span>), image_shape<span style="color:#f92672"></span>, padded_shape<span style="color:#f92672"></span>))
<span style="color:#66d9ef">end</span>
</code></pre></div><p>関数を <code>Array</code> と <code>CuArray</code> で分けているのは、 画像を拡大するImages.jlの <code>imresize</code> を使うと <code>GPU arrays</code> のスカラー操作が極めて遅いと警告が出るためです。
<a href="https://github.com/JuliaGPU/GPUArrays.jl/blob/master/src/indexing.jl#L16">https://github.com/JuliaGPU/GPUArrays.jl/blob/master/src/indexing.jl#L16</a>
<code>CuArray</code> の場合は一旦 <code>Array</code> に変換して拡大とパディングを行い、 <code>CuArray</code> に戻していますが効果のほどは不明です。</p>
<p>あとあと各ステージの画像サイズに合わせて元画像を縮小した \( x_n \) が必要になります。これを一気に作れる関数を用意します。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-julia" data-lang="julia"><span style="color:#66d9ef">function</span> build_image_pyramid<span style="color:#f92672"></span>(img<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">AbstractArray</span>, image_shapes<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">Vector</span>{<span style="color:#66d9ef">Tuple</span>{<span style="color:#66d9ef">Int64</span>,<span style="color:#66d9ef">Int64</span>}}, noise_shapes<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">Vector</span>{<span style="color:#66d9ef">Tuple</span>{<span style="color:#66d9ef">Int64</span>,<span style="color:#66d9ef">Int64</span>}})
    <span style="color:#66d9ef">return</span> map<span style="color:#f92672"></span>((is<span style="color:#f92672"></span>, ns<span style="color:#f92672"></span>)<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>resize_and_padding<span style="color:#f92672"></span>(img<span style="color:#f92672"></span>, is<span style="color:#f92672"></span>, ns<span style="color:#f92672"></span>), image_shapes<span style="color:#f92672"></span>, noise_shapes<span style="color:#f92672"></span>)
<span style="color:#66d9ef">end</span>
</code></pre></div><h3 id="heading4">ノイズの作成</h3>
<p>Adversarial loss と Reconstuction loss を計算する時に使うノイズ \(z^{\text{adv}}, z^{\text{rec}}\) をそれぞれ計算する関数
<code>build_noise_pyramid</code> と <code>build_rec_pyramid</code> を生成します。</p>
<p>学習の状況に応じてステージごとにノイズの分散は変化するので、調節が行えるようにします。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-julia" data-lang="julia"><span style="color:#66d9ef">function</span> build_zero_pyramid<span style="color:#f92672"></span>(xs<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">AbstractArray</span>, shapes<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">Vector</span>{<span style="color:#66d9ef">Tuple</span>{<span style="color:#66d9ef">Int64</span>,<span style="color:#66d9ef">Int64</span>}})
    <span style="color:#66d9ef">return</span> map<span style="color:#f92672"></span>(s<span style="color:#f92672"></span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>zeros_like<span style="color:#f92672"></span>(xs<span style="color:#f92672"></span>, expand_dim<span style="color:#f92672"></span>(s<span style="color:#f92672"></span><span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>)), shapes<span style="color:#f92672"></span>)
<span style="color:#66d9ef">end</span>

<span style="color:#66d9ef">function</span> build_noise_pyramid<span style="color:#f92672"></span>(xs<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">AbstractArray</span>, shapes<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">Vector</span>{<span style="color:#66d9ef">Tuple</span>{<span style="color:#66d9ef">Int64</span>,<span style="color:#66d9ef">Int64</span>}}, amplifiers<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">Vector</span>{<span style="color:#66d9ef">Float32</span>})
    <span style="color:#66d9ef">return</span> map<span style="color:#f92672"></span>((s<span style="color:#f92672"></span>, a<span style="color:#f92672"></span>)<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>a<span style="color:#f92672"></span> <span style="color:#f92672">*</span> randn_like<span style="color:#f92672"></span>(xs<span style="color:#f92672"></span>, expand_dim<span style="color:#f92672"></span>(s<span style="color:#f92672"></span><span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>)), shapes<span style="color:#f92672"></span>, amplifiers<span style="color:#f92672"></span>)
<span style="color:#66d9ef">end</span>

<span style="color:#66d9ef">function</span> build_rec_pyramid<span style="color:#f92672"></span>(xs<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">AbstractArray</span>, shapes<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">Vector</span>{<span style="color:#66d9ef">Tuple</span>{<span style="color:#66d9ef">Int64</span>,<span style="color:#66d9ef">Int64</span>}}, amplifier<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">Float32</span>)
    v<span style="color:#f92672"></span> <span style="color:#f92672">=</span> build_zero_pyramid<span style="color:#f92672"></span>(xs<span style="color:#f92672"></span>, shapes<span style="color:#f92672"></span>)
    randn!<span style="color:#f92672"></span>(v<span style="color:#f92672"></span>[<span style="color:#ae81ff">1</span>])
    v<span style="color:#f92672"></span>[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">*=</span> amplifier<span style="color:#f92672"></span>
    <span style="color:#66d9ef">return</span> v<span style="color:#f92672"></span>
<span style="color:#66d9ef">end</span>
</code></pre></div><h3 id="convolutional-block">Convolutional block</h3>
<p>Discriminator, Generator の準備として、Convolutional block \(\psi\) から作っていきます。</p>
<p>このような感じで Discriminator, Generator のどちらも使える <code>build_layers</code> を定義しておきます。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-julia" data-lang="julia"><span style="color:#75715e"># Re-define leakyrelu function</span>
<span style="color:#75715e"># https://github.com/FluxML/Flux.jl/issues/963</span>
myleakyrelu<span style="color:#f92672"></span>(x<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">Real</span>, a<span style="color:#f92672"></span> <span style="color:#f92672">=</span> oftype<span style="color:#f92672"></span>(x<span style="color:#f92672"></span> <span style="color:#f92672">/</span> one<span style="color:#f92672"></span>(x<span style="color:#f92672"></span>), <span style="color:#ae81ff">0.01</span>)) <span style="color:#f92672">=</span> max<span style="color:#f92672"></span>(a<span style="color:#f92672"></span> <span style="color:#f92672">*</span> x<span style="color:#f92672"></span>, x<span style="color:#f92672"></span> <span style="color:#f92672">/</span> one<span style="color:#f92672"></span>(x<span style="color:#f92672"></span>))

conv_block<span style="color:#f92672"></span>(<span style="color:#66d9ef">in</span>, out<span style="color:#f92672"></span>) <span style="color:#f92672">=</span> [
        Conv<span style="color:#f92672"></span>((<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">3</span>), <span style="color:#66d9ef">in</span> <span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span> out<span style="color:#f92672"></span>; init<span style="color:#f92672"></span> <span style="color:#f92672">=</span> glorot_normal<span style="color:#f92672"></span>, pad<span style="color:#f92672"></span> <span style="color:#f92672">=</span> (<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>)),
        BatchNorm<span style="color:#f92672"></span>(out<span style="color:#f92672"></span>),
        x<span style="color:#f92672"></span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>myleakyrelu<span style="color:#f92672"></span><span style="color:#f92672">.</span>(x<span style="color:#f92672"></span>, <span style="color:#ae81ff">0.2f0</span>)
    ]

<span style="color:#66d9ef">function</span> build_layers<span style="color:#f92672"></span>(n_layers<span style="color:#f92672"></span>, in_chs<span style="color:#f92672"></span>, conv_chs<span style="color:#f92672"></span>, out_chs<span style="color:#f92672"></span>, σ<span style="color:#f92672"></span>)
    layers<span style="color:#f92672"></span> <span style="color:#f92672">=</span> conv_block<span style="color:#f92672"></span>(in_chs<span style="color:#f92672"></span>, conv_chs<span style="color:#f92672"></span>)
    <span style="color:#66d9ef">for</span> _<span style="color:#f92672"></span> <span style="color:#66d9ef">in</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>n_layers<span style="color:#f92672"></span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">2</span>
        push!<span style="color:#f92672"></span>(layers<span style="color:#f92672"></span>, conv_block<span style="color:#f92672"></span>(conv_chs<span style="color:#f92672"></span>, conv_chs<span style="color:#f92672"></span>)<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>)
    <span style="color:#66d9ef">end</span>
    tail_layer<span style="color:#f92672"></span> <span style="color:#f92672">=</span> Conv<span style="color:#f92672"></span>((<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">3</span>), conv_chs<span style="color:#f92672"></span> <span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span> out_chs<span style="color:#f92672"></span>, σ<span style="color:#f92672"></span>;
        init<span style="color:#f92672"></span> <span style="color:#f92672">=</span> glorot_normal<span style="color:#f92672"></span>, pad<span style="color:#f92672"></span> <span style="color:#f92672">=</span> (<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>))
    push!<span style="color:#f92672"></span>(layers<span style="color:#f92672"></span>, tail_layer<span style="color:#f92672"></span>)
    <span style="color:#66d9ef">return</span> Chain<span style="color:#f92672"></span>(layers<span style="color:#f92672"></span><span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>)
<span style="color:#66d9ef">end</span>
</code></pre></div><p><code>leakyrelu</code> は NNlib.jl で定義されているので Flux.jl で使えますが、
<code>Float32</code> の数値における (Zygote.jlの) 微分が <code>Float64</code> になってしまうので自分で定義します。<br>
<a href="https://github.com/FluxML/Flux.jl/issues/963">https://github.com/FluxML/Flux.jl/issues/963</a><br>
<a href="https://github.com/FluxML/Flux.jl/issues/979">https://github.com/FluxML/Flux.jl/issues/979</a></p>
<p>NNlib.jlに投げたこのプルリクがマージされたら定義し直す必要がなくなる予定です。(CuArrays.jl も修正する必要があるかもしれませんが……)
<a href="https://github.com/FluxML/NNlib.jl/pull/149">https://github.com/FluxML/NNlib.jl/pull/149</a></p>
<h3 id="discriminator-generator">Discriminator, Generator</h3>
<p>いよいよ Discriminator, Generator の定義です。
簡単な Discriminator から作ります。DiscriminatorPyramid に関しては、単に Discriminator を複数個集めて来ただけです。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-julia" data-lang="julia"><span style="color:#e6db74">&#34;&#34;&#34;</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74"> </span><span style="color:#e6db74"> </span><span style="color:#e6db74"> </span><span style="color:#e6db74"> </span><span style="color:#e6db74">D</span><span style="color:#e6db74">i</span><span style="color:#e6db74">s</span><span style="color:#e6db74">c</span><span style="color:#e6db74">r</span><span style="color:#e6db74">i</span><span style="color:#e6db74">m</span><span style="color:#e6db74">i</span><span style="color:#e6db74">n</span><span style="color:#e6db74">a</span><span style="color:#e6db74">t</span><span style="color:#e6db74">o</span><span style="color:#e6db74">r</span><span style="color:#e6db74">P</span><span style="color:#e6db74">y</span><span style="color:#e6db74">r</span><span style="color:#e6db74">a</span><span style="color:#e6db74">m</span><span style="color:#e6db74">i</span><span style="color:#e6db74">d</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;&#34;&#34;</span>
<span style="color:#66d9ef">mutable</span> <span style="color:#66d9ef">struct</span> DiscriminatorPyramid<span style="color:#f92672"></span>{T<span style="color:#f92672"></span> <span style="color:#f92672">&lt;</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">Tuple</span>}
    chains<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span>T<span style="color:#f92672"></span>
    DiscriminatorPyramid<span style="color:#f92672"></span>(xs<span style="color:#f92672"></span><span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>) <span style="color:#f92672">=</span> new<span style="color:#f92672"></span>{typeof<span style="color:#f92672"></span>(xs<span style="color:#f92672"></span>)}(xs<span style="color:#f92672"></span>)
<span style="color:#66d9ef">end</span>

build_single_discriminator<span style="color:#f92672"></span>(n_layers<span style="color:#f92672"></span>, conv_chs<span style="color:#f92672"></span>) <span style="color:#f92672">=</span> build_layers<span style="color:#f92672"></span>(n_layers<span style="color:#f92672"></span>, <span style="color:#ae81ff">3</span>, conv_chs<span style="color:#f92672"></span>, <span style="color:#ae81ff">1</span>, identity<span style="color:#f92672"></span>)

<span style="color:#66d9ef">function</span> DiscriminatorPyramid<span style="color:#f92672"></span>(n_stage<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">Integer</span>, n_layers<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">Integer</span>)
    ds<span style="color:#f92672"></span> <span style="color:#f92672">=</span> build_single_discriminator<span style="color:#f92672"></span><span style="color:#f92672">.</span>(n_layers<span style="color:#f92672"></span>, channel_pyramid<span style="color:#f92672"></span>(n_stage<span style="color:#f92672"></span>))
    <span style="color:#66d9ef">return</span> DiscriminatorPyramid<span style="color:#f92672"></span>(gpu<span style="color:#f92672"></span><span style="color:#f92672">.</span>(ds<span style="color:#f92672"></span>)<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>)
<span style="color:#66d9ef">end</span>

<span style="color:#66d9ef">function</span> DiscriminatorPyramid<span style="color:#f92672"></span>(image_shapes<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">Vector</span>{<span style="color:#66d9ef">Tuple</span>{<span style="color:#66d9ef">Int64</span>,<span style="color:#66d9ef">Int64</span>}}, n_layers<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">Integer</span>)
    DiscriminatorPyramid<span style="color:#f92672"></span>(Base<span style="color:#f92672"></span><span style="color:#f92672">.</span>length<span style="color:#f92672"></span>(image_shapes<span style="color:#f92672"></span>), n_layers<span style="color:#f92672"></span>)
<span style="color:#66d9ef">end</span>

<span style="color:#66d9ef">function</span> Base<span style="color:#f92672"></span><span style="color:#f92672">.</span>show<span style="color:#f92672"></span>(io<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">IO</span>, d<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span>DiscriminatorPyramid<span style="color:#f92672"></span>)
    print<span style="color:#f92672"></span>(io<span style="color:#f92672"></span>, <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">D</span><span style="color:#e6db74">i</span><span style="color:#e6db74">s</span><span style="color:#e6db74">c</span><span style="color:#e6db74">r</span><span style="color:#e6db74">i</span><span style="color:#e6db74">m</span><span style="color:#e6db74">i</span><span style="color:#e6db74">n</span><span style="color:#e6db74">a</span><span style="color:#e6db74">t</span><span style="color:#e6db74">o</span><span style="color:#e6db74">r</span><span style="color:#e6db74">P</span><span style="color:#e6db74">y</span><span style="color:#e6db74">r</span><span style="color:#e6db74">a</span><span style="color:#e6db74">m</span><span style="color:#e6db74">i</span><span style="color:#e6db74">d</span><span style="color:#e6db74">(</span><span style="color:#e6db74">&#34;</span>)
    join<span style="color:#f92672"></span>(io<span style="color:#f92672"></span>, d<span style="color:#f92672"></span><span style="color:#f92672">.</span>chains<span style="color:#f92672"></span>, <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">,</span><span style="color:#e6db74"> </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)
    print<span style="color:#f92672"></span>(io<span style="color:#f92672"></span>, <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">)</span><span style="color:#e6db74">&#34;</span>)
<span style="color:#66d9ef">end</span>
</code></pre></div><p>ノイズ画像を足してレイヤーに通し、出力結果にオリジナルの画像を加えて周囲をトリミングする <code>NoiseConnection</code> (名前は適当)を作ります。
$$
\begin{aligned}
G(x, z) &amp;= \rangle(\bar{x} + \psi(z + \bar{x}))\langle_d, \\
\bar{x} &amp;= \langle(x)\uparrow^r\rangle_d
\end{aligned}
$$
上の式で言えば
$$
\begin{aligned}
N(\bar{x}, z) &amp;= \rangle(\bar{x} + \psi(z + \bar{x}))\langle_d
\end{aligned}
$$</p>
<p>を計算するレイヤーです。<code>pad</code> は周囲でノイズパディングを行うサイズ \(d\) です。
<code>basic.jl</code> の <code>SkipConnection</code> の実装を参考にしました。
<a href="https://github.com/FluxML/Flux.jl/blob/e92da0cf850a982c425b83c92d6274174e52b02c/src/layers/basic.jl#L197">https://github.com/FluxML/Flux.jl/blob/e92da0cf850a982c425b83c92d6274174e52b02c/src/layers/basic.jl#L197</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-julia" data-lang="julia"><span style="color:#e6db74">&#34;&#34;&#34;</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74"> </span><span style="color:#e6db74"> </span><span style="color:#e6db74"> </span><span style="color:#e6db74"> </span><span style="color:#e6db74">N</span><span style="color:#e6db74">o</span><span style="color:#e6db74">i</span><span style="color:#e6db74">s</span><span style="color:#e6db74">e</span><span style="color:#e6db74">C</span><span style="color:#e6db74">o</span><span style="color:#e6db74">n</span><span style="color:#e6db74">n</span><span style="color:#e6db74">e</span><span style="color:#e6db74">c</span><span style="color:#e6db74">t</span><span style="color:#e6db74">i</span><span style="color:#e6db74">o</span><span style="color:#e6db74">n</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;&#34;&#34;</span>
<span style="color:#66d9ef">mutable</span> <span style="color:#66d9ef">struct</span> NoiseConnection<span style="color:#f92672"></span>
    layers<span style="color:#f92672"></span>
    pad<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">Int64</span>
<span style="color:#66d9ef">end</span>

<span style="color:#a6e22e">@Flux</span><span style="color:#f92672"></span><span style="color:#f92672">.</span>functor<span style="color:#f92672"></span> NoiseConnection<span style="color:#f92672"></span>

<span style="color:#66d9ef">function</span> (nc<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span>NoiseConnection<span style="color:#f92672"></span>)(prev<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span>T<span style="color:#f92672"></span>, noise<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span>T<span style="color:#f92672"></span>) where<span style="color:#f92672"></span> {T<span style="color:#f92672"></span> <span style="color:#f92672">&lt;</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">AbstractArray</span>{<span style="color:#66d9ef">Float32</span>,<span style="color:#ae81ff">4</span>}}
    pad<span style="color:#f92672"></span> <span style="color:#f92672">=</span> nc<span style="color:#f92672"></span><span style="color:#f92672">.</span>pad<span style="color:#f92672"></span>
    raw_output<span style="color:#f92672"></span> <span style="color:#f92672">=</span> nc<span style="color:#f92672"></span><span style="color:#f92672">.</span>layers<span style="color:#f92672"></span>(noise<span style="color:#f92672"></span> <span style="color:#f92672">+</span> prev<span style="color:#f92672"></span>)<span style="color:#f92672">:</span><span style="color:#f92672">:</span>T<span style="color:#f92672"></span> <span style="color:#f92672">+</span> prev<span style="color:#f92672"></span>
    <span style="color:#66d9ef">return</span> raw_output<span style="color:#f92672"></span>[<span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> pad<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#66d9ef">end</span> <span style="color:#f92672">-</span> pad<span style="color:#f92672"></span>, <span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> pad<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#66d9ef">end</span> <span style="color:#f92672">-</span> pad<span style="color:#f92672"></span>, <span style="color:#f92672">:</span>, <span style="color:#f92672">:</span>]
<span style="color:#66d9ef">end</span>

<span style="color:#66d9ef">function</span> Base<span style="color:#f92672"></span><span style="color:#f92672">.</span>show<span style="color:#f92672"></span>(io<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">IO</span>, nc<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span>NoiseConnection<span style="color:#f92672"></span>)
    print<span style="color:#f92672"></span>(io<span style="color:#f92672"></span>, <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">N</span><span style="color:#e6db74">o</span><span style="color:#e6db74">i</span><span style="color:#e6db74">s</span><span style="color:#e6db74">e</span><span style="color:#e6db74">C</span><span style="color:#e6db74">o</span><span style="color:#e6db74">n</span><span style="color:#e6db74">n</span><span style="color:#e6db74">e</span><span style="color:#e6db74">c</span><span style="color:#e6db74">t</span><span style="color:#e6db74">i</span><span style="color:#e6db74">o</span><span style="color:#e6db74">n</span><span style="color:#e6db74">(</span><span style="color:#e6db74">&#34;</span>, nc<span style="color:#f92672"></span><span style="color:#f92672">.</span>layers<span style="color:#f92672"></span>, <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">,</span><span style="color:#e6db74"> </span><span style="color:#e6db74">&#34;</span>, nc<span style="color:#f92672"></span><span style="color:#f92672">.</span>pad<span style="color:#f92672"></span>, <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">)</span><span style="color:#e6db74">&#34;</span>)
<span style="color:#66d9ef">end</span>
</code></pre></div><p>いよいよ GeneratorPyramid の定義です。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-julia" data-lang="julia"><span style="color:#e6db74">&#34;&#34;&#34;</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74"> </span><span style="color:#e6db74"> </span><span style="color:#e6db74"> </span><span style="color:#e6db74"> </span><span style="color:#e6db74">G</span><span style="color:#e6db74">e</span><span style="color:#e6db74">n</span><span style="color:#e6db74">e</span><span style="color:#e6db74">r</span><span style="color:#e6db74">a</span><span style="color:#e6db74">t</span><span style="color:#e6db74">o</span><span style="color:#e6db74">r</span><span style="color:#e6db74">P</span><span style="color:#e6db74">y</span><span style="color:#e6db74">r</span><span style="color:#e6db74">a</span><span style="color:#e6db74">m</span><span style="color:#e6db74">i</span><span style="color:#e6db74">d</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;&#34;&#34;</span>
<span style="color:#66d9ef">mutable</span> <span style="color:#66d9ef">struct</span> GeneratorPyramid<span style="color:#f92672"></span>{T<span style="color:#f92672"></span> <span style="color:#f92672">&lt;</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">Tuple</span>}
    image_shapes<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">Vector</span>{<span style="color:#66d9ef">Tuple</span>{<span style="color:#66d9ef">Int64</span>,<span style="color:#66d9ef">Int64</span>}}
    noise_shapes<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">Vector</span>{<span style="color:#66d9ef">Tuple</span>{<span style="color:#66d9ef">Int64</span>,<span style="color:#66d9ef">Int64</span>}}
    pad<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">Int64</span>
    chains<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span>T<span style="color:#f92672"></span>
    GeneratorPyramid<span style="color:#f92672"></span>(image_shapes<span style="color:#f92672"></span>, noise_shapes<span style="color:#f92672"></span>, pad<span style="color:#f92672"></span>, xs<span style="color:#f92672"></span><span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>) <span style="color:#f92672">=</span> new<span style="color:#f92672"></span>{typeof<span style="color:#f92672"></span>(xs<span style="color:#f92672"></span>)}(image_shapes<span style="color:#f92672"></span>, noise_shapes<span style="color:#f92672"></span>, pad<span style="color:#f92672"></span>, xs<span style="color:#f92672"></span>)
<span style="color:#66d9ef">end</span>

build_single_gen_layers<span style="color:#f92672"></span>(n_layers<span style="color:#f92672"></span>, conv_chs<span style="color:#f92672"></span>) <span style="color:#f92672">=</span> build_layers<span style="color:#f92672"></span>(n_layers<span style="color:#f92672"></span>, <span style="color:#ae81ff">3</span>, conv_chs<span style="color:#f92672"></span>, <span style="color:#ae81ff">3</span>, tanh<span style="color:#f92672"></span>)
build_single_generator<span style="color:#f92672"></span>(n_layers<span style="color:#f92672"></span>, conv_chs<span style="color:#f92672"></span>, pad<span style="color:#f92672"></span>) <span style="color:#f92672">=</span> NoiseConnection<span style="color:#f92672"></span>(build_single_gen_layers<span style="color:#f92672"></span>(n_layers<span style="color:#f92672"></span>, conv_chs<span style="color:#f92672"></span>), pad<span style="color:#f92672"></span>)

<span style="color:#66d9ef">function</span> GeneratorPyramid<span style="color:#f92672"></span>(image_shapes<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">Vector</span>{<span style="color:#66d9ef">Tuple</span>{<span style="color:#66d9ef">Int64</span>,<span style="color:#66d9ef">Int64</span>}}, n_layers<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">Integer</span>, pad<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">Integer</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>)
    n_stage<span style="color:#f92672"></span> <span style="color:#f92672">=</span> Base<span style="color:#f92672"></span><span style="color:#f92672">.</span>length<span style="color:#f92672"></span>(image_shapes<span style="color:#f92672"></span>)
    <span style="color:#75715e"># receptive field = 11, floor(11/2) = 5</span>
    noise_shapes<span style="color:#f92672"></span> <span style="color:#f92672">=</span> [<span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> pad<span style="color:#f92672"></span> <span style="color:#f92672">.+</span> s<span style="color:#f92672"></span> <span style="color:#66d9ef">for</span> s<span style="color:#f92672"></span> <span style="color:#66d9ef">in</span> image_shapes<span style="color:#f92672"></span>]
    ds<span style="color:#f92672"></span> <span style="color:#f92672">=</span> build_single_generator<span style="color:#f92672"></span><span style="color:#f92672">.</span>(n_layers<span style="color:#f92672"></span>, channel_pyramid<span style="color:#f92672"></span>(n_stage<span style="color:#f92672"></span>), pad<span style="color:#f92672"></span>)
    <span style="color:#66d9ef">return</span> GeneratorPyramid<span style="color:#f92672"></span>(image_shapes<span style="color:#f92672"></span>, noise_shapes<span style="color:#f92672"></span>, pad<span style="color:#f92672"></span>, gpu<span style="color:#f92672"></span><span style="color:#f92672">.</span>(ds<span style="color:#f92672"></span>)<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>)
<span style="color:#66d9ef">end</span>

<span style="color:#66d9ef">function</span> Base<span style="color:#f92672"></span><span style="color:#f92672">.</span>show<span style="color:#f92672"></span>(io<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">IO</span>, d<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span>GeneratorPyramid<span style="color:#f92672"></span>)
    print<span style="color:#f92672"></span>(io<span style="color:#f92672"></span>, <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">G</span><span style="color:#e6db74">e</span><span style="color:#e6db74">n</span><span style="color:#e6db74">e</span><span style="color:#e6db74">r</span><span style="color:#e6db74">a</span><span style="color:#e6db74">t</span><span style="color:#e6db74">o</span><span style="color:#e6db74">r</span><span style="color:#e6db74">P</span><span style="color:#e6db74">y</span><span style="color:#e6db74">r</span><span style="color:#e6db74">a</span><span style="color:#e6db74">m</span><span style="color:#e6db74">i</span><span style="color:#e6db74">d</span><span style="color:#e6db74">(</span><span style="color:#e6db74">&#34;</span>)
    print<span style="color:#f92672"></span>(io<span style="color:#f92672"></span>, d<span style="color:#f92672"></span><span style="color:#f92672">.</span>image_shapes<span style="color:#f92672"></span>, <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">,</span><span style="color:#e6db74"> </span><span style="color:#e6db74">&#34;</span>)
    print<span style="color:#f92672"></span>(io<span style="color:#f92672"></span>, d<span style="color:#f92672"></span><span style="color:#f92672">.</span>noise_shapes<span style="color:#f92672"></span>, <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">,</span><span style="color:#e6db74"> </span><span style="color:#e6db74">&#34;</span>)
    println<span style="color:#f92672"></span>(io<span style="color:#f92672"></span>, d<span style="color:#f92672"></span><span style="color:#f92672">.</span>pad<span style="color:#f92672"></span>, <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">,</span><span style="color:#e6db74"> </span><span style="color:#e6db74">&#34;</span>)
    join<span style="color:#f92672"></span>(io<span style="color:#f92672"></span>, d<span style="color:#f92672"></span><span style="color:#f92672">.</span>chains<span style="color:#f92672"></span>, <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">,</span><span style="color:#e6db74"> </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)
    print<span style="color:#f92672"></span>(io<span style="color:#f92672"></span>, <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">)</span><span style="color:#e6db74">&#34;</span>)
<span style="color:#66d9ef">end</span>

<span style="color:#66d9ef">function</span> (genp<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span>GeneratorPyramid<span style="color:#f92672"></span>)(xs<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">AbstractVector</span>{T<span style="color:#f92672"></span>}, st<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">Integer</span>, resize<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">Bool</span>) where<span style="color:#f92672"></span> {T<span style="color:#f92672"></span> <span style="color:#f92672">&lt;</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">AbstractArray</span>{<span style="color:#66d9ef">Float32</span>,<span style="color:#ae81ff">4</span>}}
    <span style="color:#66d9ef">if</span> st<span style="color:#f92672"></span> <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
        zeros_shape<span style="color:#f92672"></span> <span style="color:#f92672">=</span> resize<span style="color:#f92672"></span> <span style="color:#f92672">?</span> first<span style="color:#f92672"></span>(genp<span style="color:#f92672"></span><span style="color:#f92672">.</span>noise_shapes<span style="color:#f92672"></span>) <span style="color:#f92672">:</span> first<span style="color:#f92672"></span>(genp<span style="color:#f92672"></span><span style="color:#f92672">.</span>image_shapes<span style="color:#f92672"></span>)
        <span style="color:#66d9ef">return</span> zeros_like<span style="color:#f92672"></span>(T<span style="color:#f92672"></span>, expand_dim<span style="color:#f92672"></span>(zeros_shape<span style="color:#f92672"></span><span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>))
    <span style="color:#66d9ef">end</span>
    prev<span style="color:#f92672"></span> <span style="color:#f92672">=</span> genp<span style="color:#f92672"></span>(xs<span style="color:#f92672"></span>, st<span style="color:#f92672"></span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>, <span style="color:#66d9ef">true</span>)
    out<span style="color:#f92672"></span> <span style="color:#f92672">=</span> genp<span style="color:#f92672"></span><span style="color:#f92672">.</span>chains<span style="color:#f92672"></span>[st<span style="color:#f92672"></span>](prev<span style="color:#f92672"></span>, xs<span style="color:#f92672"></span>[st<span style="color:#f92672"></span>])
    <span style="color:#66d9ef">return</span> resize<span style="color:#f92672"></span> <span style="color:#f92672">?</span> resize_and_padding<span style="color:#f92672"></span>(out<span style="color:#f92672"></span>, genp<span style="color:#f92672"></span><span style="color:#f92672">.</span>image_shapes<span style="color:#f92672"></span>[st<span style="color:#f92672"></span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>], genp<span style="color:#f92672"></span><span style="color:#f92672">.</span>noise_shapes<span style="color:#f92672"></span>[st<span style="color:#f92672"></span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>]) <span style="color:#f92672">:</span> out<span style="color:#f92672"></span>
<span style="color:#66d9ef">end</span>
</code></pre></div><p>最後の関数が画像を生成する関数で、<code>xs</code> が与えるノイズ、<code>st</code> が到達したいステージ、<code>resize</code> が生成した後に拡大したいかどうかです。
ステージの添字の数え方は論文とは上下が逆で下から上の順に大きくなっているので注意です。</p>
<h3 id="heading5">損失関数</h3>
<p>次に損失関数を定義します。SinGAN のオリジナルの実装では GAN には WGAN-GP を使っているのですが、残念なが自分のスキルでは Gradientを損失条件の中に入れられなかった
(損失関数の中にGradientの計算関数を入れると、損失関数の微分が取れなかった) ので、泣く泣く LSGAN に置き換えています。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-julia" data-lang="julia"><span style="color:#66d9ef">function</span> discriminator_loss<span style="color:#f92672"></span>(d_real<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">AbstractArray</span>, d_g_fake_adv<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">AbstractArray</span>)
    real_loss<span style="color:#f92672"></span> <span style="color:#f92672">=</span> mse<span style="color:#f92672"></span>(<span style="color:#ae81ff">1f0</span>, mean<span style="color:#f92672"></span>(d_real<span style="color:#f92672"></span>; dims<span style="color:#f92672"></span> <span style="color:#f92672">=</span> (<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>)))
    fake_loss<span style="color:#f92672"></span> <span style="color:#f92672">=</span> mse<span style="color:#f92672"></span>(<span style="color:#ae81ff">0f0</span>, mean<span style="color:#f92672"></span>(d_g_fake_adv<span style="color:#f92672"></span>; dims<span style="color:#f92672"></span> <span style="color:#f92672">=</span> (<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>)))
    <span style="color:#66d9ef">return</span> real_loss<span style="color:#f92672"></span> <span style="color:#f92672">+</span> fake_loss<span style="color:#f92672"></span>
<span style="color:#66d9ef">end</span>

generator_adv_loss<span style="color:#f92672"></span>(d_g_fake_adv<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">AbstractArray</span>) <span style="color:#f92672">=</span> mse<span style="color:#f92672"></span>(<span style="color:#ae81ff">1f0</span>, mean<span style="color:#f92672"></span>(d_g_fake_adv<span style="color:#f92672"></span>; dims<span style="color:#f92672"></span> <span style="color:#f92672">=</span> (<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>)))

generator_rec_loss<span style="color:#f92672"></span>(real_img<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">AbstractArray</span>, g_fake_rec<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">AbstractArray</span>) <span style="color:#f92672">=</span> mse<span style="color:#f92672"></span>(real_img<span style="color:#f92672"></span>, g_fake_rec<span style="color:#f92672"></span>)
</code></pre></div><p>いちいち0や1をベクトルに直す必要はありません。シンプルに書けていいですね。</p>
<h3 id="discriminator-generator-">Discriminator, Generator の更新</h3>
<p>損失関数の値を計算し、Discriminator, Generator のパラメーターに関する微分を取ってパラメーターを更新する関数を書きます。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-julia" data-lang="julia"><span style="color:#66d9ef">function</span> update_discriminator!<span style="color:#f92672"></span>(opt<span style="color:#f92672"></span>, dscr<span style="color:#f92672"></span>, real_img<span style="color:#f92672"></span>, g_fake_adv<span style="color:#f92672"></span>)
    <span style="color:#a6e22e">@eval</span><span style="color:#f92672"></span> Flux<span style="color:#f92672"></span><span style="color:#f92672">.</span>istraining<span style="color:#f92672"></span>() <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>
    ps<span style="color:#f92672"></span> <span style="color:#f92672">=</span> params<span style="color:#f92672"></span>(dscr<span style="color:#f92672"></span>)
    grad<span style="color:#f92672"></span> <span style="color:#f92672">=</span> gradient<span style="color:#f92672"></span>(ps<span style="color:#f92672"></span>) <span style="color:#66d9ef">do</span>
        discriminator_loss<span style="color:#f92672"></span>(dscr<span style="color:#f92672"></span>(real_img<span style="color:#f92672"></span>), dscr<span style="color:#f92672"></span>(g_fake_adv<span style="color:#f92672"></span>))
    <span style="color:#66d9ef">end</span>
    update!<span style="color:#f92672"></span>(opt<span style="color:#f92672"></span>, ps<span style="color:#f92672"></span>, grad<span style="color:#f92672"></span>)
    <span style="color:#a6e22e">@eval</span><span style="color:#f92672"></span> Flux<span style="color:#f92672"></span><span style="color:#f92672">.</span>istraining<span style="color:#f92672"></span>() <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>
<span style="color:#66d9ef">end</span>

<span style="color:#66d9ef">function</span> update_generator!<span style="color:#f92672"></span>(opt<span style="color:#f92672"></span>, dscr<span style="color:#f92672"></span>, gen<span style="color:#f92672"></span>, real_img<span style="color:#f92672"></span>, prev_rec<span style="color:#f92672"></span>, prev_adv<span style="color:#f92672"></span>, noise_rec<span style="color:#f92672"></span>, noise_adv<span style="color:#f92672"></span>, alpha<span style="color:#f92672"></span>)
    <span style="color:#a6e22e">@eval</span><span style="color:#f92672"></span> Flux<span style="color:#f92672"></span><span style="color:#f92672">.</span>istraining<span style="color:#f92672"></span>() <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>
    ps<span style="color:#f92672"></span> <span style="color:#f92672">=</span> params<span style="color:#f92672"></span>(gen<span style="color:#f92672"></span>)
    grad<span style="color:#f92672"></span> <span style="color:#f92672">=</span> gradient<span style="color:#f92672"></span>(ps<span style="color:#f92672"></span>) <span style="color:#66d9ef">do</span>
        g_fake_rec<span style="color:#f92672"></span> <span style="color:#f92672">=</span> gen<span style="color:#f92672"></span>(prev_rec<span style="color:#f92672"></span>, noise_rec<span style="color:#f92672"></span>)
        d_g_fake_adv<span style="color:#f92672"></span> <span style="color:#f92672">=</span> dscr<span style="color:#f92672"></span>(gen<span style="color:#f92672"></span>(prev_adv<span style="color:#f92672"></span>, noise_adv<span style="color:#f92672"></span>))
        generator_adv_loss<span style="color:#f92672"></span>(d_g_fake_adv<span style="color:#f92672"></span>) <span style="color:#f92672">+</span> alpha<span style="color:#f92672"></span> <span style="color:#f92672">*</span> generator_rec_loss<span style="color:#f92672"></span>(real_img<span style="color:#f92672"></span>, g_fake_rec<span style="color:#f92672"></span>)
    <span style="color:#66d9ef">end</span>
    update!<span style="color:#f92672"></span>(opt<span style="color:#f92672"></span>, ps<span style="color:#f92672"></span>, grad<span style="color:#f92672"></span>)
    <span style="color:#a6e22e">@eval</span><span style="color:#f92672"></span> Flux<span style="color:#f92672"></span><span style="color:#f92672">.</span>istraining<span style="color:#f92672"></span>() <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>
<span style="color:#66d9ef">end</span>
</code></pre></div><p>ここで、</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-julia" data-lang="julia">grad<span style="color:#f92672"></span> <span style="color:#f92672">=</span> gradient<span style="color:#f92672"></span>(ps<span style="color:#f92672"></span>) <span style="color:#66d9ef">do</span>
    discriminator_loss<span style="color:#f92672"></span>(dscr<span style="color:#f92672"></span>(real_img<span style="color:#f92672"></span>), dscr<span style="color:#f92672"></span>(g_fake_adv<span style="color:#f92672"></span>))
<span style="color:#66d9ef">end</span>
</code></pre></div><p>この部分はこれと一緒です。(<a href="https://docs.julialang.org/en/v1/manual/functions/index.html#man-anonymous-functions-1">https://docs.julialang.org/en/v1/manual/functions/index.html#man-anonymous-functions-1</a>)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-julia" data-lang="julia">grad<span style="color:#f92672"></span> <span style="color:#f92672">=</span> gradient<span style="color:#f92672"></span>(() <span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span> discriminator_loss<span style="color:#f92672"></span>(dscr<span style="color:#f92672"></span>(real_img<span style="color:#f92672"></span>), dscr<span style="color:#f92672"></span>(g_fake_adv<span style="color:#f92672"></span>)), ps<span style="color:#f92672"></span>)
</code></pre></div><p><code>gradient</code> の代わりに <code>pullback</code> を使うと微分と同時に関数の値も取得できます。(<a href="https://fluxml.ai/Zygote.jl/latest/adjoints/#Pullbacks-1">https://fluxml.ai/Zygote.jl/latest/adjoints/#Pullbacks-1</a>)</p>
<p>パラメーターの更新後に損失関数の値を返したい場合、例えばこのように書けばOKです。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-julia" data-lang="julia"><span style="color:#66d9ef">function</span> update_discriminator!<span style="color:#f92672"></span>(opt<span style="color:#f92672"></span>, dscr<span style="color:#f92672"></span>, real_img<span style="color:#f92672"></span>, g_fake_adv<span style="color:#f92672"></span>)
    <span style="color:#a6e22e">@eval</span><span style="color:#f92672"></span> Flux<span style="color:#f92672"></span><span style="color:#f92672">.</span>istraining<span style="color:#f92672"></span>() <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>
    ps<span style="color:#f92672"></span> <span style="color:#f92672">=</span> params<span style="color:#f92672"></span>(dscr<span style="color:#f92672"></span>)
    loss<span style="color:#f92672"></span>, back<span style="color:#f92672"></span> <span style="color:#f92672">=</span> pullback<span style="color:#f92672"></span>(ps<span style="color:#f92672"></span>) <span style="color:#66d9ef">do</span>
        discriminator_loss<span style="color:#f92672"></span>(dscr<span style="color:#f92672"></span>(real_img<span style="color:#f92672"></span>), dscr<span style="color:#f92672"></span>(g_fake_adv<span style="color:#f92672"></span>))
    <span style="color:#66d9ef">end</span>
    grad<span style="color:#f92672"></span> <span style="color:#f92672">=</span> back<span style="color:#f92672"></span>(Zygote<span style="color:#f92672"></span><span style="color:#f92672">.</span>sensitivity<span style="color:#f92672"></span>(loss<span style="color:#f92672"></span>))
    update!<span style="color:#f92672"></span>(opt<span style="color:#f92672"></span>, ps<span style="color:#f92672"></span>, grad<span style="color:#f92672"></span>)
    <span style="color:#a6e22e">@eval</span><span style="color:#f92672"></span> Flux<span style="color:#f92672"></span><span style="color:#f92672">.</span>istraining<span style="color:#f92672"></span>() <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>
    <span style="color:#66d9ef">return</span> loss<span style="color:#f92672"></span>
<span style="color:#66d9ef">end</span>
</code></pre></div><h3 id="heading6">学習</h3>
<p>1エポックの学習は次のようになります。
改めて損失関数の値を計算しているので少し無駄になっている気もしますが気にしないでおきます。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-julia" data-lang="julia"><span style="color:#66d9ef">function</span> train_epoch!<span style="color:#f92672"></span>(opt_dscr<span style="color:#f92672"></span>, opt_gen<span style="color:#f92672"></span>, st<span style="color:#f92672"></span>, loop_dscr<span style="color:#f92672"></span>, loop_gen<span style="color:#f92672"></span>,
        dscr<span style="color:#f92672"></span>, genp<span style="color:#f92672"></span>, prev_rec<span style="color:#f92672"></span>, noise_rec<span style="color:#f92672"></span>, real_img<span style="color:#f92672"></span>, amplifiers<span style="color:#f92672"></span>, alpha<span style="color:#f92672"></span>)

    <span style="color:#75715e"># discriminator</span>
    foreach<span style="color:#f92672"></span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>loop_dscr<span style="color:#f92672"></span>) <span style="color:#66d9ef">do</span> _<span style="color:#f92672"></span>
        noise_adv<span style="color:#f92672"></span> <span style="color:#f92672">=</span> build_noise_pyramid<span style="color:#f92672"></span>(prev_rec<span style="color:#f92672"></span>, genp<span style="color:#f92672"></span><span style="color:#f92672">.</span>noise_shapes<span style="color:#f92672"></span>[<span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>st<span style="color:#f92672"></span>], amplifiers<span style="color:#f92672"></span>)
        g_fake_adv<span style="color:#f92672"></span> <span style="color:#f92672">=</span> genp<span style="color:#f92672"></span>(noise_adv<span style="color:#f92672"></span>, st<span style="color:#f92672"></span>, <span style="color:#66d9ef">false</span>)
        update_discriminator!<span style="color:#f92672"></span>(opt_dscr<span style="color:#f92672"></span>, dscr<span style="color:#f92672"></span>, real_img<span style="color:#f92672"></span>, g_fake_adv<span style="color:#f92672"></span>)
    <span style="color:#66d9ef">end</span>

    <span style="color:#75715e"># generator</span>
    foreach<span style="color:#f92672"></span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>loop_gen<span style="color:#f92672"></span>) <span style="color:#66d9ef">do</span> _<span style="color:#f92672"></span>
        noise_adv<span style="color:#f92672"></span> <span style="color:#f92672">=</span> build_noise_pyramid<span style="color:#f92672"></span>(prev_rec<span style="color:#f92672"></span>, genp<span style="color:#f92672"></span><span style="color:#f92672">.</span>noise_shapes<span style="color:#f92672"></span>[<span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>st<span style="color:#f92672"></span>], amplifiers<span style="color:#f92672"></span>)
        prev_adv<span style="color:#f92672"></span> <span style="color:#f92672">=</span> genp<span style="color:#f92672"></span>(noise_adv<span style="color:#f92672"></span>, st<span style="color:#f92672"></span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>, <span style="color:#66d9ef">true</span>)
        update_generator!<span style="color:#f92672"></span>(opt_gen<span style="color:#f92672"></span>, dscr<span style="color:#f92672"></span>, genp<span style="color:#f92672"></span><span style="color:#f92672">.</span>chains<span style="color:#f92672"></span>[st<span style="color:#f92672"></span>], real_img<span style="color:#f92672"></span>, prev_rec<span style="color:#f92672"></span>, prev_adv<span style="color:#f92672"></span>, noise_rec<span style="color:#f92672"></span>, last<span style="color:#f92672"></span>(noise_adv<span style="color:#f92672"></span>), alpha<span style="color:#f92672"></span>)
    <span style="color:#66d9ef">end</span>

    noise_adv<span style="color:#f92672"></span> <span style="color:#f92672">=</span> build_noise_pyramid<span style="color:#f92672"></span>(prev_rec<span style="color:#f92672"></span>, genp<span style="color:#f92672"></span><span style="color:#f92672">.</span>noise_shapes<span style="color:#f92672"></span>[<span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>st<span style="color:#f92672"></span>], amplifiers<span style="color:#f92672"></span>)
    g_fake_adv<span style="color:#f92672"></span> <span style="color:#f92672">=</span> genp<span style="color:#f92672"></span>(noise_adv<span style="color:#f92672"></span>, st<span style="color:#f92672"></span>, <span style="color:#66d9ef">false</span>)
    loss_dscr<span style="color:#f92672"></span> <span style="color:#f92672">=</span> discriminator_loss<span style="color:#f92672"></span>(dscr<span style="color:#f92672"></span>(real_img<span style="color:#f92672"></span>), dscr<span style="color:#f92672"></span>(g_fake_adv<span style="color:#f92672"></span>))
    d_g_fake_adv<span style="color:#f92672"></span> <span style="color:#f92672">=</span> dscr<span style="color:#f92672"></span>(g_fake_adv<span style="color:#f92672"></span>)
    loss_gen_adv<span style="color:#f92672"></span> <span style="color:#f92672">=</span> generator_adv_loss<span style="color:#f92672"></span>(d_g_fake_adv<span style="color:#f92672"></span>)
    g_fake_rec<span style="color:#f92672"></span> <span style="color:#f92672">=</span> genp<span style="color:#f92672"></span><span style="color:#f92672">.</span>chains<span style="color:#f92672"></span>[st<span style="color:#f92672"></span>](prev_rec<span style="color:#f92672"></span>, noise_rec<span style="color:#f92672"></span>)
    loss_gen_rec<span style="color:#f92672"></span> <span style="color:#f92672">=</span> generator_rec_loss<span style="color:#f92672"></span>(real_img<span style="color:#f92672"></span>, g_fake_rec<span style="color:#f92672"></span>) 

    <span style="color:#66d9ef">return</span> loss_dscr<span style="color:#f92672"></span>, loss_gen_adv<span style="color:#f92672"></span>, loss_gen_rec<span style="color:#f92672"></span>
<span style="color:#66d9ef">end</span>
</code></pre></div><p>ハイパーパラメーターを入れておく箱を用意して、</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-julia" data-lang="julia"><span style="color:#66d9ef">mutable</span> <span style="color:#66d9ef">struct</span> HyperParams<span style="color:#f92672"></span>
    scale<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">Float64</span>                  <span style="color:#75715e"># progression scale, &gt; 1</span>
    min_size_x<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">Int64</span>               <span style="color:#75715e"># minimal image width</span>
    min_size_y<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">Int64</span>               <span style="color:#75715e"># minimal image height</span>
    img_size_x<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">Int64</span>               <span style="color:#75715e"># output image width</span>
    img_size_y<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">Int64</span>               <span style="color:#75715e"># output image height</span>
    n_layers<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">Int64</span>                 <span style="color:#75715e"># number of conv layers</span>
    max_epoch<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">Int64</span>                <span style="color:#75715e"># training epochs</span>
    reduce_lr_epoch<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">Int64</span>          <span style="color:#75715e"># reduce learining rate after training `redule_lr_epoch` epochs</span>
    save_image_every_epoch<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">Int64</span>   <span style="color:#75715e"># save generated image every `save_image_every_epoch` epoch</span>
    save_loss_every_epoch<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">Int64</span>    <span style="color:#75715e"># save loss every `save_loss_every_epoch` epoch</span>
    loop_dscr<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">Int64</span>                <span style="color:#75715e"># training steps par descriminator training epoch</span>
    loop_gen<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">Int64</span>                 <span style="color:#75715e"># training steps par generator training epoch</span>
    lr_dscr<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">Float64</span>                <span style="color:#75715e"># discriminator learining rate</span>
    lr_gen<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">Float64</span>                 <span style="color:#75715e"># generator learning rate</span>
    alpha<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">Float32</span>                  <span style="color:#75715e"># rec loss coefficient</span>
    amplifier_init<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">Float32</span>         <span style="color:#75715e"># noise amplifier</span>
    HyperParams<span style="color:#f92672"></span>() <span style="color:#f92672">=</span> new<span style="color:#f92672"></span>(<span style="color:#ae81ff">4</span><span style="color:#f92672">/</span><span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">25</span>, <span style="color:#ae81ff">25</span>, <span style="color:#ae81ff">128</span>, <span style="color:#ae81ff">128</span>, <span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">2000</span>, <span style="color:#ae81ff">1600</span>, <span style="color:#ae81ff">500</span>, <span style="color:#ae81ff">100</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">5e-4</span>, <span style="color:#ae81ff">5e-4</span>, <span style="color:#ae81ff">50f0</span>, <span style="color:#ae81ff">1f0</span>)
<span style="color:#66d9ef">end</span>

show_dict<span style="color:#f92672"></span>(hp<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span>HyperParams<span style="color:#f92672"></span>) <span style="color:#f92672">=</span> OrderedDict<span style="color:#f92672"></span>(string<span style="color:#f92672"></span>(nm<span style="color:#f92672"></span>) <span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span> getfield<span style="color:#f92672"></span>(hp<span style="color:#f92672"></span>, nm<span style="color:#f92672"></span>) <span style="color:#66d9ef">for</span> nm<span style="color:#f92672"></span> <span style="color:#66d9ef">in</span> fieldnames<span style="color:#f92672"></span>(HyperParams<span style="color:#f92672"></span>))
image_shapes<span style="color:#f92672"></span>(hp<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span>HyperParams<span style="color:#f92672"></span>) <span style="color:#f92672">=</span> size_pyramid<span style="color:#f92672"></span>(hp<span style="color:#f92672"></span><span style="color:#f92672">.</span>scale<span style="color:#f92672"></span>, (hp<span style="color:#f92672"></span><span style="color:#f92672">.</span>min_size_x<span style="color:#f92672"></span>, hp<span style="color:#f92672"></span><span style="color:#f92672">.</span>min_size_y<span style="color:#f92672"></span>), (hp<span style="color:#f92672"></span><span style="color:#f92672">.</span>img_size_x<span style="color:#f92672"></span>, hp<span style="color:#f92672"></span><span style="color:#f92672">.</span>img_size_y<span style="color:#f92672"></span>))

<span style="color:#66d9ef">function</span> setup_models<span style="color:#f92672"></span>(hp<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span>HyperParams<span style="color:#f92672"></span>)
    img_shapes<span style="color:#f92672"></span> <span style="color:#f92672">=</span> image_shapes<span style="color:#f92672"></span>(hp<span style="color:#f92672"></span>)
    dscrp<span style="color:#f92672"></span> <span style="color:#f92672">=</span> DiscriminatorPyramid<span style="color:#f92672"></span>(img_shapes<span style="color:#f92672"></span>, hp<span style="color:#f92672"></span><span style="color:#f92672">.</span>n_layers<span style="color:#f92672"></span>) <span style="color:#f92672">|&gt;</span> gpu<span style="color:#f92672"></span>
    genp<span style="color:#f92672"></span> <span style="color:#f92672">=</span> GeneratorPyramid<span style="color:#f92672"></span>(img_shapes<span style="color:#f92672"></span>, hp<span style="color:#f92672"></span><span style="color:#f92672">.</span>n_layers<span style="color:#f92672"></span>) <span style="color:#f92672">|&gt;</span> gpu<span style="color:#f92672"></span>
    <span style="color:#66d9ef">return</span> dscrp<span style="color:#f92672"></span>, genp<span style="color:#f92672"></span>
<span style="color:#66d9ef">end</span>
</code></pre></div><p>ようやく最終的な <code>train</code> 関数の完成です。(画像を出力するところなどは省いています)。
<code>estimate_noise_amplifier</code> は、一段階前の画像と元画像からノイズの分散を調節する関数です。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-julia" data-lang="julia"><span style="color:#66d9ef">function</span> estimate_noise_amplifier<span style="color:#f92672"></span>(prev_rec<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">AbstractArray</span>{<span style="color:#66d9ef">Float32</span>,<span style="color:#ae81ff">4</span>}, real_img<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">AbstractArray</span>{<span style="color:#66d9ef">Float32</span>,<span style="color:#ae81ff">4</span>},
        pad<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">Integer</span>, amplifier_init<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">Float32</span>)
    prev_rec_crop<span style="color:#f92672"></span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">@view</span><span style="color:#f92672"></span> prev_rec<span style="color:#f92672"></span>[<span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> pad<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#66d9ef">end</span> <span style="color:#f92672">-</span> pad<span style="color:#f92672"></span>, <span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> pad<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#66d9ef">end</span> <span style="color:#f92672">-</span> pad<span style="color:#f92672"></span>, <span style="color:#f92672">:</span>, <span style="color:#f92672">:</span>]
    rmse<span style="color:#f92672"></span> <span style="color:#f92672">=</span> sqrt<span style="color:#f92672"></span>(mse<span style="color:#f92672"></span>(real_img<span style="color:#f92672"></span>, prev_rec_crop<span style="color:#f92672"></span>))
    <span style="color:#66d9ef">return</span> rmse<span style="color:#f92672"></span> <span style="color:#f92672">*</span> amplifier_init<span style="color:#f92672"></span>
<span style="color:#66d9ef">end</span>

<span style="color:#66d9ef">function</span> train!<span style="color:#f92672"></span>(dscrp<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span>DiscriminatorPyramid<span style="color:#f92672"></span>, genp<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span>GeneratorPyramid<span style="color:#f92672"></span>, 
        real_img_p<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">Vector</span>{T<span style="color:#f92672"></span>}, hp<span style="color:#f92672"></span><span style="color:#f92672">:</span><span style="color:#f92672">:</span>HyperParams<span style="color:#f92672"></span>) where<span style="color:#f92672"></span> {T<span style="color:#f92672"></span> <span style="color:#f92672">&lt;</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">AbstractArray</span>{<span style="color:#66d9ef">Float32</span>,<span style="color:#ae81ff">4</span>}}
    stages<span style="color:#f92672"></span> <span style="color:#f92672">=</span> Base<span style="color:#f92672"></span><span style="color:#f92672">.</span>length<span style="color:#f92672"></span>(genp<span style="color:#f92672"></span><span style="color:#f92672">.</span>image_shapes<span style="color:#f92672"></span>)

    amplifiers<span style="color:#f92672"></span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">Float32</span>[]

    <span style="color:#75715e"># fixed noise for rec</span>
    fixed_noise_rec<span style="color:#f92672"></span> <span style="color:#f92672">=</span> build_rec_pyramid<span style="color:#f92672"></span>(first<span style="color:#f92672"></span>(real_img_p<span style="color:#f92672"></span>), genp<span style="color:#f92672"></span><span style="color:#f92672">.</span>noise_shapes<span style="color:#f92672"></span>, <span style="color:#ae81ff">1f0</span>)
    fixed_noise_adv<span style="color:#f92672"></span> <span style="color:#f92672">=</span> similar<span style="color:#f92672"></span>(fixed_noise_rec<span style="color:#f92672"></span>)
    
    <span style="color:#66d9ef">for</span> st<span style="color:#f92672"></span> <span style="color:#66d9ef">in</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>stages<span style="color:#f92672"></span>
        <span style="color:#a6e22e">@info</span><span style="color:#f92672"></span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">S</span><span style="color:#e6db74">t</span><span style="color:#e6db74">e</span><span style="color:#e6db74">p</span><span style="color:#e6db74"> </span><span style="color:#e6db74">$</span>(st<span style="color:#f92672"></span>)<span style="color:#e6db74">&#34;</span>
        <span style="color:#75715e"># reset optimizer</span>
        opt_dscr<span style="color:#f92672"></span> <span style="color:#f92672">=</span> ADAM<span style="color:#f92672"></span>(hp<span style="color:#f92672"></span><span style="color:#f92672">.</span>lr_dscr<span style="color:#f92672"></span>, (<span style="color:#ae81ff">0.5</span>, <span style="color:#ae81ff">0.999</span>))
        opt_gen<span style="color:#f92672"></span> <span style="color:#f92672">=</span> ADAM<span style="color:#f92672"></span>(hp<span style="color:#f92672"></span><span style="color:#f92672">.</span>lr_gen<span style="color:#f92672"></span>, (<span style="color:#ae81ff">0.5</span>, <span style="color:#ae81ff">0.999</span>))

        <span style="color:#75715e"># calculate noise amplifier</span>
        prev_rec<span style="color:#f92672"></span> <span style="color:#f92672">=</span> genp<span style="color:#f92672"></span>(fixed_noise_rec<span style="color:#f92672"></span>, st<span style="color:#f92672"></span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>, <span style="color:#66d9ef">true</span>) <span style="color:#75715e"># padded</span>
        amp<span style="color:#f92672"></span> <span style="color:#f92672">=</span> st<span style="color:#f92672"></span> <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">?</span> <span style="color:#ae81ff">1f0</span> <span style="color:#f92672">:</span> estimate_noise_amplifier<span style="color:#f92672"></span>(prev_rec<span style="color:#f92672"></span>, real_img_p<span style="color:#f92672"></span>[st<span style="color:#f92672"></span>], genp<span style="color:#f92672"></span><span style="color:#f92672">.</span>pad<span style="color:#f92672"></span>, hp<span style="color:#f92672"></span><span style="color:#f92672">.</span>amplifier_init<span style="color:#f92672"></span>)
        push!<span style="color:#f92672"></span>(amplifiers<span style="color:#f92672"></span>, amp<span style="color:#f92672"></span>)
        <span style="color:#75715e"># add noise for adv </span>
        fixed_noise_adv<span style="color:#f92672"></span>[st<span style="color:#f92672"></span>] <span style="color:#f92672">=</span> amp<span style="color:#f92672"></span> <span style="color:#f92672">*</span> randn_like<span style="color:#f92672"></span>(prev_rec<span style="color:#f92672"></span>, expand_dim<span style="color:#f92672"></span>(genp<span style="color:#f92672"></span><span style="color:#f92672">.</span>noise_shapes<span style="color:#f92672"></span>[st<span style="color:#f92672"></span>]<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>))

        save_noise_amplifiers<span style="color:#f92672"></span>(st<span style="color:#f92672"></span>, amp<span style="color:#f92672"></span>)
        <span style="color:#a6e22e">@info</span><span style="color:#f92672"></span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">N</span><span style="color:#e6db74">o</span><span style="color:#e6db74">i</span><span style="color:#e6db74">s</span><span style="color:#e6db74">e</span><span style="color:#e6db74"> </span><span style="color:#e6db74">a</span><span style="color:#e6db74">m</span><span style="color:#e6db74">p</span><span style="color:#e6db74">l</span><span style="color:#e6db74">i</span><span style="color:#e6db74">f</span><span style="color:#e6db74">i</span><span style="color:#e6db74">e</span><span style="color:#e6db74">r</span><span style="color:#e6db74"> </span><span style="color:#e6db74">=</span><span style="color:#e6db74"> </span><span style="color:#e6db74">$</span>(amp<span style="color:#f92672"></span>)<span style="color:#e6db74">&#34;</span>

        <span style="color:#a6e22e">@time</span><span style="color:#f92672"></span> <span style="color:#66d9ef">for</span> ep<span style="color:#f92672"></span> <span style="color:#66d9ef">in</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>hp<span style="color:#f92672"></span><span style="color:#f92672">.</span>max_epoch<span style="color:#f92672"></span>
            <span style="color:#75715e"># reduce learnint rate</span>
            <span style="color:#66d9ef">if</span> ep<span style="color:#f92672"></span> <span style="color:#f92672">=</span><span style="color:#f92672">=</span> hp<span style="color:#f92672"></span><span style="color:#f92672">.</span>reduce_lr_epoch<span style="color:#f92672"></span>
                <span style="color:#a6e22e">@info</span><span style="color:#f92672"></span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">R</span><span style="color:#e6db74">e</span><span style="color:#e6db74">d</span><span style="color:#e6db74">u</span><span style="color:#e6db74">c</span><span style="color:#e6db74">e</span><span style="color:#e6db74"> </span><span style="color:#e6db74">l</span><span style="color:#e6db74">e</span><span style="color:#e6db74">a</span><span style="color:#e6db74">r</span><span style="color:#e6db74">n</span><span style="color:#e6db74">i</span><span style="color:#e6db74">n</span><span style="color:#e6db74">g</span><span style="color:#e6db74"> </span><span style="color:#e6db74">r</span><span style="color:#e6db74">a</span><span style="color:#e6db74">t</span><span style="color:#e6db74">e</span><span style="color:#e6db74">&#34;</span>
                opt_dscr<span style="color:#f92672"></span><span style="color:#f92672">.</span>eta<span style="color:#f92672"></span> <span style="color:#f92672">/=</span> <span style="color:#ae81ff">10</span>
                opt_gen<span style="color:#f92672"></span><span style="color:#f92672">.</span>eta<span style="color:#f92672"></span> <span style="color:#f92672">/=</span> <span style="color:#ae81ff">10</span>
            <span style="color:#66d9ef">end</span>

            loss_dscr<span style="color:#f92672"></span>, loss_gen_adv<span style="color:#f92672"></span>, loss_gen_rec<span style="color:#f92672"></span> <span style="color:#f92672">=</span>
                train_epoch!<span style="color:#f92672"></span>(opt_dscr<span style="color:#f92672"></span>, opt_gen<span style="color:#f92672"></span>, st<span style="color:#f92672"></span>, hp<span style="color:#f92672"></span><span style="color:#f92672">.</span>loop_dscr<span style="color:#f92672"></span>, hp<span style="color:#f92672"></span><span style="color:#f92672">.</span>loop_gen<span style="color:#f92672"></span>,
                    dscrp<span style="color:#f92672"></span><span style="color:#f92672">.</span>chains<span style="color:#f92672"></span>[st<span style="color:#f92672"></span>], genp<span style="color:#f92672"></span>, prev_rec<span style="color:#f92672"></span>, fixed_noise_rec<span style="color:#f92672"></span>[st<span style="color:#f92672"></span>], real_img_p<span style="color:#f92672"></span>[st<span style="color:#f92672"></span>], amplifiers<span style="color:#f92672"></span>, hp<span style="color:#f92672"></span><span style="color:#f92672">.</span>alpha<span style="color:#f92672"></span>)
        <span style="color:#66d9ef">end</span>
    <span style="color:#66d9ef">end</span>

<span style="color:#66d9ef">end</span>

</code></pre></div><h3 id="heading7">アニメーション結果</h3>
<p>一応トレーニング関数まで到達したので、具体的な実行方法などは一番最後に載せたレポジトリを見てもらうこととして、とりあえずアニメーションの結果を見せたいと思います。
公式実装のアニメーションで使われている画像を強引に 64x64 にリサイズしたものを使いました。
<figure>
    <img src="/images/posts/fluxjl-singan_lightning_original.png"/> 
</figure>
</p>
<p>無理やり 256x256 に引き伸ばすとこんな感じです。
<figure>
    <img src="/images/posts/fluxjl-singan_lightning_original.png" width="256"/> 
</figure>
</p>
<p>25x25 のサイズからスタートして、64x64 で終了させたのですが、GCP の n1-standard-8 + K80 で一時間弱で学習が終わりました。
今回は Julia サイドで画像だけ吐き出して、アニメーション GIF は ImageMagick で作成しました。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ convert -delay <span style="color:#ae81ff">10</span> -loop <span style="color:#ae81ff">0</span> img*.png fluxjl-singan_lightning.gif
</code></pre></div><figure>
    <img src="/images/posts/fluxjl-singan_lightning.gif"/> 
</figure>

<p>実際の画像はかなり小さいので、256x256 に拡大するとこんな感じです。
もっと時間をかけて大きい画像まで学習すれば高精細な結果が得られると思います。
<figure>
    <img src="/images/posts/fluxjl-singan_lightning.gif" width="256"/> 
</figure>
</p>
<p>アルバムのジャケットをアニメーションさせた結果です。</p>
<figure>
    <img src="/images/posts/fluxjl-singan_floral.gif" width="256"/> 
</figure>

<figure>
    <img src="/images/posts/fluxjl-singan_farside.gif" width="256"/> 
</figure>

<p>まだまだ実装の改良の余地がありそうですが、一応一枚の画像だけを使ってアニメーション画像を作成するモデルを Flux.jl で実装できました。</p>
<p>詳細な部分も含めた全コードはこちらです。
<a href="https://github.com/matsueushi/SinGAN">matsueushi/SinGAN</a></p>

  <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-show-count="false">Tweet</a>
  <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
</div>
    
<footer class='entry-footer'>
  <div class='container sep-before'><div class='tags'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M20.59,13.41l-7.17,7.17a2,2,0,0,1-2.83,0L2,12V2H12l8.59,8.59A2,2,0,0,1,20.59,13.41Z"/>
  <line x1="7" y1="7" x2="7" y2="7"/>
  
</svg>
<span class='screen-reader-text'>Tags: </span><a class='tag' href='/tags/julia/'>Julia</a>, <a class='tag' href='/tags/deeplearning/'>DeepLearning</a>, <a class='tag' href='/tags/flux/'>Flux</a>, <a class='tag' href='/tags/singan/'>SinGAN</a>, <a class='tag' href='/tags/gan/'>GAN</a></div>

  </div>
</footer>


</article>
<div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "matsueushi-github-io" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

<nav class='entry-nav'>
  <div class='container'><div class='prev-entry sep-before'>
      <a href='/posts/fluxjl-dcgan/'>
        <span aria-hidden='true'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="20" y1="12" x2="4" y2="12"/>
  <polyline points="10 18 4 12 10 6"/>
  
</svg>
 Previous</span>
        <span class='screen-reader-text'>Previous post: </span>Flux.jl v0.10.0でDCGANを動かす(CUDA環境)</a>
    </div><div class='next-entry sep-before'>
      <a href='/posts/julia-rounding/'>
        <span class='screen-reader-text'>Next post: </span>Juliaで丸めモードを指定して浮動小数点数の計算をする(したい)<span aria-hidden='true'>Next <svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="4" y1="12" x2="20" y2="12"/>
  <polyline points="14 6 20 12 14 18"/>
  
</svg>
</span>
      </a>
    </div></div>
</nav>



      </main>

      <footer id='footer' class='footer'>
        <div class='container sep-before'><section class='widget widget-social_menu sep-after'><nav aria-label='Social Menu'>
    <ul><li>
        <a href='https://github.com/matsueushi' target='_blank' rel='noopener'>
          <span class='screen-reader-text'>Open Github account in new tab</span><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
  
</svg>
</a>
      </li><li>
        <a href='https://twitter.com/matsue_ushi' target='_blank' rel='noopener'>
          <span class='screen-reader-text'>Open Twitter account in new tab</span><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>
  
</svg>
</a>
      </li><li>
        <a href='mailto:matsueushi@gmail.com' target='_blank' rel='noopener'>
          <span class='screen-reader-text'>Contact via Email</span><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
  <polyline points="22,6 12,13 2,6"/>
  
</svg>
</a>
      </li></ul>
  </nav>
</section><div class='copyright'>
  <p> &copy; 2019-2020 matsueushi </p>
</div>

        </div>
      </footer>

    </div>
  </div><script>window.__assets_js_src="/assets/js/"</script>

<script src='/assets/js/main.67d669ac.js'></script><script src='/js/custom.js'></script><link rel='stylesheet' href='//cdn.jsdelivr.net/npm/katex@0.10.2/dist/katex.min.css'>
<script src='//cdn.jsdelivr.net/npm/katex@0.10.2/dist/katex.min.js'></script>
<script src='//cdn.jsdelivr.net/npm/katex@0.10.2/dist/contrib/auto-render.min.js'></script>

<script type='text/javascript'>
  renderMathInElement(document.querySelector('.entry-content'),{});
</script>

</body>

</html>
